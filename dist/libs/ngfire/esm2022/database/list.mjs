import { inject } from "@angular/core";
import { set } from "firebase/database";
import { push, get, remove, update } from "firebase/database";
import { combineLatest, of } from "rxjs";
import { map } from "rxjs/operators";
import { exist, isIdList, pathWithParams } from "ngfire/core";
import { FireDatabase } from "./database";
import { serverTimestamp } from 'firebase/database';
import { fromDate, toDate } from "./utils";
function isListQuery(query) {
    if (typeof query === 'string')
        return false;
    if (Array.isArray(query) && isIdList(query))
        return false;
    return true;
}
function toKey(value) {
    if (typeof value === 'string')
        return value;
    if (typeof value === 'number')
        return value.toString();
    throw new Error('Key of list should either be a string or a number');
}
export function addMeta(doc, actionType) {
    const _meta = doc['_meta'] ?? {};
    if (actionType === 'add')
        _meta.createdAt = serverTimestamp();
    if (actionType === 'update')
        _meta.modifiedAt = serverTimestamp();
    doc._meta = _meta;
}
export class FireList {
    constructor() {
        this.fireDB = inject(FireDatabase);
    }
    fromDatabase(snap) {
        if (!snap.exists())
            return null;
        const value = snap.val();
        const dateKeys = [...this.dateKeys, '_meta.createdAt', '_meta.modifiedAt'];
        if (!value || typeof value !== 'object')
            return toDate(value, dateKeys);
        if (this.idKey)
            value[this.idKey] = snap.key;
        if (this.pathKey)
            value[this.pathKey] = snap.ref.toString();
        return toDate(value, dateKeys);
    }
    toDatabase(doc, actionType) {
        return fromDate(doc);
    }
    toData(snaps, options) {
        if (!snaps)
            return null;
        if (Array.isArray(snaps))
            return snaps.map(snap => this.toData(snap, { isList: false })).filter(exist);
        if (!options.isList)
            return this.fromDatabase(snaps);
        const docs = [];
        // forEach cancels when return value is "true". So I return "false"
        snaps.forEach(snap => !docs.push(this.fromDatabase(snap)));
        return docs.filter(exist);
    }
    getPath(key, params) {
        if (typeof key === 'string')
            return pathWithParams(`${this.path}/${key}`, params);
        return pathWithParams(this.path, key);
    }
    getRef(query, params) {
        // String or Params (getPath return base path is query is Params)
        if (!Array.isArray(query))
            return this.fireDB.getRef(this.getPath(query), params);
        return isIdList(query)
            // key list
            ? this.fireDB.getRef(query.map(key => this.getPath(key)), params)
            // query constraints
            : this.fireDB.getRef(this.getPath(), query, params);
    }
    fromQuery(query, params) {
        const refs = this.getRef(query, params);
        if (!Array.isArray(refs))
            return this.fireDB.fromQuery(refs);
        const obs = refs.map(ref => this.fireDB.fromQuery(ref));
        return combineLatest(obs);
    }
    getQuery(query, params) {
        const refs = this.getRef(query, params);
        if (!Array.isArray(refs))
            return get(refs);
        const promises = refs.map(ref => get(ref));
        return Promise.all(promises);
    }
    valueChanges(query, params) {
        if (arguments.length && !query)
            return of(null);
        return this.fromQuery(query, params).pipe(map(snap => this.toData(snap, { isList: isListQuery(query) })));
    }
    async getValue(query, params) {
        if (arguments.length && !query)
            return Promise.resolve(null);
        const snap = await this.getQuery(query, params);
        return this.toData(snap, { isList: isListQuery(query) });
    }
    add(value, params) {
        const doc = this.toDatabase(value, 'add');
        if (this.idKey && doc[this.idKey]) {
            const key = toKey(doc[this.idKey]);
            const ref = this.getRef(key, params);
            return set(ref, doc);
        }
        const listRef = params ? this.getRef(params) : this.getRef();
        return push(listRef, doc);
    }
    update(key, value, params) {
        const doc = this.toDatabase(value, 'update');
        const path = this.getRef(key, params);
        return update(path, doc);
    }
    remove(key, params) {
        const ref = this.getRef(key, params);
        return remove(ref);
    }
    /** We use a separated method to avoid mistakes */
    removeAll(params) {
        const ref = params ? this.getRef(params) : this.getRef();
        return remove(ref);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmdmaXJlL2RhdGFiYXNlL3NyYy9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUEyRCxHQUFHLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRyxPQUFPLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUQsT0FBTyxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBMkIsS0FBSyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFNM0MsU0FBUyxXQUFXLENBQUMsS0FBc0Q7SUFDekUsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFDNUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUMxRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFHRCxTQUFTLEtBQUssQ0FBQyxLQUFjO0lBQzNCLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQzVDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sS0FBSyxDQUFD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QWU7UUFDdkIsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDekQsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IERhdGFiYXNlUmVmZXJlbmNlLCBEYXRhU25hcHNob3QsIFF1ZXJ5LCBRdWVyeUNvbnN0cmFpbnQsIHNldCB9IGZyb20gXCJmaXJlYmFzZS9kYXRhYmFzZVwiO1xuaW1wb3J0IHsgcHVzaCwgZ2V0LCByZW1vdmUsIHVwZGF0ZSB9IGZyb20gXCJmaXJlYmFzZS9kYXRhYmFzZVwiO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBFeHRyYWN0RGVlcEtleXMsIFBhcmFtcywgZXhpc3QsIGlzSWRMaXN0LCBwYXRoV2l0aFBhcmFtcyB9IGZyb20gXCJuZ2ZpcmUvY29yZVwiO1xuaW1wb3J0IHsgRmlyZURhdGFiYXNlIH0gZnJvbSBcIi4vZGF0YWJhc2VcIjtcbmltcG9ydCB7IHNlcnZlclRpbWVzdGFtcCB9IGZyb20gJ2ZpcmViYXNlL2RhdGFiYXNlJztcbmltcG9ydCB7IGZyb21EYXRlLCB0b0RhdGUgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5pbnRlcmZhY2UgVG9EYXRhT3B0aW9ucyB7XG4gIGlzTGlzdDogYm9vbGVhbjtcbn1cblxuZnVuY3Rpb24gaXNMaXN0UXVlcnkocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zKSB7XG4gIGlmICh0eXBlb2YgcXVlcnkgPT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2U7XG4gIGlmIChBcnJheS5pc0FycmF5KHF1ZXJ5KSAmJiBpc0lkTGlzdChxdWVyeSkpIHJldHVybiBmYWxzZTtcbiAgcmV0dXJuIHRydWU7XG59XG5cblxuZnVuY3Rpb24gdG9LZXkodmFsdWU6IHVua25vd24pIHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHJldHVybiB2YWx1ZTtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHJldHVybiB2YWx1ZS50b1N0cmluZygpO1xuICB0aHJvdyBuZXcgRXJyb3IoJ0tleSBvZiBsaXN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgb3IgYSBudW1iZXInKTsgXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRNZXRhKGRvYzogRG9jdW1lbnRNZXRhLCBhY3Rpb25UeXBlOiAnYWRkJyB8ICd1cGRhdGUnKSB7XG4gIGNvbnN0IF9tZXRhOiBEb2N1bWVudE1ldGFbJ19tZXRhJ10gPSBkb2NbJ19tZXRhJ10gPz8ge307XG4gIGlmIChhY3Rpb25UeXBlID09PSAnYWRkJykgX21ldGEuY3JlYXRlZEF0ID0gc2VydmVyVGltZXN0YW1wKCkgYXMgRGF0ZTtcbiAgaWYgKGFjdGlvblR5cGUgPT09ICd1cGRhdGUnKSBfbWV0YS5tb2RpZmllZEF0ID0gc2VydmVyVGltZXN0YW1wKCkgYXMgRGF0ZTtcbiAgZG9jLl9tZXRhID0gX21ldGE7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnRNZXRhIHtcbiAgX21ldGE6IHtcbiAgICBjcmVhdGVkQXQ/OiBEYXRlO1xuICAgIG1vZGlmaWVkQXQ/OiBEYXRlO1xuICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBGaXJlTGlzdDxFPiB7XG4gIHByb3RlY3RlZCBmaXJlREIgPSBpbmplY3QoRmlyZURhdGFiYXNlKTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGRhdGVLZXlzOiBFeHRyYWN0RGVlcEtleXM8RSwgRGF0ZT5bXTtcbiAgcHJvdGVjdGVkIGlkS2V5Pzoga2V5b2YgRTtcbiAgcHJvdGVjdGVkIHBhdGhLZXk/OiBrZXlvZiBFO1xuXG4gIHByb3RlY3RlZCBmcm9tRGF0YWJhc2Uoc25hcDogRGF0YVNuYXBzaG90KTogRSB8IG51bGwge1xuICAgIGlmICghc25hcC5leGlzdHMoKSkgcmV0dXJuIG51bGw7XG4gICAgY29uc3QgdmFsdWUgPSBzbmFwLnZhbCgpO1xuICAgIFxuICAgIGNvbnN0IGRhdGVLZXlzID0gWy4uLnRoaXMuZGF0ZUtleXMsICdfbWV0YS5jcmVhdGVkQXQnLCAnX21ldGEubW9kaWZpZWRBdCddO1xuICAgIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JykgcmV0dXJuIHRvRGF0ZSh2YWx1ZSwgZGF0ZUtleXMpO1xuICAgIGlmICh0aGlzLmlkS2V5KSB2YWx1ZVt0aGlzLmlkS2V5XSA9IHNuYXAua2V5O1xuICAgIGlmICh0aGlzLnBhdGhLZXkpIHZhbHVlW3RoaXMucGF0aEtleV0gPSBzbmFwLnJlZi50b1N0cmluZygpO1xuICAgIHJldHVybiB0b0RhdGUodmFsdWUsIGRhdGVLZXlzKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB0b0RhdGFiYXNlKGRvYzogUGFydGlhbDxFPiwgYWN0aW9uVHlwZTogJ2FkZCcgfCAndXBkYXRlJykge1xuICAgIHJldHVybiBmcm9tRGF0ZShkb2MpOyBcbiAgfVxuXG4gIHByaXZhdGUgdG9EYXRhPFQgZXh0ZW5kcyBFID0gRT4oc25hcHM6IERhdGFTbmFwc2hvdCB8IG51bGwsIG9wdGlvbnM6IFRvRGF0YU9wdGlvbnMpOiBUIHwgbnVsbFxuICBwcml2YXRlIHRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXBzOiBEYXRhU25hcHNob3RbXSwgb3B0aW9uczogVG9EYXRhT3B0aW9ucyk6IFRbXVxuICBwcml2YXRlIHRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXBzOiBEYXRhU25hcHNob3QgfCBEYXRhU25hcHNob3RbXSB8IG51bGwsIG9wdGlvbnM6IFRvRGF0YU9wdGlvbnMpOiBUIHwgVFtdIHwgbnVsbFxuICBwcml2YXRlIHRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXBzOiBEYXRhU25hcHNob3QgfCBEYXRhU25hcHNob3RbXSB8IG51bGwsIG9wdGlvbnM6IFRvRGF0YU9wdGlvbnMpOiBUIHwgVFtdIHwgbnVsbCB7XG4gICAgaWYgKCFzbmFwcykgcmV0dXJuIG51bGw7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoc25hcHMpKSByZXR1cm4gc25hcHMubWFwKHNuYXAgPT4gdGhpcy50b0RhdGE8VD4oc25hcCwgeyBpc0xpc3Q6IGZhbHNlIH0pKS5maWx0ZXIoZXhpc3QpO1xuICAgIGlmICghb3B0aW9ucy5pc0xpc3QpIHJldHVybiB0aGlzLmZyb21EYXRhYmFzZShzbmFwcykgYXMgYW55O1xuICAgIGNvbnN0IGRvY3M6IChUIHwgbnVsbClbXSA9IFtdO1xuICAgIC8vIGZvckVhY2ggY2FuY2VscyB3aGVuIHJldHVybiB2YWx1ZSBpcyBcInRydWVcIi4gU28gSSByZXR1cm4gXCJmYWxzZVwiXG4gICAgc25hcHMuZm9yRWFjaChzbmFwID0+ICFkb2NzLnB1c2godGhpcy5mcm9tRGF0YWJhc2Uoc25hcCkgYXMgYW55KSk7XG4gICAgcmV0dXJuIGRvY3MuZmlsdGVyKGV4aXN0KTtcbiAgfVxuXG4gIGdldFBhdGgoa2V5Pzogc3RyaW5nIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpIHtcbiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIHJldHVybiBwYXRoV2l0aFBhcmFtcyhgJHt0aGlzLnBhdGh9LyR7a2V5fWAsIHBhcmFtcyk7XG4gICAgcmV0dXJuIHBhdGhXaXRoUGFyYW1zKHRoaXMucGF0aCwga2V5KTtcbiAgfVxuXG4gIGdldFJlZigpOiBEYXRhYmFzZVJlZmVyZW5jZVxuICBnZXRSZWYocGFyYW1zOiBQYXJhbXMpOiBEYXRhYmFzZVJlZmVyZW5jZVxuICBnZXRSZWYoa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IERhdGFiYXNlUmVmZXJlbmNlXG4gIGdldFJlZihrZXlzOiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogRGF0YWJhc2VSZWZlcmVuY2VbXVxuICBnZXRSZWYoY29uc3RyYWludHM6IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBRdWVyeVxuICAvLyBVc2UgaW50ZXJuYWxseVxuICBnZXRSZWYocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBEYXRhYmFzZVJlZmVyZW5jZSB8IERhdGFiYXNlUmVmZXJlbmNlW10gfCBRdWVyeVxuICBnZXRSZWYocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpIHtcbiAgICAvLyBTdHJpbmcgb3IgUGFyYW1zIChnZXRQYXRoIHJldHVybiBiYXNlIHBhdGggaXMgcXVlcnkgaXMgUGFyYW1zKVxuICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVyeSkpIHJldHVybiB0aGlzLmZpcmVEQi5nZXRSZWYodGhpcy5nZXRQYXRoKHF1ZXJ5KSwgcGFyYW1zKTtcbiAgICBcbiAgICByZXR1cm4gaXNJZExpc3QocXVlcnkpXG4gICAgICAvLyBrZXkgbGlzdFxuICAgICAgPyB0aGlzLmZpcmVEQi5nZXRSZWYocXVlcnkubWFwKGtleSA9PiB0aGlzLmdldFBhdGgoa2V5KSksIHBhcmFtcylcbiAgICAgIC8vIHF1ZXJ5IGNvbnN0cmFpbnRzXG4gICAgICA6IHRoaXMuZmlyZURCLmdldFJlZih0aGlzLmdldFBhdGgoKSwgcXVlcnksIHBhcmFtcyk7XG4gIH1cblxuICBwcml2YXRlIGZyb21RdWVyeSgpOiBPYnNlcnZhYmxlPERhdGFTbmFwc2hvdD5cbiAgcHJpdmF0ZSBmcm9tUXVlcnkocGFyYW1zOiBQYXJhbXMpOiBPYnNlcnZhYmxlPERhdGFTbmFwc2hvdD5cbiAgcHJpdmF0ZSBmcm9tUXVlcnkoa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90PiB8IE9ic2VydmFibGU8bnVsbD5cbiAgcHJpdmF0ZSBmcm9tUXVlcnkoa2V5czogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90W10+XG4gIHByaXZhdGUgZnJvbVF1ZXJ5KGNvbnN0cmFpbnRzOiBRdWVyeUNvbnN0cmFpbnRbXSwgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxEYXRhU25hcHNob3RbXT5cbiAgLy8gVXNlIGludGVybmFsbHlcbiAgcHJpdmF0ZSBmcm9tUXVlcnkocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbD5cbiAgcHJpdmF0ZSBmcm9tUXVlcnkocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbD4ge1xuICAgIGNvbnN0IHJlZnMgPSB0aGlzLmdldFJlZihxdWVyeSwgcGFyYW1zKTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVmcykpIHJldHVybiB0aGlzLmZpcmVEQi5mcm9tUXVlcnkocmVmcyk7XG4gICAgY29uc3Qgb2JzID0gcmVmcy5tYXAocmVmID0+IHRoaXMuZmlyZURCLmZyb21RdWVyeShyZWYpKTtcbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChvYnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRRdWVyeSgpOiBQcm9taXNlPERhdGFTbmFwc2hvdD5cbiAgcHJpdmF0ZSBnZXRRdWVyeShwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8RGF0YVNuYXBzaG90PlxuICBwcml2YXRlIGdldFF1ZXJ5KGtleTogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPERhdGFTbmFwc2hvdD4gfCBQcm9taXNlPG51bGw+XG4gIHByaXZhdGUgZ2V0UXVlcnkoa2V5czogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8RGF0YVNuYXBzaG90W10+XG4gIHByaXZhdGUgZ2V0UXVlcnkoY29uc3RyYWludHM6IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPERhdGFTbmFwc2hvdFtdPlxuICAvLyBVc2UgaW50ZXJuYWxseVxuICBwcml2YXRlIGdldFF1ZXJ5KHF1ZXJ5Pzogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcywgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxEYXRhU25hcHNob3QgfCBEYXRhU25hcHNob3RbXSB8IG51bGw+XG4gIHByaXZhdGUgZ2V0UXVlcnkocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbD4ge1xuICAgIGNvbnN0IHJlZnMgPSB0aGlzLmdldFJlZihxdWVyeSwgcGFyYW1zKTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVmcykpIHJldHVybiBnZXQocmVmcyk7XG4gICAgY29uc3QgcHJvbWlzZXMgPSByZWZzLm1hcChyZWYgPT4gZ2V0KHJlZikpO1xuICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gIH1cblxuICB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPigpOiBPYnNlcnZhYmxlPFRbXT5cbiAgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4ocGFyYW1zOiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT5cbiAgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8VCB8IG51bGw+XG4gIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KGtleXM6IHN0cmluZ1tdLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT5cbiAgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oY29uc3RyYWludHM6IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT5cbiAgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4ocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFQgfCBUW10gfCBudWxsPiB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggJiYgIXF1ZXJ5KSByZXR1cm4gb2YobnVsbCk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVF1ZXJ5KHF1ZXJ5LCBwYXJhbXMpLnBpcGUoXG4gICAgICBtYXAoc25hcCA9PiB0aGlzLnRvRGF0YShzbmFwLCB7IGlzTGlzdDogaXNMaXN0UXVlcnkocXVlcnkpIH0pKSxcbiAgICApO1xuICB9XG5cbiAgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPigpOiBQcm9taXNlPFRbXT5cbiAgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8VFtdPlxuICBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KGtleTogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFQgfCBudWxsPlxuICBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KGtleXM6IHN0cmluZ1tdLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFRbXT5cbiAgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihjb25zdHJhaW50czogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPlxuICBhc3luYyBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5Pzogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcywgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUIHwgVFtdIHwgbnVsbD4ge1xuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICYmICFxdWVyeSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICBjb25zdCBzbmFwID0gYXdhaXQgdGhpcy5nZXRRdWVyeShxdWVyeSwgcGFyYW1zKVxuICAgIHJldHVybiB0aGlzLnRvRGF0YTxUPihzbmFwLCB7IGlzTGlzdDogaXNMaXN0UXVlcnkocXVlcnkpIH0pO1xuICB9XG5cbiAgYWRkPFQgZXh0ZW5kcyBFPih2YWx1ZTogUGFydGlhbDxUPiwgcGFyYW1zPzogUGFyYW1zKSB7XG4gICAgY29uc3QgZG9jID0gdGhpcy50b0RhdGFiYXNlKHZhbHVlLCAnYWRkJyk7XG4gICAgaWYgKHRoaXMuaWRLZXkgJiYgZG9jW3RoaXMuaWRLZXldKSB7XG4gICAgICBjb25zdCBrZXkgPSB0b0tleShkb2NbdGhpcy5pZEtleV0pO1xuICAgICAgY29uc3QgcmVmID0gdGhpcy5nZXRSZWYoa2V5LCBwYXJhbXMpO1xuICAgICAgcmV0dXJuIHNldChyZWYsIGRvYyk7XG4gICAgfVxuICAgIGNvbnN0IGxpc3RSZWYgPSBwYXJhbXMgPyB0aGlzLmdldFJlZihwYXJhbXMpIDogdGhpcy5nZXRSZWYoKTtcbiAgICByZXR1cm4gcHVzaChsaXN0UmVmLCBkb2MpO1xuICB9XG5cbiAgdXBkYXRlPFQgZXh0ZW5kcyBFPihrZXk6IHN0cmluZywgdmFsdWU6IFBhcnRpYWw8VD4sIHBhcmFtcz86IFBhcmFtcykge1xuICAgIGNvbnN0IGRvYyA9IHRoaXMudG9EYXRhYmFzZSh2YWx1ZSwgJ3VwZGF0ZScpO1xuICAgIGNvbnN0IHBhdGggPSB0aGlzLmdldFJlZihrZXksIHBhcmFtcyk7XG4gICAgcmV0dXJuIHVwZGF0ZShwYXRoLCBkb2MpO1xuICB9XG5cbiAgcmVtb3ZlKGtleTogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpIHtcbiAgICBjb25zdCByZWYgPSB0aGlzLmdldFJlZihrZXksIHBhcmFtcyk7XG4gICAgcmV0dXJuIHJlbW92ZShyZWYpO1xuICB9XG5cbiAgLyoqIFdlIHVzZSBhIHNlcGFyYXRlZCBtZXRob2QgdG8gYXZvaWQgbWlzdGFrZXMgKi9cbiAgcmVtb3ZlQWxsKHBhcmFtcz86IFBhcmFtcykge1xuICAgIGNvbnN0IHJlZiA9IHBhcmFtcyA/IHRoaXMuZ2V0UmVmKHBhcmFtcykgOiB0aGlzLmdldFJlZigpO1xuICAgIHJldHVybiByZW1vdmUocmVmKTtcbiAgfVxufSJdfQ==
import { combineLatest, Observable, of, from, ReplaySubject, timer, } from 'rxjs';
import { debounceTime, map, startWith, switchMap, tap, share } from 'rxjs/operators';
export function shareWithDelay(delay = 100) {
    return share({
        connector: () => new ReplaySubject(1),
        resetOnRefCountZero: () => delay ? timer(delay) : of(true),
        resetOnError: true,
        resetOnComplete: false,
    });
}
/**
 * Operator that join the source with sub queries.
 * There are two stategies :
 * 1. `shouldAwait: true`: Await all subqueries to emit once before emitting a next value
 * 2. `shouldAwait: false`: Emit the source and hydrate it with the subqueries along the way
 * @example
 * ```typescript
 * of({ docUrl: '...' }).valueChanges().pipe(
 *   joinWith({
 *     doc: source => fetch(docUrl).then(res => res.json()),
 *   }, { shouldAwait: true })
 * ).subscribe(res => console.log(res.subQuery))
 * ```
 * @param queries A map of subqueries to apply. Each query can return a static value, Promise or Observable
 * @param options Strategy to apply on the joinWith
 */
export function joinWith(queries, options = {}) {
    const shouldAwait = options.shouldAwait ?? true;
    const debounce = options.debounceTime ?? 100;
    const runQuery = (entity) => {
        const obs = [];
        for (const key in queries) {
            // Transform return value into an observable
            let result = queries[key](entity);
            if (!(result instanceof Observable)) {
                if (result instanceof Promise) {
                    result = from(result);
                }
                else {
                    result = of(result);
                }
            }
            // Hydrate the entity with the data
            let observe;
            if (shouldAwait) {
                observe = result.pipe(tap(result => entity[key] = result));
            }
            else {
                observe = result.pipe(startWith(undefined), tap(result => entity[key] = result));
            }
            obs.push(observe);
        }
        if (!obs.length)
            return of(entity);
        return combineLatest(obs).pipe(map(() => {
            if (!entity)
                return entity;
            return JSON.parse(JSON.stringify(entity), jsonDateReviver);
        }));
    };
    return switchMap((data) => {
        if (Array.isArray(data)) {
            if (!data.length)
                return of([]);
            return combineLatest(data.map(runQuery)).pipe(debounceTime(debounce));
        }
        return runQuery(data);
    });
}
function jsonDateReviver(_, value) {
    if (!value)
        return value;
    const dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,}|)Z$/;
    if (typeof value === 'string' && dateFormat.test(value))
        return new Date(value);
    if (typeof value === 'object' &&
        Object.keys(value).length === 2 &&
        ['nanoseconds', 'seconds'].every((k) => k in value))
        return new Date(((value.nanoseconds * 1) ^ -6) + value.seconds * 1000);
    return value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BlcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ2ZpcmUvY29yZS9zcmMvb3BlcmF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxhQUFhLEVBQ2IsVUFBVSxFQUVWLEVBQUUsRUFDRixJQUFJLEVBQ0osYUFBYSxFQUNiLEtBQUssR0FDTixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JGLE1BQU0sVUFBVSxjQUFjLENBQUksUUFBZ0IsR0FBRztJQUNuRCxPQUFPLEtBQUssQ0FBSTtRQUNkLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDckMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFDMUQsWUFBWSxFQUFFLElBQUk7UUFDbEIsZUFBZSxFQUFFLEtBQUs7S0FDdkIsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQXFCRDs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFDSCxNQUFNLFVBQVUsUUFBUSxDQUErQixPQUFjLEVBQUUsVUFBMkIsRUFBRTtJQUNsRyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztJQUNoRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsWUFBWSxJQUFJLEdBQUcsQ0FBQztJQUM3QyxNQUFNLFFBQVEsR0FBRyxDQUFDLE1BQWlCLEVBQUUsRUFBRTtRQUNyQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixLQUFLLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQzFC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LENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRXpFLE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIE9ic2VydmFibGUsXG4gIE9wZXJhdG9yRnVuY3Rpb24sXG4gIG9mLFxuICBmcm9tLFxuICBSZXBsYXlTdWJqZWN0LFxuICB0aW1lcixcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIG1hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRhcCwgc2hhcmUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHNoYXJlV2l0aERlbGF5PFQ+KGRlbGF5OiBudW1iZXIgPSAxMDApIHtcbiAgcmV0dXJuIHNoYXJlPFQ+KHtcbiAgICBjb25uZWN0b3I6ICgpID0+IG5ldyBSZXBsYXlTdWJqZWN0KDEpLFxuICAgIHJlc2V0T25SZWZDb3VudFplcm86ICgpID0+IGRlbGF5ID8gdGltZXIoZGVsYXkpIDogb2YodHJ1ZSksXG4gICAgcmVzZXRPbkVycm9yOiB0cnVlLFxuICAgIHJlc2V0T25Db21wbGV0ZTogZmFsc2UsXG4gIH0pXG59XG5cblxudHlwZSBRdWVyeU1hcDxUPiA9IFJlY29yZDxzdHJpbmcsIChkYXRhOiBFbnRpdHk8VD4pID0+IGFueT5cbnR5cGUgRW50aXR5PFQ+ID0gVCBleHRlbmRzIEFycmF5PGluZmVyIEk+ID8gSSA6IFQ7XG50eXBlIEdldFNuYXBzaG90PEYgZXh0ZW5kcyAoLi4uZGF0YTogYW55KSA9PiBhbnk+ID0gXG4gIEYgZXh0ZW5kcyAoLi4uZGF0YTogYW55KSA9PiBPYnNlcnZhYmxlPGluZmVyIEk+ID8gSVxuICA6IEYgZXh0ZW5kcyAoLi4uZGF0YTogYW55KSA9PiBQcm9taXNlPGluZmVyIEo+ID8gSlxuICA6IFJldHVyblR5cGU8Rj47XG50eXBlIEpvaW48VCwgUXVlcnkgZXh0ZW5kcyBRdWVyeU1hcDxUPj4gPSBUICYgeyBba2V5IGluIGtleW9mIFF1ZXJ5XT86IEdldFNuYXBzaG90PFF1ZXJ5W2tleV0+IH07XG50eXBlIEpvaW50dXJlPFQsIFF1ZXJ5IGV4dGVuZHMgUXVlcnlNYXA8YW55Pj4gPSBUIGV4dGVuZHMgQXJyYXk8aW5mZXIgST5cbiAgPyBKb2luPEksIFF1ZXJ5PltdXG4gIDogSm9pbjxULCBRdWVyeT47XG5cbmludGVyZmFjZSBKb2luV2l0aE9wdGlvbnMge1xuICAvKiogSWYgc2V0IHRvIGZhbHNlLCB0aGUgc3VicXVlcmllcyB3aWxsIGJlIGZpbGxlZCB3aXRoIHVuZGVmaW5lZCBhbmQgaHlkcmF0ZWQgYXMgdGhleSBjb21lIHRocm91Z2ggKi9cbiAgc2hvdWxkQXdhaXQ/OiBib29sZWFuO1xuICAvKiogVXNlZCB0byBub3QgdHJpZ2dlciBjaGFuZ2UgZGV0ZWN0aW9uIHRvbyBvZnRlbiAqL1xuICBkZWJvdW5jZVRpbWU/OiBudW1iZXI7XG59XG5cbi8qKlxuICogT3BlcmF0b3IgdGhhdCBqb2luIHRoZSBzb3VyY2Ugd2l0aCBzdWIgcXVlcmllcy5cbiAqIFRoZXJlIGFyZSB0d28gc3RhdGVnaWVzIDogXG4gKiAxLiBgc2hvdWxkQXdhaXQ6IHRydWVgOiBBd2FpdCBhbGwgc3VicXVlcmllcyB0byBlbWl0IG9uY2UgYmVmb3JlIGVtaXR0aW5nIGEgbmV4dCB2YWx1ZVxuICogMi4gYHNob3VsZEF3YWl0OiBmYWxzZWA6IEVtaXQgdGhlIHNvdXJjZSBhbmQgaHlkcmF0ZSBpdCB3aXRoIHRoZSBzdWJxdWVyaWVzIGFsb25nIHRoZSB3YXlcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBvZih7IGRvY1VybDogJy4uLicgfSkudmFsdWVDaGFuZ2VzKCkucGlwZShcbiAqICAgam9pbldpdGgoe1xuICogICAgIGRvYzogc291cmNlID0+IGZldGNoKGRvY1VybCkudGhlbihyZXMgPT4gcmVzLmpzb24oKSksXG4gKiAgIH0sIHsgc2hvdWxkQXdhaXQ6IHRydWUgfSlcbiAqICkuc3Vic2NyaWJlKHJlcyA9PiBjb25zb2xlLmxvZyhyZXMuc3ViUXVlcnkpKVxuICogYGBgXG4gKiBAcGFyYW0gcXVlcmllcyBBIG1hcCBvZiBzdWJxdWVyaWVzIHRvIGFwcGx5LiBFYWNoIHF1ZXJ5IGNhbiByZXR1cm4gYSBzdGF0aWMgdmFsdWUsIFByb21pc2Ugb3IgT2JzZXJ2YWJsZVxuICogQHBhcmFtIG9wdGlvbnMgU3RyYXRlZ3kgdG8gYXBwbHkgb24gdGhlIGpvaW5XaXRoXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBqb2luV2l0aDxULCBRdWVyeSBleHRlbmRzIFF1ZXJ5TWFwPFQ+PihxdWVyaWVzOiBRdWVyeSwgb3B0aW9uczogSm9pbldpdGhPcHRpb25zID0ge30pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEpvaW50dXJlPFQsIFF1ZXJ5Pj4ge1xuICBjb25zdCBzaG91bGRBd2FpdCA9IG9wdGlvbnMuc2hvdWxkQXdhaXQgPz8gdHJ1ZTtcbiAgY29uc3QgZGVib3VuY2UgPSBvcHRpb25zLmRlYm91bmNlVGltZSA/PyAxMDA7XG4gIGNvbnN0IHJ1blF1ZXJ5ID0gKGVudGl0eTogRW50aXR5PFQ+KSA9PiB7XG4gICAgY29uc3Qgb2JzID0gW107XG4gICAgZm9yIChjb25zdCBrZXkgaW4gcXVlcmllcykge1xuICAgICAgLy8gVHJhbnNmb3JtIHJldHVybiB2YWx1ZSBpbnRvIGFuIG9ic2VydmFibGVcbiAgICAgIGxldCByZXN1bHQ6IGFueSA9IHF1ZXJpZXNba2V5XShlbnRpdHkpO1xuICAgICAgaWYgKCEocmVzdWx0IGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkpIHtcbiAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICByZXN1bHQgPSBmcm9tKHJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0ID0gb2YocmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gSHlkcmF0ZSB0aGUgZW50aXR5IHdpdGggdGhlIGRhdGFcbiAgICAgIGxldCBvYnNlcnZlOiBPYnNlcnZhYmxlPGFueT47XG4gICAgICBpZiAoc2hvdWxkQXdhaXQpIHtcbiAgICAgICAgb2JzZXJ2ZSA9IHJlc3VsdC5waXBlKFxuICAgICAgICAgIHRhcChyZXN1bHQgPT4gKGVudGl0eSBhcyBhbnkpW2tleV0gPSByZXN1bHQpLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JzZXJ2ZSA9IHJlc3VsdC5waXBlKFxuICAgICAgICAgIHN0YXJ0V2l0aCh1bmRlZmluZWQpLFxuICAgICAgICAgIHRhcChyZXN1bHQgPT4gKGVudGl0eSBhcyBhbnkpW2tleV0gPSByZXN1bHQpLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgb2JzLnB1c2gob2JzZXJ2ZSk7XG4gICAgfVxuICAgIGlmICghb2JzLmxlbmd0aCkgcmV0dXJuIG9mKGVudGl0eSk7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3Qob2JzKS5waXBlKFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgaWYgKCFlbnRpdHkpIHJldHVybiBlbnRpdHk7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGVudGl0eSksIGpzb25EYXRlUmV2aXZlcikgYXMgYW55O1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBzd2l0Y2hNYXAoKGRhdGE6IFQpID0+IHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgaWYgKCFkYXRhLmxlbmd0aCkgcmV0dXJuIG9mKFtdKTtcbiAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KGRhdGEubWFwKHJ1blF1ZXJ5KSkucGlwZShkZWJvdW5jZVRpbWUoZGVib3VuY2UpKTtcbiAgICB9XG4gICAgcmV0dXJuIHJ1blF1ZXJ5KGRhdGEgYXMgRW50aXR5PFQ+KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGpzb25EYXRlUmV2aXZlcihfOiB1bmtub3duLCB2YWx1ZTogYW55KSB7XG4gIGlmICghdmFsdWUpIHJldHVybiB2YWx1ZTtcblxuICBjb25zdCBkYXRlRm9ybWF0ID0gL15cXGR7NH0tXFxkezJ9LVxcZHsyfVRcXGR7Mn06XFxkezJ9OlxcZHsyfShcXC5cXGR7MSx9fClaJC87XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIGRhdGVGb3JtYXQudGVzdCh2YWx1ZSkpIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7XG4gIGlmIChcbiAgICB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmXG4gICAgT2JqZWN0LmtleXModmFsdWUpLmxlbmd0aCA9PT0gMiAmJlxuICAgIFsnbmFub3NlY29uZHMnLCAnc2Vjb25kcyddLmV2ZXJ5KChrKSA9PiBrIGluIHZhbHVlKVxuICApXG4gICAgcmV0dXJuIG5ldyBEYXRlKCgodmFsdWUubmFub3NlY29uZHMgKiAxKSBeIC02KSArIHZhbHVlLnNlY29uZHMgKiAxMDAwKTtcblxuICByZXR1cm4gdmFsdWU7XG59XG4iXX0=
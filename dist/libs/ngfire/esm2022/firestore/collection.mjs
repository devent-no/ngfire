/* eslint-disable @typescript-eslint/no-non-null-assertion */
import { inject, NgZone, PLATFORM_ID } from '@angular/core';
import { writeBatch, runTransaction, doc, collection, getDocs, getDoc, Transaction, DocumentSnapshot } from 'firebase/firestore';
import { fromRef } from './operators';
import { keepUnstableUntilFirst, isIdList, isNotUndefined, isPathRef, isQuery, pathWithParams } from 'ngfire/core';
import { of, combineLatest, firstValueFrom } from 'rxjs';
import { map, tap, startWith } from 'rxjs/operators';
import { isPlatformServer } from '@angular/common';
import { FirestoreService } from './firestore';
import { toDate, getDocPath } from './utils';
/////////////
// SERVICE //
/////////////
export class FireCollection {
    constructor() {
        this.platformId = inject(PLATFORM_ID);
        this.zone = inject(NgZone);
        this.firestore = inject(FirestoreService);
        this.idKey = 'id';
        /** If true, will store the document id (IdKey) onto the document */
        this.storeId = false;
        /**
         * Cache the snapshot into a global store
         */
        this.memorize = false;
        /**
         * Delay before unsubscribing to a query (used only with memorized is true)
         * Use Infinty for application long subscription
         */
        this.delayToUnsubscribe = 0;
    }
    get db() {
        return this.firestore.db;
    }
    useCache(ref) {
        if (isPlatformServer(this.platformId)) {
            return this.zone.runOutsideAngular(() => fromRef(ref)).pipe(map(snap => this.snapToData(snap)), tap(value => this.firestore.setTransfer(ref, value)), keepUnstableUntilFirst(this.zone));
        }
        if (!this.memorize) {
            return this.zone.runOutsideAngular(() => fromRef(ref)).pipe(map(snap => this.snapToData(snap)), keepUnstableUntilFirst(this.zone));
        }
        const transfer = this.firestore.getTransfer(ref);
        const initial = this.firestore.getState(ref);
        const snap$ = this.zone.runOutsideAngular(() => this.firestore.fromMemory(ref, this.delayToUnsubscribe)).pipe(tap(snap => this.firestore.setState(ref, snap)), keepUnstableUntilFirst(this.zone));
        if (transfer)
            return snap$.pipe(map(snap => this.snapToData(snap)), startWith(transfer));
        if (initial)
            return snap$.pipe(startWith(initial), map(snap => this.snapToData(snap)));
        return snap$.pipe(map(snap => this.snapToData(snap)));
    }
    clearCache(refs) {
        if (Array.isArray(refs))
            return this.firestore.clearCache(refs.map(ref => ref.path));
        if (isQuery(refs))
            return this.firestore.clearCache(refs);
        return this.firestore.clearCache(refs?.path);
    }
    /** Function triggered when adding/updating data to firestore */
    toFirestore(entity, actionType) {
        if (actionType === 'add') {
            const _meta = { createdAt: new Date(), modifiedAt: new Date() };
            return { _meta, ...entity };
        }
        else {
            return { ...entity, '_meta.modifiedAt': new Date() };
        }
    }
    /** Function triggered when getting data from firestore */
    fromFirestore(snapshot) {
        if (snapshot.exists()) {
            return { ...toDate(snapshot.data()), [this.idKey]: snapshot.id };
        }
        else {
            return undefined;
        }
    }
    batch() {
        return writeBatch(this.db);
    }
    runTransaction(cb) {
        return runTransaction(this.db, (tx) => cb(tx));
    }
    createId() {
        return doc(collection(this.db, '__')).id;
    }
    snapToData(snap) {
        if (snap instanceof DocumentSnapshot)
            return this.fromFirestore(snap);
        const snaps = Array.isArray(snap) ? snap : snap.docs;
        return snaps.map(s => this.snapToData(s)).filter(isNotUndefined);
    }
    async getFromRef(ref) {
        if (Array.isArray(ref))
            return Promise.all(ref.map(getDoc)).then(snaps => this.snapToData(snaps));
        const snap = (ref.type === 'document') ? await getDoc(ref) : await getDocs(ref);
        return this.snapToData(snap);
    }
    fromRef(ref) {
        if (Array.isArray(ref)) {
            if (!ref.length)
                return of([]);
            const queries = ref.map(r => this.useCache(r));
            return combineLatest(queries);
        }
        else {
            return this.useCache(ref);
        }
    }
    getRef(ids, parameters) {
        // Collection
        if (!arguments.length)
            return this.firestore.getRef(this.path);
        // Id is undefined or null
        if (!ids)
            return undefined;
        if (Array.isArray(ids)) {
            // List of ref
            if (ids.every(isPathRef))
                return this.firestore.getRef(ids);
            const path = pathWithParams(this.path, parameters);
            // List of ids
            if (isIdList(ids))
                return this.firestore.getRef(ids.map((id) => getDocPath(path, id)));
            // List of constraints
            return this.firestore.getRef(path, ids);
        }
        if (typeof ids === 'string') {
            // Ref
            if (isPathRef(ids))
                return this.firestore.getRef(ids);
            // Id
            const path = pathWithParams(this.path, parameters);
            return this.firestore.getRef(getDocPath(path, ids));
        }
        // Subcollection
        return this.firestore.getRef(pathWithParams(this.path, ids));
    }
    async reload() {
        if (!this.memorize)
            return;
        const ref = this.getRef(...arguments);
        if (!ref)
            return;
        this.clearCache(ref);
        return this.load(...arguments);
    }
    async load() {
        return firstValueFrom(this.valueChanges(...arguments));
    }
    async getValue() {
        const ref = this.getRef(...arguments);
        if (!ref)
            return;
        return this.getFromRef(ref);
    }
    valueChanges(idOrQuery) {
        if (Array.isArray(idOrQuery) && !idOrQuery.length)
            return of([]);
        const ref = this.getRef(...arguments);
        if (!ref)
            return of(undefined);
        return this.fromRef(ref);
    }
    async upsert(documents, options = {}) {
        const doesExist = async (doc) => {
            const id = doc[this.idKey];
            if (typeof id !== 'string')
                return false;
            const ref = this.getRef(id, options.params);
            const snap = (options.write instanceof Transaction)
                ? await options.write?.get(ref)
                : await getDoc(ref);
            return snap.exists();
        };
        const upsert = async (doc) => {
            const exists = await doesExist(doc);
            if (!exists)
                return this.add(doc, options);
            await this.update(doc, options);
            return doc[this.idKey];
        };
        return Array.isArray(documents)
            ? Promise.all(documents.map(upsert))
            : upsert(documents);
    }
    async add(documents, options = {}) {
        const docs = Array.isArray(documents) ? documents : [documents];
        const { write = this.batch(), ctx } = options;
        const operations = docs.map(async (value) => {
            const id = value[this.idKey] || this.createId();
            const data = await this.toFirestore(value, 'add');
            if (this.storeId)
                data[this.idKey] = id;
            const ref = this.getRef(id, options.params);
            write.set(ref, data);
            if (this.onCreate) {
                await this.onCreate(data, { write, ctx });
            }
            return id;
        });
        const ids = await Promise.all(operations);
        // If there is no atomic write provided
        if (!options.write) {
            await write.commit();
        }
        return Array.isArray(documents) ? ids : ids[0];
    }
    /**
     * Remove one or several document from Firestore
     * @param id A unique or list of id representing the document
     * @param options options to write the document on firestore
     */
    async remove(id, options = {}) {
        const { write = this.batch(), ctx } = options;
        const ids = Array.isArray(id) ? id : [id];
        const refs = [];
        const operations = ids.map(async (docId) => {
            const ref = this.getRef(docId, options.params);
            write.delete(ref);
            if (this.onDelete) {
                await this.onDelete(docId, { write, ctx });
            }
            refs.push(ref);
        });
        await Promise.all(operations);
        // If there is no atomic write provided
        if (!options.write) {
            await write.commit();
            if (this.memorize)
                this.clearCache(refs);
        }
    }
    /** Remove all document of the collection */
    async removeAll(options = {}) {
        const ref = options.params ? this.getRef(options.params) : this.getRef();
        const snapshot = await getDocs(ref);
        const ids = snapshot.docs.map((doc) => doc.id);
        await this.remove(ids, options);
        if (this.memorize)
            this.clearCache(ref);
    }
    async update(idsOrEntity, stateFnOrWrite, options = {}) {
        let ids = [];
        let stateFunction;
        let getData;
        const isEntity = (value) => {
            return typeof value === 'object' && value[this.idKey];
        };
        const isEntityArray = (values) => {
            return Array.isArray(values) && values.every((value) => isEntity(value));
        };
        if (isEntity(idsOrEntity)) {
            ids = [idsOrEntity[this.idKey]];
            getData = () => idsOrEntity;
            options = stateFnOrWrite || {};
        }
        else if (isEntityArray(idsOrEntity)) {
            const entityMap = new Map(idsOrEntity.map((entity) => [entity[this.idKey], entity]));
            ids = Array.from(entityMap.keys());
            getData = (docId) => entityMap.get(docId);
            options = stateFnOrWrite || {};
        }
        else if (typeof stateFnOrWrite === 'function') {
            ids = Array.isArray(idsOrEntity) ? idsOrEntity : [idsOrEntity];
            stateFunction = stateFnOrWrite;
        }
        else if (typeof stateFnOrWrite === 'object') {
            ids = Array.isArray(idsOrEntity) ? idsOrEntity : [idsOrEntity];
            getData = () => stateFnOrWrite;
        }
        else {
            throw new Error('Passed parameters match none of the function signatures.');
        }
        const { ctx } = options;
        if (!Array.isArray(ids) || !ids.length) {
            return;
        }
        // If update depends on the entity, use transaction
        if (stateFunction) {
            let refs = [];
            await runTransaction(this.db, async (tx) => {
                refs = [];
                const operations = ids.map(async (id) => {
                    const ref = this.getRef(id, options.params);
                    refs.push(ref);
                    const snapshot = await tx.get(ref);
                    const doc = this.fromFirestore(snapshot);
                    if (doc && stateFunction) {
                        const data = await stateFunction(doc, tx);
                        const result = await this.toFirestore(data, 'update');
                        tx.update(ref, result);
                        if (this.onUpdate) {
                            await this.onUpdate(data, { write: tx, ctx });
                        }
                    }
                    return tx;
                });
                return Promise.all(operations);
            });
            if (this.memorize)
                this.clearCache(refs);
        }
        else {
            const { write = this.batch() } = options;
            const refs = [];
            const operations = ids.map(async (docId) => {
                const doc = getData(docId);
                if (!docId) {
                    throw new Error(`Document should have an unique id to be updated, but none was found in ${doc}`);
                }
                const ref = this.getRef(docId, options.params);
                refs.push(ref);
                const data = await this.toFirestore(doc, 'update');
                write.update(ref, data);
                if (this.onUpdate) {
                    await this.onUpdate(doc, { write, ctx });
                }
            });
            await Promise.all(operations);
            // If there is no atomic write provided
            if (!options.write) {
                await write.commit();
                if (this.memorize)
                    this.clearCache(refs);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmdmaXJlL2ZpcmVzdG9yZS9zcmMvY29sbGVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw2REFBNkQ7QUFDN0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQVMsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQWMsTUFBTSxvQkFBb0IsQ0FBQztBQUVwSixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXRDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ25ILE9BQU8sRUFBYyxFQUFFLEVBQUUsYUFBYSxFQUFRLGNBQWMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRSxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFN0MsYUFBYTtBQUNiLGFBQWE7QUFDYixhQUFhO0FBRWIsTUFBTSxPQUFnQixjQUFjO0lBQXBDO1FBQ1ksZUFBVSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqQyxTQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RCLGNBQVMsR0FBRyxNQUFNLENBQUMsZ0JBQWdC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M0MsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzlCLHVDQUF1QztZQUN2QyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNuQixNQUFPLEtBQW9CLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3JDLElBQUksSUFBSSxDQUFDLFFBQVE7b0JBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUMxQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb24gKi9cbmltcG9ydCB7IGluamVjdCwgTmdab25lLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgd3JpdGVCYXRjaCwgcnVuVHJhbnNhY3Rpb24sIGRvYywgY29sbGVjdGlvbiwgUXVlcnksIGdldERvY3MsIGdldERvYywgVHJhbnNhY3Rpb24sIERvY3VtZW50U25hcHNob3QsIEZpZWxkVmFsdWUgfSBmcm9tICdmaXJlYmFzZS9maXJlc3RvcmUnO1xuaW1wb3J0IHR5cGUgeyBEb2N1bWVudERhdGEsIENvbGxlY3Rpb25SZWZlcmVuY2UsIERvY3VtZW50UmVmZXJlbmNlLCBRdWVyeUNvbnN0cmFpbnQsIFF1ZXJ5RG9jdW1lbnRTbmFwc2hvdCwgUXVlcnlTbmFwc2hvdCwgV3JpdGVCYXRjaCB9IGZyb20gJ2ZpcmViYXNlL2ZpcmVzdG9yZSc7XG5pbXBvcnQgeyBmcm9tUmVmIH0gZnJvbSAnLi9vcGVyYXRvcnMnO1xuaW1wb3J0IHR5cGUgeyBXcml0ZU9wdGlvbnMsIFVwZGF0ZUNhbGxiYWNrLCBNZXRhRG9jdW1lbnQsIFBhcmFtcywgRmlyZUVudGl0eSwgRGVlcEtleXMgfSBmcm9tICduZ2ZpcmUvY29yZSc7XG5pbXBvcnQgeyBrZWVwVW5zdGFibGVVbnRpbEZpcnN0LCBpc0lkTGlzdCwgaXNOb3RVbmRlZmluZWQsIGlzUGF0aFJlZiwgaXNRdWVyeSwgcGF0aFdpdGhQYXJhbXMgfSBmcm9tICduZ2ZpcmUvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgY29tYmluZUxhdGVzdCwgZnJvbSwgZmlyc3RWYWx1ZUZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFwLCBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgRmlyZXN0b3JlU2VydmljZSB9IGZyb20gJy4vZmlyZXN0b3JlJztcbmltcG9ydCB7IHRvRGF0ZSwgZ2V0RG9jUGF0aCB9IGZyb20gJy4vdXRpbHMnO1xuXG4vLy8vLy8vLy8vLy8vXG4vLyBTRVJWSUNFIC8vXG4vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBGaXJlQ29sbGVjdGlvbjxFIGV4dGVuZHMgRG9jdW1lbnREYXRhPiB7XG4gIHByb3RlY3RlZCBwbGF0Zm9ybUlkID0gaW5qZWN0KFBMQVRGT1JNX0lEKTtcbiAgcHJvdGVjdGVkIHpvbmUgPSBpbmplY3QoTmdab25lKTtcbiAgcHJvdGVjdGVkIGZpcmVzdG9yZSA9IGluamVjdChGaXJlc3RvcmVTZXJ2aWNlKTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbiAgcHJvdGVjdGVkIGlkS2V5OiBEZWVwS2V5czxFPiA9ICdpZCcgYXMgYW55O1xuICAvKiogSWYgdHJ1ZSwgd2lsbCBzdG9yZSB0aGUgZG9jdW1lbnQgaWQgKElkS2V5KSBvbnRvIHRoZSBkb2N1bWVudCAqL1xuICBwcm90ZWN0ZWQgc3RvcmVJZCA9IGZhbHNlO1xuICAvKipcbiAgICogQ2FjaGUgdGhlIHNuYXBzaG90IGludG8gYSBnbG9iYWwgc3RvcmVcbiAgICovXG4gIHByb3RlY3RlZCBtZW1vcml6ZSA9IGZhbHNlO1xuICAvKipcbiAgICogRGVsYXkgYmVmb3JlIHVuc3Vic2NyaWJpbmcgdG8gYSBxdWVyeSAodXNlZCBvbmx5IHdpdGggbWVtb3JpemVkIGlzIHRydWUpXG4gICAqIFVzZSBJbmZpbnR5IGZvciBhcHBsaWNhdGlvbiBsb25nIHN1YnNjcmlwdGlvblxuICAgKi9cbiAgcHJvdGVjdGVkIGRlbGF5VG9VbnN1YnNjcmliZSA9IDA7XG5cbiAgcHJvdGVjdGVkIG9uQ3JlYXRlPyhlbnRpdHk6IEUsIG9wdGlvbnM6IFdyaXRlT3B0aW9ucyk6IHVua25vd247XG4gIHByb3RlY3RlZCBvblVwZGF0ZT8oZW50aXR5OiBGaXJlRW50aXR5PEU+LCBvcHRpb25zOiBXcml0ZU9wdGlvbnMpOiB1bmtub3duO1xuICBwcm90ZWN0ZWQgb25EZWxldGU/KGlkOiBzdHJpbmcsIG9wdGlvbnM6IFdyaXRlT3B0aW9ucyk6IHVua25vd247XG5cblxuICBwcm90ZWN0ZWQgZ2V0IGRiKCkge1xuICAgIHJldHVybiB0aGlzLmZpcmVzdG9yZS5kYjtcbiAgfVxuXG4gIHByb3RlY3RlZCB1c2VDYWNoZTxUIGV4dGVuZHMgRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPik6IE9ic2VydmFibGU8VD5cbiAgcHJvdGVjdGVkIHVzZUNhY2hlPFQgZXh0ZW5kcyBFPihyZWY6IFF1ZXJ5PFQ+KTogT2JzZXJ2YWJsZTxUW10+XG4gIHByb3RlY3RlZCB1c2VDYWNoZTxUIGV4dGVuZHMgRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPiB8IFF1ZXJ5PFQ+KTogT2JzZXJ2YWJsZTxUIHwgVFtdPiAgIFxuICBwcm90ZWN0ZWQgdXNlQ2FjaGU8VCBleHRlbmRzIEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBRdWVyeTxUPik6IE9ic2VydmFibGU8VCB8IFRbXT4ge1xuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gZnJvbVJlZihyZWYgYXMgUXVlcnk8VD4pKS5waXBlKFxuICAgICAgICBtYXAoc25hcCA9PiB0aGlzLnNuYXBUb0RhdGEoc25hcCkpLFxuICAgICAgICB0YXAodmFsdWUgPT4gdGhpcy5maXJlc3RvcmUuc2V0VHJhbnNmZXIocmVmLCB2YWx1ZSkpLFxuICAgICAgICBrZWVwVW5zdGFibGVVbnRpbEZpcnN0KHRoaXMuem9uZSlcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICghdGhpcy5tZW1vcml6ZSkge1xuICAgICAgcmV0dXJuIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBmcm9tUmVmKHJlZiBhcyBRdWVyeTxUPikpLnBpcGUoXG4gICAgICAgIG1hcChzbmFwID0+IHRoaXMuc25hcFRvRGF0YShzbmFwKSksXG4gICAgICAgIGtlZXBVbnN0YWJsZVVudGlsRmlyc3QodGhpcy56b25lKVxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgdHJhbnNmZXIgPSB0aGlzLmZpcmVzdG9yZS5nZXRUcmFuc2ZlcihyZWYpO1xuICAgIGNvbnN0IGluaXRpYWwgPSB0aGlzLmZpcmVzdG9yZS5nZXRTdGF0ZShyZWYpO1xuICAgIGNvbnN0IHNuYXAkID0gdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHRoaXMuZmlyZXN0b3JlLmZyb21NZW1vcnkocmVmLCB0aGlzLmRlbGF5VG9VbnN1YnNjcmliZSkpLnBpcGUoXG4gICAgICB0YXAoc25hcCA9PiB0aGlzLmZpcmVzdG9yZS5zZXRTdGF0ZShyZWYsIHNuYXApKSxcbiAgICAgIGtlZXBVbnN0YWJsZVVudGlsRmlyc3QodGhpcy56b25lKVxuICAgICk7XG4gICAgaWYgKHRyYW5zZmVyKSByZXR1cm4gc25hcCQucGlwZShtYXAoc25hcCA9PiB0aGlzLnNuYXBUb0RhdGEoc25hcCkpLCBzdGFydFdpdGgodHJhbnNmZXIpKTtcbiAgICBpZiAoaW5pdGlhbCkgcmV0dXJuIHNuYXAkLnBpcGUoc3RhcnRXaXRoKGluaXRpYWwpLCBtYXAoc25hcCA9PiB0aGlzLnNuYXBUb0RhdGEoc25hcCkpKTtcbiAgICByZXR1cm4gc25hcCQucGlwZShtYXAoc25hcCA9PiB0aGlzLnNuYXBUb0RhdGEoc25hcCkpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjbGVhckNhY2hlPFQgZXh0ZW5kcyBFPihyZWZzOiBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+IHwgRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBRdWVyeTxUPiB8IERvY3VtZW50UmVmZXJlbmNlPFQ+W10pIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShyZWZzKSkgcmV0dXJuIHRoaXMuZmlyZXN0b3JlLmNsZWFyQ2FjaGUocmVmcy5tYXAocmVmID0+IHJlZi5wYXRoKSk7XG4gICAgaWYgKGlzUXVlcnkocmVmcykpIHJldHVybiB0aGlzLmZpcmVzdG9yZS5jbGVhckNhY2hlKHJlZnMpO1xuICAgIHJldHVybiB0aGlzLmZpcmVzdG9yZS5jbGVhckNhY2hlKHJlZnM/LnBhdGgpO1xuICB9XG5cbiAgLyoqIEZ1bmN0aW9uIHRyaWdnZXJlZCB3aGVuIGFkZGluZy91cGRhdGluZyBkYXRhIHRvIGZpcmVzdG9yZSAqL1xuICBwcm90ZWN0ZWQgdG9GaXJlc3RvcmUoZW50aXR5OiBGaXJlRW50aXR5PEU+LCBhY3Rpb25UeXBlOiAnYWRkJyB8ICd1cGRhdGUnKTogYW55IHwgUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoYWN0aW9uVHlwZSA9PT0gJ2FkZCcpIHtcbiAgICAgIGNvbnN0IF9tZXRhOiBNZXRhRG9jdW1lbnQgPSB7IGNyZWF0ZWRBdDogbmV3IERhdGUoKSwgbW9kaWZpZWRBdDogbmV3IERhdGUoKSB9O1xuICAgICAgcmV0dXJuIHsgX21ldGEsIC4uLmVudGl0eSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4geyAuLi5lbnRpdHksICdfbWV0YS5tb2RpZmllZEF0JzogbmV3IERhdGUoKSB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKiBGdW5jdGlvbiB0cmlnZ2VyZWQgd2hlbiBnZXR0aW5nIGRhdGEgZnJvbSBmaXJlc3RvcmUgKi9cbiAgcHJvdGVjdGVkIGZyb21GaXJlc3RvcmUoc25hcHNob3Q6IERvY3VtZW50U25hcHNob3Q8RT4gfCBRdWVyeURvY3VtZW50U25hcHNob3Q8RT4pOiBFIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc25hcHNob3QuZXhpc3RzKCkpIHtcbiAgICAgIHJldHVybiB7IC4uLnRvRGF0ZShzbmFwc2hvdC5kYXRhKCkpLCBbdGhpcy5pZEtleV06IHNuYXBzaG90LmlkIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgYmF0Y2goKSB7XG4gICAgcmV0dXJuIHdyaXRlQmF0Y2godGhpcy5kYik7XG4gIH1cblxuICBydW5UcmFuc2FjdGlvbjxUPihjYjogKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbikgPT4gUHJvbWlzZTxUPikge1xuICAgIHJldHVybiBydW5UcmFuc2FjdGlvbjxUPih0aGlzLmRiLCAodHgpID0+IGNiKHR4KSk7XG4gIH1cblxuICBjcmVhdGVJZCgpIHtcbiAgICByZXR1cm4gZG9jKGNvbGxlY3Rpb24odGhpcy5kYiwgJ19fJykpLmlkO1xuICB9XG5cblxuICAvKiogR2V0IHRoZSBjb250ZW50IG9mIHRoZSBzbmFwc2hvdCAqL1xuICBwcm90ZWN0ZWQgc25hcFRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXA6IERvY3VtZW50U25hcHNob3Q8VD4pOiBUO1xuICBwcm90ZWN0ZWQgc25hcFRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXA6IERvY3VtZW50U25hcHNob3Q8VD5bXSk6IFRbXTtcbiAgcHJvdGVjdGVkIHNuYXBUb0RhdGE8VCBleHRlbmRzIEUgPSBFPihzbmFwOiBRdWVyeVNuYXBzaG90PFQ+KTogVFtdO1xuICBwcm90ZWN0ZWQgc25hcFRvRGF0YTxUIGV4dGVuZHMgRSA9IEU+KHNuYXA6IFF1ZXJ5U25hcHNob3Q8VD4gfCBEb2N1bWVudFNuYXBzaG90PFQ+IHwgRG9jdW1lbnRTbmFwc2hvdDxUPltdKTogVCB8IFRbXTtcbiAgcHJvdGVjdGVkIHNuYXBUb0RhdGE8VCBleHRlbmRzIEUgPSBFPihzbmFwOiBRdWVyeVNuYXBzaG90PFQ+IHwgRG9jdW1lbnRTbmFwc2hvdDxUPiB8IERvY3VtZW50U25hcHNob3Q8VD5bXSk6IFQgfCBUW10ge1xuICAgIGlmIChzbmFwIGluc3RhbmNlb2YgRG9jdW1lbnRTbmFwc2hvdCkgcmV0dXJuIHRoaXMuZnJvbUZpcmVzdG9yZShzbmFwKSBhcyBUO1xuICAgIGNvbnN0IHNuYXBzID0gQXJyYXkuaXNBcnJheShzbmFwKSA/IHNuYXAgOiBzbmFwLmRvY3M7XG4gICAgcmV0dXJuIHNuYXBzLm1hcChzID0+IHRoaXMuc25hcFRvRGF0YShzKSkuZmlsdGVyKGlzTm90VW5kZWZpbmVkKTtcbiAgfVxuXG4gIC8qKiBHZXQgdGhlIGNvbnRlbnQgb2YgcmVmZXJlbmNlKHMpICovXG4gIHByb3RlY3RlZCBhc3luYyBnZXRGcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPik6IFByb21pc2U8VCB8IHVuZGVmaW5lZD47XG4gIHByb3RlY3RlZCBhc3luYyBnZXRGcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPltdKTogUHJvbWlzZTxUW10+O1xuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0RnJvbVJlZjxUIGV4dGVuZHMgRSA9IEU+KHJlZjogQ29sbGVjdGlvblJlZmVyZW5jZTxUPiB8IFF1ZXJ5PFQ+KTogUHJvbWlzZTxUW10+O1xuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0RnJvbVJlZjxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBEb2N1bWVudFJlZmVyZW5jZTxUPltdIHwgQ29sbGVjdGlvblJlZmVyZW5jZTxUPiB8IFF1ZXJ5PFQ+XG4gICk6IFByb21pc2U8dW5kZWZpbmVkIHwgVCB8IFRbXT47XG4gIHByb3RlY3RlZCBhc3luYyBnZXRGcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgcmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPiB8IERvY3VtZW50UmVmZXJlbmNlPFQ+W10gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+IHwgUXVlcnk8VD5cbiAgKTogUHJvbWlzZTx1bmRlZmluZWQgfCBUIHwgVFtdPiB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVmKSkgcmV0dXJuIFByb21pc2UuYWxsKHJlZi5tYXAoZ2V0RG9jKSkudGhlbihzbmFwcyA9PiB0aGlzLnNuYXBUb0RhdGEoc25hcHMpKTtcbiAgICBjb25zdCBzbmFwID0gKHJlZi50eXBlID09PSAnZG9jdW1lbnQnKSA/IGF3YWl0IGdldERvYyhyZWYpIDogYXdhaXQgZ2V0RG9jcyhyZWYpO1xuICAgIHJldHVybiB0aGlzLnNuYXBUb0RhdGEoc25hcCk7XG4gIH1cblxuICAvKiogT2JzZXJ2YWJsZSB0aGUgY29udGVudCBvZiByZWZlcmVuY2UocykgICovXG4gIHByb3RlY3RlZCBmcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPik6IE9ic2VydmFibGU8VCB8IHVuZGVmaW5lZD47XG4gIHByb3RlY3RlZCBmcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPltdKTogT2JzZXJ2YWJsZTxUW10+O1xuICBwcm90ZWN0ZWQgZnJvbVJlZjxUIGV4dGVuZHMgRSA9IEU+KHJlZjogQ29sbGVjdGlvblJlZmVyZW5jZTxUPiB8IFF1ZXJ5PFQ+KTogT2JzZXJ2YWJsZTxUW10+O1xuICBwcm90ZWN0ZWQgZnJvbVJlZjxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBEb2N1bWVudFJlZmVyZW5jZTxUPltdIHwgQ29sbGVjdGlvblJlZmVyZW5jZTxUPiB8IFF1ZXJ5PFQ+XG4gICk6IE9ic2VydmFibGU8dW5kZWZpbmVkIHwgVCB8IFRbXT47XG4gIHByb3RlY3RlZCBmcm9tUmVmPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgcmVmOiBEb2N1bWVudFJlZmVyZW5jZTxUPiB8IERvY3VtZW50UmVmZXJlbmNlPFQ+W10gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+IHwgUXVlcnk8VD5cbiAgKTogT2JzZXJ2YWJsZTx1bmRlZmluZWQgfCBUIHwgVFtdPiB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVmKSkge1xuICAgICAgaWYgKCFyZWYubGVuZ3RoKSByZXR1cm4gb2YoW10pO1xuICAgICAgY29uc3QgcXVlcmllcyA9IHJlZi5tYXAociA9PiB0aGlzLnVzZUNhY2hlKHIpKTtcbiAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHF1ZXJpZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy51c2VDYWNoZShyZWYpO1xuICAgIH1cbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vL1xuICAvLyBTTkFQU0hPVFMgLy9cbiAgLy8vLy8vLy8vLy8vLy8vXG5cbiAgLyoqIEdldCB0aGUgcmVmZXJlbmNlIG9mIHRoZSBkb2N1bWVudCwgY29sbGVjdGlvbiBvciBxdWVyeSAqL1xuICBwdWJsaWMgZ2V0UmVmPFQgZXh0ZW5kcyBFID0gRT4oKTogQ29sbGVjdGlvblJlZmVyZW5jZTxUPjtcbiAgcHVibGljIGdldFJlZjxUIGV4dGVuZHMgRSA9IEU+KGlkczogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IERvY3VtZW50UmVmZXJlbmNlPFQ+W107XG4gIHB1YmxpYyBnZXRSZWY8VCBleHRlbmRzIEUgPSBFPihjb25zdHJhaW50czogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtczogUGFyYW1zKTogUXVlcnk8VD47XG4gIHB1YmxpYyBnZXRSZWY8VCBleHRlbmRzIEUgPSBFPihpZDogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpOiBEb2N1bWVudFJlZmVyZW5jZTxUPjtcbiAgcHVibGljIGdldFJlZjxUIGV4dGVuZHMgRSA9IEU+KHBhdGg6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+O1xuICBwdWJsaWMgZ2V0UmVmPFQgZXh0ZW5kcyBFID0gRT4ocGFyYW1zOiBQYXJhbXMpOiBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+O1xuICBwdWJsaWMgZ2V0UmVmPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgaWRzPzogc3RyaW5nIHwgc3RyaW5nW10gfCBQYXJhbXMgfCBRdWVyeUNvbnN0cmFpbnRbXSxcbiAgICBwYXJhbXM/OiBQYXJhbXNcbiAgKTogdW5kZWZpbmVkIHwgUXVlcnk8VD4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPFQ+IHwgRG9jdW1lbnRSZWZlcmVuY2U8VD4gfCBEb2N1bWVudFJlZmVyZW5jZTxUPltdXG4gIHB1YmxpYyBnZXRSZWY8VCBleHRlbmRzIEU+KFxuICAgIGlkcz86IHN0cmluZyB8IHN0cmluZ1tdIHwgUGFyYW1zIHwgUXVlcnlDb25zdHJhaW50W10sXG4gICAgcGFyYW1ldGVycz86IFBhcmFtc1xuICApOiB1bmRlZmluZWQgfCBRdWVyeTxUPiB8IENvbGxlY3Rpb25SZWZlcmVuY2U8VD4gfCBEb2N1bWVudFJlZmVyZW5jZTxUPiB8IERvY3VtZW50UmVmZXJlbmNlPFQ+W10ge1xuICAgIC8vIENvbGxlY3Rpb25cbiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiB0aGlzLmZpcmVzdG9yZS5nZXRSZWYodGhpcy5wYXRoKTtcbiAgICAvLyBJZCBpcyB1bmRlZmluZWQgb3IgbnVsbFxuICAgIGlmICghaWRzKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIFxuICAgIGlmIChBcnJheS5pc0FycmF5KGlkcykpIHtcbiAgICAgIC8vIExpc3Qgb2YgcmVmXG4gICAgICBpZiAoKGlkcyBhcyBhbnlbXSkuZXZlcnkoaXNQYXRoUmVmKSkgcmV0dXJuIHRoaXMuZmlyZXN0b3JlLmdldFJlZihpZHMgYXMgc3RyaW5nW10pO1xuICAgICAgXG4gICAgICBjb25zdCBwYXRoID0gcGF0aFdpdGhQYXJhbXModGhpcy5wYXRoLCBwYXJhbWV0ZXJzKTtcbiAgICAgIC8vIExpc3Qgb2YgaWRzXG4gICAgICBpZiAoaXNJZExpc3QoaWRzKSkgcmV0dXJuIHRoaXMuZmlyZXN0b3JlLmdldFJlZihpZHMubWFwKChpZCkgPT4gZ2V0RG9jUGF0aChwYXRoLCBpZCkpKTtcbiAgICAgIC8vIExpc3Qgb2YgY29uc3RyYWludHNcbiAgICAgIHJldHVybiB0aGlzLmZpcmVzdG9yZS5nZXRSZWYocGF0aCwgaWRzKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIC8vIFJlZlxuICAgICAgaWYgKGlzUGF0aFJlZihpZHMpKSByZXR1cm4gdGhpcy5maXJlc3RvcmUuZ2V0UmVmKGlkcyk7XG4gICAgICAvLyBJZFxuICAgICAgY29uc3QgcGF0aCA9IHBhdGhXaXRoUGFyYW1zKHRoaXMucGF0aCwgcGFyYW1ldGVycyk7XG4gICAgICByZXR1cm4gdGhpcy5maXJlc3RvcmUuZ2V0UmVmKGdldERvY1BhdGgocGF0aCwgaWRzKSk7XG4gICAgfVxuXG4gICAgLy8gU3ViY29sbGVjdGlvblxuICAgIHJldHVybiB0aGlzLmZpcmVzdG9yZS5nZXRSZWYocGF0aFdpdGhQYXJhbXModGhpcy5wYXRoLCBpZHMpKTtcbiAgfVxuXG5cbiAgLyoqIENsZWFyIGNhY2hlIGFuZCBnZXQgdGhlIGxhdGVzdCB2YWx1ZSBpbnRvIHRoZSBjYWNoZSAqL1xuICBwdWJsaWMgYXN5bmMgcmVsb2FkPFQgZXh0ZW5kcyBFID0gRT4oaWRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IFF1ZXJ5Q29uc3RyYWludFtdKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgYXN5bmMgcmVsb2FkPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGFzeW5jIHJlbG9hZDxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBudWxsLFxuICApOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPigpOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIXRoaXMubWVtb3JpemUpIHJldHVybjtcbiAgICBjb25zdCByZWYgPSB0aGlzLmdldFJlZiguLi5hcmd1bWVudHMpO1xuICAgIGlmICghcmVmKSByZXR1cm47XG4gICAgdGhpcy5jbGVhckNhY2hlKHJlZik7XG4gICAgcmV0dXJuIHRoaXMubG9hZCguLi5hcmd1bWVudHMpO1xuICB9XG5cbiAgLyoqIEdldCB0aGUgbGFzdCBjb250ZW50IGZyb20gdGhlIGFwcCAoaWYgdmFsdWUgaGFzIGJlZW4gY2FjaGVkLCBpdCB3b24ndCBkbyBhIHNlcnZlciByZXF1ZXN0KSAqL1xuICBwdWJsaWMgYXN5bmMgbG9hZDxUIGV4dGVuZHMgRSA9IEU+KGlkcz86IHN0cmluZ1tdKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgYXN5bmMgbG9hZDxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5PzogUXVlcnlDb25zdHJhaW50W10pOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyBsb2FkPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGFzeW5jIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihcbiAgICBpZE9yUXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgbnVsbCxcbiAgKTogUHJvbWlzZTxUIHwgVFtdIHwgdW5kZWZpbmVkPlxuICBwdWJsaWMgYXN5bmMgbG9hZDxUIGV4dGVuZHMgRT4oKTogUHJvbWlzZTxUIHwgVFtdIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIGZpcnN0VmFsdWVGcm9tKHRoaXMudmFsdWVDaGFuZ2VzKC4uLmFyZ3VtZW50cykpO1xuICB9XG5cbiAgLyoqIFJldHVybiB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgcGF0aCBmcm9tIEZpcmVzdG9yZSAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihpZHM/OiBzdHJpbmdbXSk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4ocXVlcnk/OiBRdWVyeUNvbnN0cmFpbnRbXSk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oaWRPclF1ZXJ5PzogbnVsbCB8IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10pOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+XG4gIHB1YmxpYyBhc3luYyBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KCk6IFByb21pc2U8VCB8IFRbXSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmPFQ+KC4uLmFyZ3VtZW50cyk7XG4gICAgaWYgKCFyZWYpIHJldHVybjtcbiAgICByZXR1cm4gdGhpcy5nZXRGcm9tUmVmPFQ+KHJlZik7XG4gIH1cblxuICAvKiogTGlzdGVuIHRvIHRoZSBjaGFuZ2VzIG9mIHZhbHVlcyBvZiB0aGUgcGF0aCBmcm9tIEZpcmVzdG9yZSAqL1xuICBwdWJsaWMgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oaWRzPzogc3RyaW5nW10pOiBPYnNlcnZhYmxlPFRbXT47XG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IFF1ZXJ5Q29uc3RyYWludFtdKTogT2JzZXJ2YWJsZTxUW10+O1xuICBwdWJsaWMgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcgfCBudWxsKTogT2JzZXJ2YWJsZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBudWxsLFxuICApOiBPYnNlcnZhYmxlPFQgfCBUW10gfCB1bmRlZmluZWQ+O1xuICBwdWJsaWMgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgaWRPclF1ZXJ5Pzogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IG51bGwsXG4gICk6IE9ic2VydmFibGU8VCB8IFRbXSB8IHVuZGVmaW5lZD4ge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGlkT3JRdWVyeSkgJiYgIWlkT3JRdWVyeS5sZW5ndGgpIHJldHVybiBvZihbXSk7XG4gICAgY29uc3QgcmVmID0gdGhpcy5nZXRSZWY8VD4oLi4uYXJndW1lbnRzKTtcbiAgICBpZiAoIXJlZikgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVJlZjxUPihyZWYpO1xuICB9XG5cblxuICAvLy8vLy8vLy8vL1xuICAvLyBXUklURSAvL1xuICAvLy8vLy8vLy8vL1xuICAvKipcbiAgICogQ3JlYXRlIG9yIHVwZGF0ZSBkb2N1bWVudHNcbiAgICogQHBhcmFtIGRvY3VtZW50cyBPbmUgb3IgbWFueSBkb2N1bWVudHNcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9ucyB0byB3cml0ZSB0aGUgZG9jdW1lbnQgb24gZmlyZXN0b3JlXG4gICAqL1xuICB1cHNlcnQ8VCBleHRlbmRzIEU+KGRvY3VtZW50czogRmlyZUVudGl0eTxUPiwgb3B0aW9ucz86IFdyaXRlT3B0aW9ucyk6IFByb21pc2U8c3RyaW5nPjtcbiAgdXBzZXJ0PFQgZXh0ZW5kcyBFPihkb2N1bWVudHM6IEZpcmVFbnRpdHk8VD5bXSwgb3B0aW9ucz86IFdyaXRlT3B0aW9ucyk6IFByb21pc2U8c3RyaW5nW10+O1xuICBhc3luYyB1cHNlcnQ8VCBleHRlbmRzIEU+KFxuICAgIGRvY3VtZW50czogRmlyZUVudGl0eTxUPiB8IEZpcmVFbnRpdHk8VD5bXSxcbiAgICBvcHRpb25zOiBXcml0ZU9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPHN0cmluZyB8IHN0cmluZ1tdPiB7XG4gICAgY29uc3QgZG9lc0V4aXN0ID0gYXN5bmMgKGRvYzogRmlyZUVudGl0eTxUPikgPT4ge1xuICAgICAgY29uc3QgaWQ6IHN0cmluZyB8IEZpZWxkVmFsdWUgfCB1bmRlZmluZWQgPSBkb2NbdGhpcy5pZEtleV07XG4gICAgICBpZiAodHlwZW9mIGlkICE9PSAnc3RyaW5nJykgcmV0dXJuIGZhbHNlO1xuICAgICAgY29uc3QgcmVmID0gdGhpcy5nZXRSZWYoaWQsIG9wdGlvbnMucGFyYW1zKTtcbiAgICAgIGNvbnN0IHNuYXAgPSAob3B0aW9ucy53cml0ZSBpbnN0YW5jZW9mIFRyYW5zYWN0aW9uKVxuICAgICAgICA/IGF3YWl0IG9wdGlvbnMud3JpdGU/LmdldChyZWYpXG4gICAgICAgIDogYXdhaXQgZ2V0RG9jKHJlZik7XG4gICAgICByZXR1cm4gc25hcC5leGlzdHMoKTtcbiAgICB9O1xuICAgIGNvbnN0IHVwc2VydCA9IGFzeW5jIChkb2M6IEZpcmVFbnRpdHk8VD4pID0+IHtcbiAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IGRvZXNFeGlzdChkb2MpO1xuICAgICAgaWYgKCFleGlzdHMpIHJldHVybiB0aGlzLmFkZChkb2MsIG9wdGlvbnMpO1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGUoZG9jLCBvcHRpb25zKTtcbiAgICAgIHJldHVybiBkb2NbdGhpcy5pZEtleV0gYXMgc3RyaW5nO1xuICAgIH1cbiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShkb2N1bWVudHMpXG4gICAgICA/IFByb21pc2UuYWxsKGRvY3VtZW50cy5tYXAodXBzZXJ0KSlcbiAgICAgIDogdXBzZXJ0KGRvY3VtZW50cyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgZG9jdW1lbnQgb3IgYSBsaXN0IG9mIGRvY3VtZW50IHRvIEZpcmVzdG9yZVxuICAgKiBAcGFyYW0gZG9jcyBBIGRvY3VtZW50IG9yIGEgbGlzdCBvZiBkb2N1bWVudFxuICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zIHRvIHdyaXRlIHRoZSBkb2N1bWVudCBvbiBmaXJlc3RvcmVcbiAgICovXG4gIGFkZDxUIGV4dGVuZHMgRT4oZG9jdW1lbnRzOiBGaXJlRW50aXR5PFQ+LCBvcHRpb25zPzogV3JpdGVPcHRpb25zKTogUHJvbWlzZTxzdHJpbmc+O1xuICBhZGQ8VCBleHRlbmRzIEU+KGRvY3VtZW50czogRmlyZUVudGl0eTxUPltdLCBvcHRpb25zPzogV3JpdGVPcHRpb25zKTogUHJvbWlzZTxzdHJpbmdbXT47XG4gIGFzeW5jIGFkZDxUIGV4dGVuZHMgRT4oXG4gICAgZG9jdW1lbnRzOiBGaXJlRW50aXR5PFQ+IHwgRmlyZUVudGl0eTxUPltdLFxuICAgIG9wdGlvbnM6IFdyaXRlT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8c3RyaW5nIHwgc3RyaW5nW10+IHtcbiAgICBjb25zdCBkb2NzID0gQXJyYXkuaXNBcnJheShkb2N1bWVudHMpID8gZG9jdW1lbnRzIDogW2RvY3VtZW50c107XG4gICAgY29uc3QgeyB3cml0ZSA9IHRoaXMuYmF0Y2goKSwgY3R4IH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IG9wZXJhdGlvbnMgPSBkb2NzLm1hcChhc3luYyAodmFsdWUpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gKHZhbHVlW3RoaXMuaWRLZXldIGFzIHN0cmluZyB8IHVuZGVmaW5lZCkgfHwgdGhpcy5jcmVhdGVJZCgpO1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMudG9GaXJlc3RvcmUodmFsdWUsICdhZGQnKTtcbiAgICAgIGlmICh0aGlzLnN0b3JlSWQpIGRhdGFbdGhpcy5pZEtleV0gPSBpZDtcbiAgICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmKGlkLCBvcHRpb25zLnBhcmFtcyk7XG4gICAgICAod3JpdGUgYXMgV3JpdGVCYXRjaCkuc2V0KHJlZiwgZGF0YSk7XG4gICAgICBpZiAodGhpcy5vbkNyZWF0ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLm9uQ3JlYXRlKGRhdGEsIHsgd3JpdGUsIGN0eCB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpZDtcbiAgICB9KTtcbiAgICBjb25zdCBpZHM6IHN0cmluZ1tdID0gYXdhaXQgUHJvbWlzZS5hbGwob3BlcmF0aW9ucyk7XG4gICAgLy8gSWYgdGhlcmUgaXMgbm8gYXRvbWljIHdyaXRlIHByb3ZpZGVkXG4gICAgaWYgKCFvcHRpb25zLndyaXRlKSB7XG4gICAgICBhd2FpdCAod3JpdGUgYXMgV3JpdGVCYXRjaCkuY29tbWl0KCk7XG4gICAgfVxuICAgIHJldHVybiBBcnJheS5pc0FycmF5KGRvY3VtZW50cykgPyBpZHMgOiBpZHNbMF07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIG9uZSBvciBzZXZlcmFsIGRvY3VtZW50IGZyb20gRmlyZXN0b3JlXG4gICAqIEBwYXJhbSBpZCBBIHVuaXF1ZSBvciBsaXN0IG9mIGlkIHJlcHJlc2VudGluZyB0aGUgZG9jdW1lbnRcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9ucyB0byB3cml0ZSB0aGUgZG9jdW1lbnQgb24gZmlyZXN0b3JlXG4gICAqL1xuICBhc3luYyByZW1vdmU8VCBleHRlbmRzIEU+KGlkOiBzdHJpbmcgfCBzdHJpbmdbXSwgb3B0aW9uczogV3JpdGVPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCB7IHdyaXRlID0gdGhpcy5iYXRjaCgpLCBjdHggfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgaWRzOiBzdHJpbmdbXSA9IEFycmF5LmlzQXJyYXkoaWQpID8gaWQgOiBbaWRdO1xuICAgIGNvbnN0IHJlZnM6IERvY3VtZW50UmVmZXJlbmNlPFQ+W10gPSBbXTtcbiAgICBjb25zdCBvcGVyYXRpb25zID0gaWRzLm1hcChhc3luYyAoZG9jSWQpID0+IHtcbiAgICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmPFQ+KGRvY0lkLCBvcHRpb25zLnBhcmFtcyk7XG4gICAgICB3cml0ZS5kZWxldGUocmVmKTtcbiAgICAgIGlmICh0aGlzLm9uRGVsZXRlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMub25EZWxldGUoZG9jSWQsIHsgd3JpdGUsIGN0eCB9KTtcbiAgICAgIH1cbiAgICAgIHJlZnMucHVzaChyZWYpO1xuICAgIH0pO1xuICAgIGF3YWl0IFByb21pc2UuYWxsKG9wZXJhdGlvbnMpO1xuICAgIC8vIElmIHRoZXJlIGlzIG5vIGF0b21pYyB3cml0ZSBwcm92aWRlZFxuICAgIGlmICghb3B0aW9ucy53cml0ZSkge1xuICAgICAgYXdhaXQgKHdyaXRlIGFzIFdyaXRlQmF0Y2gpLmNvbW1pdCgpO1xuICAgICAgaWYgKHRoaXMubWVtb3JpemUpIHRoaXMuY2xlYXJDYWNoZShyZWZzKTtcbiAgICB9XG4gIH1cblxuICAvKiogUmVtb3ZlIGFsbCBkb2N1bWVudCBvZiB0aGUgY29sbGVjdGlvbiAqL1xuICBhc3luYyByZW1vdmVBbGwob3B0aW9uczogV3JpdGVPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCByZWYgPSBvcHRpb25zLnBhcmFtcyA/IHRoaXMuZ2V0UmVmKG9wdGlvbnMucGFyYW1zKSA6IHRoaXMuZ2V0UmVmKCk7XG4gICAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBnZXREb2NzKHJlZik7XG4gICAgY29uc3QgaWRzID0gc25hcHNob3QuZG9jcy5tYXAoKGRvYykgPT4gZG9jLmlkKTtcbiAgICBhd2FpdCB0aGlzLnJlbW92ZShpZHMsIG9wdGlvbnMpO1xuICAgIGlmICh0aGlzLm1lbW9yaXplKSB0aGlzLmNsZWFyQ2FjaGUocmVmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgb25lIG9yIHNldmVyYWwgZG9jdW1lbnQgaW4gRmlyZXN0b3JlXG4gICAqL1xuICB1cGRhdGU8VCBleHRlbmRzIEU+KGVudGl0eTogRmlyZUVudGl0eTxUPiB8IEZpcmVFbnRpdHk8VD5bXSwgb3B0aW9ucz86IFdyaXRlT3B0aW9ucyk6IFByb21pc2U8dm9pZD47XG4gIHVwZGF0ZTxUIGV4dGVuZHMgRT4oaWQ6IHN0cmluZyB8IHN0cmluZ1tdLCBlbnRpdHlDaGFuZ2VzOiBGaXJlRW50aXR5PFQ+LCBvcHRpb25zPzogV3JpdGVPcHRpb25zKTogUHJvbWlzZTx2b2lkPjtcbiAgdXBkYXRlPFQgZXh0ZW5kcyBFPihcbiAgICBpZHM6IHN0cmluZyB8IHN0cmluZ1tdLFxuICAgIHN0YXRlRnVuY3Rpb246IFVwZGF0ZUNhbGxiYWNrPFQ+LFxuICAgIG9wdGlvbnM/OiBXcml0ZU9wdGlvbnNcbiAgKTogUHJvbWlzZTxUcmFuc2FjdGlvbltdPjtcbiAgYXN5bmMgdXBkYXRlPFQgZXh0ZW5kcyBFPihcbiAgICBpZHNPckVudGl0eTogRmlyZUVudGl0eTxUPiB8IEZpcmVFbnRpdHk8VD5bXSB8IHN0cmluZyB8IHN0cmluZ1tdLFxuICAgIHN0YXRlRm5PcldyaXRlPzogVXBkYXRlQ2FsbGJhY2s8VD4gfCBGaXJlRW50aXR5PFQ+IHwgV3JpdGVPcHRpb25zLFxuICAgIG9wdGlvbnM6IFdyaXRlT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8dm9pZCB8IFRyYW5zYWN0aW9uW10+IHtcbiAgICBsZXQgaWRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGxldCBzdGF0ZUZ1bmN0aW9uOiBVcGRhdGVDYWxsYmFjazxUPiB8IHVuZGVmaW5lZDtcbiAgICBsZXQgZ2V0RGF0YTogKGRvY0lkOiBzdHJpbmcpID0+IEZpcmVFbnRpdHk8VD47XG5cbiAgICBjb25zdCBpc0VudGl0eSA9ICh2YWx1ZTogRG9jdW1lbnREYXRhIHwgc3RyaW5nKTogdmFsdWUgaXMgRmlyZUVudGl0eTxUPiA9PiB7XG4gICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZVt0aGlzLmlkS2V5XTtcbiAgICB9O1xuICAgIGNvbnN0IGlzRW50aXR5QXJyYXkgPSAodmFsdWVzOiBEb2N1bWVudERhdGEgfCBzdHJpbmdbXSB8IHN0cmluZyk6IHZhbHVlcyBpcyBGaXJlRW50aXR5PFQ+W10gPT4ge1xuICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWVzKSAmJiB2YWx1ZXMuZXZlcnkoKHZhbHVlKSA9PiBpc0VudGl0eSh2YWx1ZSkpO1xuICAgIH07XG5cbiAgICBpZiAoaXNFbnRpdHkoaWRzT3JFbnRpdHkpKSB7XG4gICAgICBpZHMgPSBbaWRzT3JFbnRpdHlbdGhpcy5pZEtleV0gYXMgc3RyaW5nXTtcbiAgICAgIGdldERhdGEgPSAoKSA9PiBpZHNPckVudGl0eTtcbiAgICAgIG9wdGlvbnMgPSAoc3RhdGVGbk9yV3JpdGUgYXMgV3JpdGVPcHRpb25zKSB8fCB7fTtcbiAgICB9IGVsc2UgaWYgKGlzRW50aXR5QXJyYXkoaWRzT3JFbnRpdHkpKSB7XG4gICAgICBjb25zdCBlbnRpdHlNYXAgPSBuZXcgTWFwKFxuICAgICAgICBpZHNPckVudGl0eS5tYXAoKGVudGl0eSkgPT4gW2VudGl0eVt0aGlzLmlkS2V5XSBhcyBzdHJpbmcsIGVudGl0eV0pXG4gICAgICApO1xuICAgICAgaWRzID0gQXJyYXkuZnJvbShlbnRpdHlNYXAua2V5cygpKTtcbiAgICAgIGdldERhdGEgPSAoZG9jSWQpID0+IGVudGl0eU1hcC5nZXQoZG9jSWQpITtcbiAgICAgIG9wdGlvbnMgPSAoc3RhdGVGbk9yV3JpdGUgYXMgV3JpdGVPcHRpb25zKSB8fCB7fTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGF0ZUZuT3JXcml0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaWRzID0gQXJyYXkuaXNBcnJheShpZHNPckVudGl0eSkgPyBpZHNPckVudGl0eSA6IFtpZHNPckVudGl0eV07XG4gICAgICBzdGF0ZUZ1bmN0aW9uID0gc3RhdGVGbk9yV3JpdGUgYXMgVXBkYXRlQ2FsbGJhY2s8VD47XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RhdGVGbk9yV3JpdGUgPT09ICdvYmplY3QnKSB7XG4gICAgICBpZHMgPSBBcnJheS5pc0FycmF5KGlkc09yRW50aXR5KSA/IGlkc09yRW50aXR5IDogW2lkc09yRW50aXR5XTtcbiAgICAgIGdldERhdGEgPSAoKSA9PiBzdGF0ZUZuT3JXcml0ZSBhcyBGaXJlRW50aXR5PFQ+O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bhc3NlZCBwYXJhbWV0ZXJzIG1hdGNoIG5vbmUgb2YgdGhlIGZ1bmN0aW9uIHNpZ25hdHVyZXMuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBjdHggfSA9IG9wdGlvbnM7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGlkcykgfHwgIWlkcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBJZiB1cGRhdGUgZGVwZW5kcyBvbiB0aGUgZW50aXR5LCB1c2UgdHJhbnNhY3Rpb25cbiAgICBpZiAoc3RhdGVGdW5jdGlvbikge1xuICAgICAgbGV0IHJlZnM6IERvY3VtZW50UmVmZXJlbmNlPFQ+W10gPSBbXTtcbiAgICAgIGF3YWl0IHJ1blRyYW5zYWN0aW9uKHRoaXMuZGIsIGFzeW5jICh0eCkgPT4ge1xuICAgICAgICByZWZzID0gW107XG4gICAgICAgIGNvbnN0IG9wZXJhdGlvbnMgPSBpZHMubWFwKGFzeW5jIChpZCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmPFQ+KGlkLCBvcHRpb25zLnBhcmFtcyk7XG4gICAgICAgICAgcmVmcy5wdXNoKHJlZik7XG4gICAgICAgICAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCB0eC5nZXQocmVmKTtcbiAgICAgICAgICBjb25zdCBkb2MgPSB0aGlzLmZyb21GaXJlc3RvcmUoc25hcHNob3QpO1xuICAgICAgICAgIGlmIChkb2MgJiYgc3RhdGVGdW5jdGlvbikge1xuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHN0YXRlRnVuY3Rpb24oZG9jIGFzIFQsIHR4KTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMudG9GaXJlc3RvcmUoZGF0YSwgJ3VwZGF0ZScpO1xuICAgICAgICAgICAgdHgudXBkYXRlKHJlZiwgcmVzdWx0KTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9uVXBkYXRlKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMub25VcGRhdGUoZGF0YSwgeyB3cml0ZTogdHgsIGN0eCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHR4O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKG9wZXJhdGlvbnMpO1xuICAgICAgfSk7XG4gICAgICBpZiAodGhpcy5tZW1vcml6ZSkgdGhpcy5jbGVhckNhY2hlKHJlZnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IHdyaXRlID0gdGhpcy5iYXRjaCgpIH0gPSBvcHRpb25zO1xuICAgICAgY29uc3QgcmVmczogRG9jdW1lbnRSZWZlcmVuY2U8VD5bXSA9IFtdO1xuICAgICAgY29uc3Qgb3BlcmF0aW9ucyA9IGlkcy5tYXAoYXN5bmMgKGRvY0lkKSA9PiB7XG4gICAgICAgIGNvbnN0IGRvYyA9IGdldERhdGEoZG9jSWQpO1xuICAgICAgICBpZiAoIWRvY0lkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEb2N1bWVudCBzaG91bGQgaGF2ZSBhbiB1bmlxdWUgaWQgdG8gYmUgdXBkYXRlZCwgYnV0IG5vbmUgd2FzIGZvdW5kIGluICR7ZG9jfWApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmPFQ+KGRvY0lkLCBvcHRpb25zLnBhcmFtcyk7XG4gICAgICAgIHJlZnMucHVzaChyZWYpO1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy50b0ZpcmVzdG9yZShkb2MsICd1cGRhdGUnKTtcbiAgICAgICAgKHdyaXRlIGFzIFdyaXRlQmF0Y2gpLnVwZGF0ZShyZWYsIGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vblVwZGF0ZSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMub25VcGRhdGUoZG9jLCB7IHdyaXRlLCBjdHggfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwob3BlcmF0aW9ucyk7XG4gICAgICAvLyBJZiB0aGVyZSBpcyBubyBhdG9taWMgd3JpdGUgcHJvdmlkZWRcbiAgICAgIGlmICghb3B0aW9ucy53cml0ZSkge1xuICAgICAgICBhd2FpdCAod3JpdGUgYXMgV3JpdGVCYXRjaCkuY29tbWl0KCk7XG4gICAgICAgIGlmICh0aGlzLm1lbW9yaXplKSB0aGlzLmNsZWFyQ2FjaGUocmVmcylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==
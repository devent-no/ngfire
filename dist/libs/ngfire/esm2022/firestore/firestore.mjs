import { inject, Injectable, InjectFlags, Injector, PLATFORM_ID } from "@angular/core";
import { makeStateKey, TransferState } from "@angular/core";
import { collection, doc, query, runTransaction, writeBatch } from 'firebase/firestore';
import { FIRESTORE } from "./tokens";
import { shareWithDelay, assertCollection, assertPath, isCollectionRef, isDocPath, isQuery } from "ngfire/core";
import { fromRef } from "./operators";
import { isPlatformBrowser, isPlatformServer } from "@angular/common";
import { stringifyQuery } from "./query";
import * as i0 from "@angular/core";
export class FirestoreService {
    constructor() {
        this.memoryRef = {};
        this.injector = inject(Injector);
        this.plateformId = inject(PLATFORM_ID);
        /** Transfer state between server and  */
        this.transferState = inject(TransferState, InjectFlags.Optional);
        /** Cache based state for document */
        this.state = new Map();
    }
    get db() {
        return this.injector.get(FIRESTORE);
    }
    /** @internal Should only be used by FireCollection services */
    setState(ref, snap) {
        if (isCollectionRef(ref)) {
            snap.forEach(doc => this.state.set(doc.ref.path, doc));
            this.state.set(ref.path, snap);
        }
        else if (isQuery(ref)) {
            snap.forEach(doc => this.state.set(doc.ref.path, doc));
            const key = stringifyQuery(ref);
            this.state.set(key, snap);
        }
        else {
            this.state.set(ref.path, snap);
        }
    }
    getState(ref) {
        if (isQuery(ref)) {
            const key = stringifyQuery(ref);
            return this.state.get(key);
        }
        else {
            return this.state.get(ref.path);
        }
    }
    fromMemory(ref, delay) {
        const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
        if (!this.memoryRef[key]) {
            this.memoryRef[key] = fromRef(ref).pipe(shareWithDelay(delay));
        }
        return this.memoryRef[key];
    }
    getTransfer(ref) {
        if (!this.transferState || !isPlatformBrowser(this.plateformId))
            return;
        const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
        const stateKey = makeStateKey(key);
        if (!this.transferState.hasKey(stateKey))
            return;
        const value = this.transferState.get(stateKey, undefined);
        this.transferState.remove(stateKey);
        return value;
    }
    setTransfer(ref, value) {
        if (!value)
            return;
        if (!this.transferState || !isPlatformServer(this.plateformId))
            return;
        if (Array.isArray(ref) && Array.isArray(value)) {
            ref.forEach((reference, i) => this.setTransfer(reference, value[i]));
        }
        else if (!Array.isArray(ref)) {
            const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
            this.transferState.set(makeStateKey(key), value);
        }
    }
    clearCache(paths) {
        if (!paths)
            return;
        if (Array.isArray(paths)) {
            for (const path of paths) {
                delete this.memoryRef[path];
                this.state.delete(path);
            }
        }
        else if (typeof paths === 'string') {
            delete this.memoryRef[paths];
            this.state.delete(paths);
        }
        else {
            const key = stringifyQuery(paths);
            delete this.memoryRef[key];
            this.state.delete(key);
        }
    }
    // overload used internally when looping over paths array
    getRef(paths, constraints) {
        if (!arguments.length || !paths)
            return undefined;
        // Array of docs
        if (Array.isArray(paths)) {
            return paths.map((path) => this.getRef(path));
        }
        const hasContraints = Array.isArray(constraints);
        if (hasContraints) {
            assertPath(paths);
            assertCollection(paths);
            const ref = collection(this.db, paths);
            return query(ref, ...constraints);
        }
        else {
            assertPath(paths);
            if (isDocPath(paths))
                return doc(this.db, paths);
            return collection(this.db, paths);
        }
    }
    batch() {
        return writeBatch(this.db);
    }
    runTransaction(cb) {
        return runTransaction(this.db, (tx) => cb(tx));
    }
    createId() {
        return doc(collection(this.db, '__')).id;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.4", ngImport: i0, type: FirestoreService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.4", ngImport: i0, type: FirestoreService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.4", ngImport: i0, type: FirestoreService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlyZXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ2ZpcmUvZmlyZXN0b3JlL3NyYy9maXJlc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkYsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQWtDLEtBQUssRUFBNkIsY0FBYyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRW5KLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN0QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUV0RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sU0FBUyxDQUFDOztBQU16QyxNQUFNLE9BQU8sZ0JBQWdCO0lBRDdCO1FBRVUsY0FBUyxHQUF5QyxFQUFFLENBQUM7UUFDckQsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QixnQkFBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMxQyx5Q0FBeUM7UUFDakMsa0JBQWEsR0FBRyxNQUFNLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwRSxxQ0FBcUM7UUFDN0IsVUFBSyxHQUEyQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0tBZ0pu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MkIsQ0FBQztZQUNqRSxPQUFPLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQztRQUNwQyxDQUFDO2FBQU0sQ0FBQztZQUNOLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsQixJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUM7Z0JBQUUsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQXlCLENBQUM7WUFDekUsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQTJCLENBQUM7UUFDOUQsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLO1FBQ0gsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxjQUFjLENBQUksRUFBNEM7UUFDNUQsT0FBTyxjQUFjLENBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMzQyxDQUFDOzhHQXJKVSxnQkFBZ0I7a0hBQWhCLGdCQUFnQixjQURILE1BQU07OzJGQUNuQixnQkFBZ0I7a0JBRDVCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RGbGFncywgSW5qZWN0b3IsIFBMQVRGT1JNX0lEIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IG1ha2VTdGF0ZUtleSwgVHJhbnNmZXJTdGF0ZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBjb2xsZWN0aW9uLCBkb2MsIERvY3VtZW50RGF0YSwgRG9jdW1lbnRTbmFwc2hvdCwgcXVlcnksIHF1ZXJ5RXF1YWwsIFF1ZXJ5U25hcHNob3QsIHJ1blRyYW5zYWN0aW9uLCB3cml0ZUJhdGNoIH0gZnJvbSAnZmlyZWJhc2UvZmlyZXN0b3JlJztcbmltcG9ydCB0eXBlIHsgVHJhbnNhY3Rpb24sIENvbGxlY3Rpb25SZWZlcmVuY2UsIERvY3VtZW50UmVmZXJlbmNlLCBRdWVyeSwgUXVlcnlDb25zdHJhaW50IH0gZnJvbSAnZmlyZWJhc2UvZmlyZXN0b3JlJztcbmltcG9ydCB7IEZJUkVTVE9SRSB9IGZyb20gXCIuL3Rva2Vuc1wiO1xuaW1wb3J0IHsgc2hhcmVXaXRoRGVsYXksIGFzc2VydENvbGxlY3Rpb24sIGFzc2VydFBhdGgsIGlzQ29sbGVjdGlvblJlZiwgaXNEb2NQYXRoLCBpc1F1ZXJ5IH0gZnJvbSBcIm5nZmlyZS9jb3JlXCI7XG5pbXBvcnQgeyBmcm9tUmVmIH0gZnJvbSBcIi4vb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciwgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gXCJAYW5ndWxhci9jb21tb25cIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgc3RyaW5naWZ5UXVlcnkgfSBmcm9tIFwiLi9xdWVyeVwiO1xuXG50eXBlIFJlZmVyZW5jZTxFPiA9IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBEb2N1bWVudFJlZmVyZW5jZTxFPjtcbnR5cGUgU25hcHNob3Q8RSA9IERvY3VtZW50RGF0YT4gPSBEb2N1bWVudFNuYXBzaG90PEU+IHwgUXVlcnlTbmFwc2hvdDxFPjtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBGaXJlc3RvcmVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBtZW1vcnlSZWY6IFJlY29yZDxzdHJpbmcsIE9ic2VydmFibGU8U25hcHNob3Q+PiA9IHt9O1xuICBwcml2YXRlIGluamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcbiAgcHJpdmF0ZSBwbGF0ZWZvcm1JZCA9IGluamVjdChQTEFURk9STV9JRCk7XG4gIC8qKiBUcmFuc2ZlciBzdGF0ZSBiZXR3ZWVuIHNlcnZlciBhbmQgICovXG4gIHByaXZhdGUgdHJhbnNmZXJTdGF0ZSA9IGluamVjdChUcmFuc2ZlclN0YXRlLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XG4gIC8qKiBDYWNoZSBiYXNlZCBzdGF0ZSBmb3IgZG9jdW1lbnQgKi9cbiAgcHJpdmF0ZSBzdGF0ZTogTWFwPHN0cmluZyB8IFF1ZXJ5LCBTbmFwc2hvdDx1bmtub3duPj4gPSBuZXcgTWFwKCk7XG5cbiAgZ2V0IGRiKCkge1xuICAgIHJldHVybiB0aGlzLmluamVjdG9yLmdldChGSVJFU1RPUkUpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCBTaG91bGQgb25seSBiZSB1c2VkIGJ5IEZpcmVDb2xsZWN0aW9uIHNlcnZpY2VzICovXG4gIHNldFN0YXRlPEU+KFxuICAgIHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4sXG4gICAgc25hcDogU25hcHNob3Q8RT5cbiAgKSB7XG4gICAgaWYgKGlzQ29sbGVjdGlvblJlZihyZWYpKSB7XG4gICAgICAoc25hcCBhcyBRdWVyeVNuYXBzaG90PEU+KS5mb3JFYWNoKGRvYyA9PiB0aGlzLnN0YXRlLnNldChkb2MucmVmLnBhdGgsIGRvYykpO1xuICAgICAgdGhpcy5zdGF0ZS5zZXQocmVmLnBhdGgsIHNuYXApO1xuICAgIH0gZWxzZSBpZiAoaXNRdWVyeShyZWYpKSB7XG4gICAgICAoc25hcCBhcyBRdWVyeVNuYXBzaG90PEU+KS5mb3JFYWNoKGRvYyA9PiB0aGlzLnN0YXRlLnNldChkb2MucmVmLnBhdGgsIGRvYykpO1xuICAgICAgY29uc3Qga2V5ID0gc3RyaW5naWZ5UXVlcnkocmVmIGFzIGFueSk7XG4gICAgICB0aGlzLnN0YXRlLnNldChrZXksIHNuYXApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YXRlLnNldChyZWYucGF0aCwgc25hcCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0U3RhdGU8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiwgZGVsYXk/OiBudW1iZXIpOiBEb2N1bWVudFNuYXBzaG90PEU+XG4gIGdldFN0YXRlPEU+KHJlZjogQ29sbGVjdGlvblJlZmVyZW5jZTxFPiwgZGVsYXk/OiBudW1iZXIpOiBRdWVyeVNuYXBzaG90PEU+XG4gIGdldFN0YXRlPEU+KHJlZjogUXVlcnk8RT4sIGRlbGF5PzogbnVtYmVyKTogUXVlcnlTbmFwc2hvdDxFPlxuICBnZXRTdGF0ZTxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+KTogU25hcHNob3Q8RT4gfCB1bmRlZmluZWRcbiAgZ2V0U3RhdGU8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPik6IFNuYXBzaG90PEU+IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoaXNRdWVyeShyZWYpKSB7XG4gICAgICBjb25zdCBrZXkgPSBzdHJpbmdpZnlRdWVyeShyZWYgYXMgYW55KTtcbiAgICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChrZXkpIGFzIFNuYXBzaG90PEU+O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXQocmVmLnBhdGgpIGFzIFNuYXBzaG90PEU+O1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgU2hvdWxkIG9ubHkgYmUgdXNlZCBieSBGaXJlQ29sbGVjdGlvbiBzZXJ2aWNlcyAqL1xuICBmcm9tTWVtb3J5PEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4sIGRlbGF5PzogbnVtYmVyKTogT2JzZXJ2YWJsZTxEb2N1bWVudFNuYXBzaG90PEU+PlxuICBmcm9tTWVtb3J5PEU+KHJlZjogQ29sbGVjdGlvblJlZmVyZW5jZTxFPiwgZGVsYXk/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFF1ZXJ5U25hcHNob3Q8RT4+XG4gIGZyb21NZW1vcnk8RT4ocmVmOiBRdWVyeTxFPiwgZGVsYXk/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFF1ZXJ5U25hcHNob3Q8RT4+XG4gIGZyb21NZW1vcnk8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPiwgZGVsYXk/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFNuYXBzaG90PEU+PlxuICBmcm9tTWVtb3J5PEU+KFxuICAgIHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4sXG4gICAgZGVsYXk/OiBudW1iZXJcbiAgKTogT2JzZXJ2YWJsZTxTbmFwc2hvdDxFPj4ge1xuICAgIGNvbnN0IGtleSA9IGlzUXVlcnkocmVmKSA/IHN0cmluZ2lmeVF1ZXJ5KHJlZiBhcyBhbnkpIDogcmVmLnBhdGg7XG4gICAgaWYgKCF0aGlzLm1lbW9yeVJlZltrZXldKSB7XG4gICAgICB0aGlzLm1lbW9yeVJlZltrZXldID0gZnJvbVJlZihyZWYgYXMgYW55KS5waXBlKHNoYXJlV2l0aERlbGF5KGRlbGF5KSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLm1lbW9yeVJlZltrZXldIGFzIE9ic2VydmFibGU8U25hcHNob3Q8RT4+O1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbCBTaG91bGQgb25seSBiZSB1c2VkIGJ5IEZpcmVDb2xsZWN0aW9uIHNlcnZpY2VzXG4gICAqIEdldCB0aGUgdHJhbnNmZXIgc3RhdGUgZm9yIGEgc3BlY2lmaWMgcmVmIGFuZCBwdXQgaXQgaW4gdGhlIG1lbW9yeSBzdGF0ZVxuICAgKiBSZW1vdmUgdGhlIHJlZmVyZW5jZSB0byB0cmFuc2ZlciBzdGF0ZSBhZnRlciBmaXJzdCBjYWxsXG4gICAqL1xuICBnZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+KTogRSB8IHVuZGVmaW5lZFxuICBnZXRUcmFuc2ZlcjxFPihyZWY6IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPik6IEVbXSB8IHVuZGVmaW5lZFxuICBnZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+KTogRVtdIHwgRSB8IHVuZGVmaW5lZFxuICBnZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+KSB7XG4gICAgaWYgKCF0aGlzLnRyYW5zZmVyU3RhdGUgfHwgIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGVmb3JtSWQpKSByZXR1cm47XG4gICAgY29uc3Qga2V5ID0gaXNRdWVyeShyZWYpID8gc3RyaW5naWZ5UXVlcnkocmVmIGFzIGFueSkgOiByZWYucGF0aDtcbiAgICBjb25zdCBzdGF0ZUtleSA9IG1ha2VTdGF0ZUtleTxFPihrZXkpO1xuICAgIGlmICghdGhpcy50cmFuc2ZlclN0YXRlLmhhc0tleShzdGF0ZUtleSkpIHJldHVybjtcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMudHJhbnNmZXJTdGF0ZS5nZXQoc3RhdGVLZXksIHVuZGVmaW5lZCk7XG4gICAgdGhpcy50cmFuc2ZlclN0YXRlLnJlbW92ZShzdGF0ZUtleSk7XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCBTaG91bGQgb25seSBiZSB1c2VkIGJ5IEZpcmVDb2xsZWN0aW9uIHNlcnZpY2VzICovXG4gIHNldFRyYW5zZmVyPEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4sIHZhbHVlPzogRSk6IHZvaWRcbiAgc2V0VHJhbnNmZXI8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPltdIHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+LCB2YWx1ZT86IEVbXSk6IHZvaWRcbiAgc2V0VHJhbnNmZXI8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IERvY3VtZW50UmVmZXJlbmNlPEU+W10gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4sIHZhbHVlPzogRSB8IEVbXSk6IHZvaWRcbiAgc2V0VHJhbnNmZXI8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IERvY3VtZW50UmVmZXJlbmNlPEU+W10gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4sIHZhbHVlPzogRSB8IEVbXSkge1xuICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICBpZiAoIXRoaXMudHJhbnNmZXJTdGF0ZSB8fCAhaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRlZm9ybUlkKSkgcmV0dXJuO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHJlZikgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJlZi5mb3JFYWNoKChyZWZlcmVuY2UsIGkpID0+IHRoaXMuc2V0VHJhbnNmZXIocmVmZXJlbmNlLCB2YWx1ZVtpXSkpO1xuICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVmKSkge1xuICAgICAgY29uc3Qga2V5ID0gaXNRdWVyeShyZWYpID8gc3RyaW5naWZ5UXVlcnkocmVmIGFzIGFueSkgOiByZWYucGF0aDtcbiAgICAgIHRoaXMudHJhbnNmZXJTdGF0ZS5zZXQobWFrZVN0YXRlS2V5PGFueT4oa2V5KSwgdmFsdWUpO1xuICAgIH1cbiAgfVxuXG5cbiAgY2xlYXJDYWNoZShwYXRoczogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeSkge1xuICAgIGlmICghcGF0aHMpIHJldHVybjtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShwYXRocykpIHtcbiAgICAgIGZvciAoY29uc3QgcGF0aCBvZiBwYXRocykge1xuICAgICAgICBkZWxldGUgdGhpcy5tZW1vcnlSZWZbcGF0aF07XG4gICAgICAgIHRoaXMuc3RhdGUuZGVsZXRlKHBhdGgpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdGhzID09PSAnc3RyaW5nJykge1xuICAgICAgZGVsZXRlIHRoaXMubWVtb3J5UmVmW3BhdGhzXTtcbiAgICAgIHRoaXMuc3RhdGUuZGVsZXRlKHBhdGhzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qga2V5ID0gc3RyaW5naWZ5UXVlcnkocGF0aHMpO1xuICAgICAgZGVsZXRlIHRoaXMubWVtb3J5UmVmW2tleV07XG4gICAgICB0aGlzLnN0YXRlLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBHZXQgdGhlIHJlZmVyZW5jZSBvZiB0aGUgZG9jdW1lbnQsIGNvbGxlY3Rpb24gb3IgcXVlcnkgKi9cbiAgcHVibGljIGdldFJlZjxFPihwYXRoOiBzdHJpbmcpOiBSZWZlcmVuY2U8RT47XG4gIHB1YmxpYyBnZXRSZWY8RT4ocGF0aHM6IHN0cmluZ1tdKTogRG9jdW1lbnRSZWZlcmVuY2U8RT5bXTtcbiAgcHVibGljIGdldFJlZjxFPihwYXRoOiBzdHJpbmcsIGNvbnN0cmFpbnRzOiBRdWVyeUNvbnN0cmFpbnRbXSk6IFF1ZXJ5PEU+O1xuICAvLyBvdmVybG9hZCB1c2VkIGludGVybmFsbHkgd2hlbiBsb29waW5nIG92ZXIgcGF0aHMgYXJyYXlcbiAgcHVibGljIGdldFJlZjxFPihcbiAgICBwYXRoczogc3RyaW5nIHwgc3RyaW5nW10sXG4gICAgY29uc3RyYWludHM/OiBRdWVyeUNvbnN0cmFpbnRbXSxcbiAgKTogdW5kZWZpbmVkIHwgUXVlcnk8RT4gfCBRdWVyeTxFPltdIHwgUmVmZXJlbmNlPEU+IHwgRG9jdW1lbnRSZWZlcmVuY2U8RT5bXSB7XG4gICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoIHx8ICFwYXRocykgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIC8vIEFycmF5IG9mIGRvY3NcbiAgICBpZiAoQXJyYXkuaXNBcnJheShwYXRocykpIHtcbiAgICAgIHJldHVybiBwYXRocy5tYXAoKHBhdGgpID0+IHRoaXMuZ2V0UmVmPEU+KHBhdGgpIGFzIERvY3VtZW50UmVmZXJlbmNlPEU+KTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNDb250cmFpbnRzID0gQXJyYXkuaXNBcnJheShjb25zdHJhaW50cyk7XG4gICAgaWYgKGhhc0NvbnRyYWludHMpIHtcbiAgICAgIGFzc2VydFBhdGgocGF0aHMpO1xuICAgICAgYXNzZXJ0Q29sbGVjdGlvbihwYXRocyk7XG4gICAgICBjb25zdCByZWYgPSBjb2xsZWN0aW9uKHRoaXMuZGIsIHBhdGhzKSBhcyBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+O1xuICAgICAgcmV0dXJuIHF1ZXJ5KHJlZiwgLi4uY29uc3RyYWludHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhc3NlcnRQYXRoKHBhdGhzKTtcbiAgICAgIGlmIChpc0RvY1BhdGgocGF0aHMpKSByZXR1cm4gZG9jKHRoaXMuZGIsIHBhdGhzKSBhcyBEb2N1bWVudFJlZmVyZW5jZTxFPjtcbiAgICAgIHJldHVybiBjb2xsZWN0aW9uKHRoaXMuZGIsIHBhdGhzKSBhcyBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+O1xuICAgIH1cbiAgfVxuXG4gIGJhdGNoKCkge1xuICAgIHJldHVybiB3cml0ZUJhdGNoKHRoaXMuZGIpO1xuICB9XG5cbiAgcnVuVHJhbnNhY3Rpb248VD4oY2I6ICh0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pID0+IFByb21pc2U8VD4pIHtcbiAgICByZXR1cm4gcnVuVHJhbnNhY3Rpb248VD4odGhpcy5kYiwgKHR4KSA9PiBjYih0eCkpO1xuICB9XG5cbiAgY3JlYXRlSWQoKSB7XG4gICAgcmV0dXJuIGRvYyhjb2xsZWN0aW9uKHRoaXMuZGIsICdfXycpKS5pZDtcbiAgfVxuXG59Il19
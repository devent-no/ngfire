import { exist } from 'ngfire/core';
// Simplfied version of 
// https://github.com/firebase/firebase-js-sdk/blob/master/packages/firestore/src/core/query.ts#L442
export function stringifyQuery(query) {
    if ('_query' in query) {
        const target = query['_query'];
        return `${stringifyTarget(target)}|lt:${target.limitType})`;
    }
    return '';
}
function stringifyTarget(target) {
    if (!target.orderBy)
        target.orderBy = [];
    let str = target.path.canonicalString();
    if (target.collectionGroup !== null) {
        str += '|cg:' + target.collectionGroup;
    }
    if (target.filters.length > 0) {
        const fields = target.filters
            .map((f) => stringifyFilter(f))
            .join(', ');
        str += `|f:[${fields}]`;
    }
    if (exist(target.limit)) {
        str += '|l:' + target.limit;
    }
    if (target.orderBy.length > 0) {
        const order = target.orderBy
            .map((o) => stringifyOrderBy(o))
            .join(', ');
        str += `|ob:[${order}]`;
    }
    if (target.startAt) {
        str += '|lb:';
        str += target.startAt.inclusive ? 'b:' : 'a:';
        str += target.startAt.position.map((p) => canonifyValue(p)).join(',');
    }
    if (target.endAt) {
        str += '|ub:';
        str += target.endAt.inclusive ? 'a:' : 'b:';
        str += target.endAt.position.map((p) => canonifyValue(p)).join(',');
    }
    return str;
}
/** Returns a debug description for `filter`. */
export function stringifyFilter(filter) {
    return `${filter.field.canonicalString()} ${filter.op} ${canonifyValue(filter.value)}`;
}
export function stringifyOrderBy(orderBy) {
    return `${orderBy.field.canonicalString()} (${orderBy.dir})`;
}
/* eslint-disable */
function canonifyValue(value) {
    if ('nullValue' in value) {
        return 'null';
    }
    else if ('booleanValue' in value) {
        return '' + value.booleanValue;
    }
    else if ('integerValue' in value) {
        return '' + value.integerValue;
    }
    else if ('doubleValue' in value) {
        return '' + value.doubleValue;
    }
    else if ('timestampValue' in value) {
        return canonifyTimestamp(value.timestampValue);
    }
    else if ('stringValue' in value) {
        return value.stringValue;
    }
    else if ('bytesValue' in value) {
        return canonifyByteString(value.bytesValue);
    }
    else if ('referenceValue' in value) {
        return value.referenceValue;
    }
    else if ('geoPointValue' in value) {
        return canonifyGeoPoint(value.geoPointValue);
    }
    else if ('arrayValue' in value) {
        return canonifyArray(value.arrayValue);
    }
    else if ('mapValue' in value) {
        return canonifyMap(value.mapValue);
    }
    else {
        throw new Error('Invalid value type: ' + JSON.stringify(value));
    }
}
/* eslint-enable */
function canonifyByteString(byteString) {
    if (typeof byteString === 'string')
        return byteString;
    return byteString.toString();
}
function canonifyTimestamp(timestamp) {
    return `time(${timestamp.toString()})`;
}
function canonifyGeoPoint(geoPoint) {
    return `geo(${geoPoint.latitude},${geoPoint.longitude})`;
}
function canonifyMap(mapValue) {
    // Iteration order in JavaScript is not guaranteed. To ensure that we generate
    // matching canonical IDs for identical maps, we need to sort the keys.
    const sortedKeys = Object.keys(mapValue.fields || {}).sort();
    // eslint-disable-next-line
    const content = sortedKeys.map(key => `${key}:${canonifyValue(mapValue.fields[key])}`).join(',');
    return `{${content}}`;
}
function canonifyArray(arrayValue) {
    const values = arrayValue.values || [];
    return `[${values.map(canonifyValue).join(',')}]`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25nZmlyZS9maXJlc3RvcmUvc3JjL3F1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVVBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHcEMsd0JBQXdCO0FBQ3hCLG9HQUFvRztBQUNwRyxNQUFNLFVBQVUsY0FBYyxDQUFDLEtBQVk7SUFDekMsSUFBSSxRQUFRLElBQUksS0FBSyxFQUFFLENBQUM7UUFDdEIsTUFBTSxNQUFNLEdBQUksS0FBYSxDQUFDLFFBQVEsQ0FBbUMsQ0FBQztRQUMxRSxPQUFPLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLE1BQU0sQ0FBQyxTQUFTLEdBQUcsQ0FBQztJQUM5RCxDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBYztJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU87UUFBRyxNQUFjLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUNsRCxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3hDLElBQUksTUFBTSxDQUFDLGVBQWUsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwQyxHQUFHLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUM7SUFDekMsQ0FBQztJQUNELElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDOUIsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU87YUFDNUIsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBZ0IsQ0FBQyxDQUFDO2FBQ2xELElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNaLEdBQUcsSUFBSSxPQUFPLE1BQU0sR0FBRyxDQUFDO0lBQzFC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SUFDckMsOEVBQThFO0lBQzlFLHVFQUF1RTtJQUN2RSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDN0QsMkJBQTJCO0lBQzNCLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEcsT0FBTyxJQUFJLE9BQU8sR0FBRyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxVQUFzQjtJQUMzQyxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQztJQUN2QyxPQUFPLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUNwRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTm90ZTogVGhlc2UgdHlwZXMgYXJlIGludGVybmFsIHRvIEZpcmViYXNlIGFuZCBtYXkgY2hhbmdlLiBDb25zaWRlciBhbHRlcm5hdGl2ZSBhcHByb2FjaGVzLlxudHlwZSBUYXJnZXQgPSBhbnk7XG50eXBlIE9yZGVyQnkgPSBhbnk7XG50eXBlIEZpZWxkRmlsdGVyID0gYW55O1xudHlwZSBWYWx1ZSA9IGFueTtcbnR5cGUgQXJyYXlWYWx1ZSA9IGFueTtcbnR5cGUgTWFwVmFsdWUgPSBhbnk7XG50eXBlIFRpbWVzdGFtcCA9IGFueTtcbnR5cGUgTGF0TG5nID0gYW55O1xuaW1wb3J0IHR5cGUgeyBRdWVyeSB9IGZyb20gJ2ZpcmViYXNlL2ZpcmVzdG9yZSc7XG5pbXBvcnQgeyBleGlzdCB9IGZyb20gJ25nZmlyZS9jb3JlJztcblxuXG4vLyBTaW1wbGZpZWQgdmVyc2lvbiBvZiBcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9maXJlYmFzZS9maXJlYmFzZS1qcy1zZGsvYmxvYi9tYXN0ZXIvcGFja2FnZXMvZmlyZXN0b3JlL3NyYy9jb3JlL3F1ZXJ5LnRzI0w0NDJcbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnlRdWVyeShxdWVyeTogUXVlcnkpIHtcbiAgaWYgKCdfcXVlcnknIGluIHF1ZXJ5KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gKHF1ZXJ5IGFzIGFueSlbJ19xdWVyeSddIGFzIFRhcmdldCAmIHsgbGltaXRUeXBlOiBzdHJpbmcgfTtcbiAgICByZXR1cm4gYCR7c3RyaW5naWZ5VGFyZ2V0KHRhcmdldCl9fGx0OiR7dGFyZ2V0LmxpbWl0VHlwZX0pYDtcbiAgfVxuICByZXR1cm4gJyc7XG59XG5cbmZ1bmN0aW9uIHN0cmluZ2lmeVRhcmdldCh0YXJnZXQ6IFRhcmdldCk6IHN0cmluZyB7XG4gIGlmICghdGFyZ2V0Lm9yZGVyQnkpICh0YXJnZXQgYXMgYW55KS5vcmRlckJ5ID0gW107XG4gIGxldCBzdHIgPSB0YXJnZXQucGF0aC5jYW5vbmljYWxTdHJpbmcoKTtcbiAgaWYgKHRhcmdldC5jb2xsZWN0aW9uR3JvdXAgIT09IG51bGwpIHtcbiAgICBzdHIgKz0gJ3xjZzonICsgdGFyZ2V0LmNvbGxlY3Rpb25Hcm91cDtcbiAgfVxuICBpZiAodGFyZ2V0LmZpbHRlcnMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGZpZWxkcyA9IHRhcmdldC5maWx0ZXJzXG4gICAgLm1hcCgoZjogYW55KSA9PiBzdHJpbmdpZnlGaWx0ZXIoZiBhcyBGaWVsZEZpbHRlcikpXG4gICAgLmpvaW4oJywgJyk7XG4gICAgc3RyICs9IGB8ZjpbJHtmaWVsZHN9XWA7XG4gIH1cbiAgaWYgKGV4aXN0KHRhcmdldC5saW1pdCkpIHtcbiAgICBzdHIgKz0gJ3xsOicgKyB0YXJnZXQubGltaXQ7XG4gIH1cbiAgaWYgKHRhcmdldC5vcmRlckJ5Lmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBvcmRlciA9IHRhcmdldC5vcmRlckJ5XG4gICAgLm1hcCgobzogYW55KSA9PiBzdHJpbmdpZnlPcmRlckJ5KG8pKVxuICAgIC5qb2luKCcsICcpO1xuICAgIHN0ciArPSBgfG9iOlske29yZGVyfV1gO1xuICB9XG4gIGlmICh0YXJnZXQuc3RhcnRBdCkge1xuICAgIHN0ciArPSAnfGxiOic7XG4gICAgc3RyICs9IHRhcmdldC5zdGFydEF0LmluY2x1c2l2ZSA/ICdiOicgOiAnYTonO1xuICAgIHN0ciArPSB0YXJnZXQuc3RhcnRBdC5wb3NpdGlvbi5tYXAoKHA6IGFueSkgPT4gY2Fub25pZnlWYWx1ZShwKSkuam9pbignLCcpO1xuICB9XG4gIGlmICh0YXJnZXQuZW5kQXQpIHtcbiAgICBzdHIgKz0gJ3x1YjonO1xuICAgIHN0ciArPSB0YXJnZXQuZW5kQXQuaW5jbHVzaXZlID8gJ2E6JyA6ICdiOic7XG4gICAgc3RyICs9IHRhcmdldC5lbmRBdC5wb3NpdGlvbi5tYXAoKHA6IGFueSkgPT4gY2Fub25pZnlWYWx1ZShwKSkuam9pbignLCcpO1xuICB9XG4gIHJldHVybiBzdHI7XG59XG5cbi8qKiBSZXR1cm5zIGEgZGVidWcgZGVzY3JpcHRpb24gZm9yIGBmaWx0ZXJgLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ2lmeUZpbHRlcihmaWx0ZXI6IEZpZWxkRmlsdGVyKTogc3RyaW5nIHtcbiAgcmV0dXJuIGAke2ZpbHRlci5maWVsZC5jYW5vbmljYWxTdHJpbmcoKX0gJHtmaWx0ZXIub3B9ICR7Y2Fub25pZnlWYWx1ZShmaWx0ZXIudmFsdWUpfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnlPcmRlckJ5KG9yZGVyQnk6IE9yZGVyQnkpOiBzdHJpbmcge1xuICByZXR1cm4gYCR7b3JkZXJCeS5maWVsZC5jYW5vbmljYWxTdHJpbmcoKX0gKCR7b3JkZXJCeS5kaXJ9KWA7XG59XG5cbi8qIGVzbGludC1kaXNhYmxlICovXG5mdW5jdGlvbiBjYW5vbmlmeVZhbHVlKHZhbHVlOiBWYWx1ZSk6IHN0cmluZyB7XG4gIGlmICgnbnVsbFZhbHVlJyBpbiB2YWx1ZSkge1xuICAgIHJldHVybiAnbnVsbCc7XG4gIH0gZWxzZSBpZiAoJ2Jvb2xlYW5WYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gJycgKyB2YWx1ZS5ib29sZWFuVmFsdWU7XG4gIH0gZWxzZSBpZiAoJ2ludGVnZXJWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gJycgKyB2YWx1ZS5pbnRlZ2VyVmFsdWU7XG4gIH0gZWxzZSBpZiAoJ2RvdWJsZVZhbHVlJyBpbiB2YWx1ZSkge1xuICAgIHJldHVybiAnJyArIHZhbHVlLmRvdWJsZVZhbHVlO1xuICB9IGVsc2UgaWYgKCd0aW1lc3RhbXBWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gY2Fub25pZnlUaW1lc3RhbXAodmFsdWUudGltZXN0YW1wVmFsdWUhKTtcbiAgfSBlbHNlIGlmICgnc3RyaW5nVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIHZhbHVlLnN0cmluZ1ZhbHVlITtcbiAgfSBlbHNlIGlmICgnYnl0ZXNWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gY2Fub25pZnlCeXRlU3RyaW5nKHZhbHVlLmJ5dGVzVmFsdWUhKTtcbiAgfSBlbHNlIGlmICgncmVmZXJlbmNlVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIHZhbHVlLnJlZmVyZW5jZVZhbHVlITtcbiAgfSBlbHNlIGlmICgnZ2VvUG9pbnRWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gY2Fub25pZnlHZW9Qb2ludCh2YWx1ZS5nZW9Qb2ludFZhbHVlISk7XG4gIH0gZWxzZSBpZiAoJ2FycmF5VmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNhbm9uaWZ5QXJyYXkodmFsdWUuYXJyYXlWYWx1ZSEpO1xuICB9IGVsc2UgaWYgKCdtYXBWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gY2Fub25pZnlNYXAodmFsdWUubWFwVmFsdWUhKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgdmFsdWUgdHlwZTogJyArIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7XG4gIH1cbn1cbi8qIGVzbGludC1lbmFibGUgKi9cblxuXG5mdW5jdGlvbiBjYW5vbmlmeUJ5dGVTdHJpbmcoYnl0ZVN0cmluZzogc3RyaW5nIHwgVWludDhBcnJheSk6IHN0cmluZyB7XG4gIGlmICh0eXBlb2YgYnl0ZVN0cmluZyA9PT0gJ3N0cmluZycpIHJldHVybiBieXRlU3RyaW5nO1xuICByZXR1cm4gYnl0ZVN0cmluZy50b1N0cmluZygpO1xufVxuXG5cblxuZnVuY3Rpb24gY2Fub25pZnlUaW1lc3RhbXAodGltZXN0YW1wOiBUaW1lc3RhbXApOiBzdHJpbmcge1xuICByZXR1cm4gYHRpbWUoJHt0aW1lc3RhbXAudG9TdHJpbmcoKX0pYDtcbn1cblxuZnVuY3Rpb24gY2Fub25pZnlHZW9Qb2ludChnZW9Qb2ludDogTGF0TG5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGBnZW8oJHtnZW9Qb2ludC5sYXRpdHVkZX0sJHtnZW9Qb2ludC5sb25naXR1ZGV9KWA7XG59XG5cbmZ1bmN0aW9uIGNhbm9uaWZ5TWFwKG1hcFZhbHVlOiBNYXBWYWx1ZSk6IHN0cmluZyB7XG4gIC8vIEl0ZXJhdGlvbiBvcmRlciBpbiBKYXZhU2NyaXB0IGlzIG5vdCBndWFyYW50ZWVkLiBUbyBlbnN1cmUgdGhhdCB3ZSBnZW5lcmF0ZVxuICAvLyBtYXRjaGluZyBjYW5vbmljYWwgSURzIGZvciBpZGVudGljYWwgbWFwcywgd2UgbmVlZCB0byBzb3J0IHRoZSBrZXlzLlxuICBjb25zdCBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMobWFwVmFsdWUuZmllbGRzIHx8IHt9KS5zb3J0KCk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICBjb25zdCBjb250ZW50ID0gc29ydGVkS2V5cy5tYXAoa2V5ID0+IGAke2tleX06JHtjYW5vbmlmeVZhbHVlKG1hcFZhbHVlLmZpZWxkcyFba2V5XSl9YCkuam9pbignLCcpO1xuICByZXR1cm4gYHske2NvbnRlbnR9fWA7XG59XG5cbmZ1bmN0aW9uIGNhbm9uaWZ5QXJyYXkoYXJyYXlWYWx1ZTogQXJyYXlWYWx1ZSk6IHN0cmluZyB7XG4gIGNvbnN0IHZhbHVlcyA9IGFycmF5VmFsdWUudmFsdWVzIHx8IFtdO1xuICByZXR1cm4gYFske3ZhbHVlcy5tYXAoY2Fub25pZnlWYWx1ZSkuam9pbignLCcpfV1gO1xufVxuIl19
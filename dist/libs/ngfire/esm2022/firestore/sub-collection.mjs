import { isPlatformServer } from "@angular/common";
import { collectionGroup, query } from "firebase/firestore";
import { keepUnstableUntilFirst, isIdList } from 'ngfire/core';
import { FireCollection } from "./collection";
import { toDate } from "./utils";
import { firstValueFrom, from, of } from "rxjs";
export class FireSubCollection extends FireCollection {
    constructor() {
        super(...arguments);
        this.pathKey = 'path';
    }
    get groupId() {
        return this.path.split('/').pop();
    }
    /** Function triggered when getting data from firestore */
    fromFirestore(snapshot) {
        if (snapshot.exists()) {
            return {
                ...toDate(snapshot.data()),
                [this.idKey]: snapshot.id,
                [this.pathKey]: snapshot.ref.path
            };
        }
        else {
            return undefined;
        }
    }
    getGroupRef(constraints) {
        const group = collectionGroup(this.db, this.groupId);
        if (!arguments.length)
            return group;
        if (!constraints)
            return;
        return query(group, ...constraints);
    }
    /** Observable the content of group reference(s)  */
    fromGroupRef(ref) {
        if (isPlatformServer(this.platformId)) {
            return this.zone.runOutsideAngular(() => from(this.getFromRef(ref))).pipe(keepUnstableUntilFirst(this.zone));
        }
        return this.useCache(ref);
    }
    async getValue(idOrQuery, params) {
        // If array is empty
        if (Array.isArray(idOrQuery) && !idOrQuery.length)
            return [];
        // Group query
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        // Collection Query
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return;
        return this.getFromRef(ref);
    }
    async reload(idOrQuery, params) {
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return;
        if (this.memorize) {
            Array.isArray(ref)
                ? ref.forEach(r => this.clearCache(r))
                : this.clearCache(ref);
        }
        return this.load(...arguments);
    }
    load() {
        return firstValueFrom(this.valueChanges(...arguments));
    }
    valueChanges(idOrQuery, params) {
        // If array is empty
        if (Array.isArray(idOrQuery) && !idOrQuery.length)
            return of([]);
        // Check if group query
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        // Group or Collection Query
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return of(undefined);
        return this.fromRef(ref);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLWNvbGxlY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25nZmlyZS9maXJlc3RvcmUvc3JjL3N1Yi1jb2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFNUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFFBQVEsRUFBVSxNQUFNLGFBQWEsQ0FBQztBQUN2RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDakMsT0FBTyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzVELE1BQU0sT0FBZ0IsaUJBQTBDLFNBQVEsY0FBaUI7SUFBekY7O1FBRVksWUFBTyxHQUFHLE1BQU0sQ0FBQztJQStIN0IsQ0FBQztJQTdIQyxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBWSxDQUFDO0lBQzlDLENBQUM7SUFFRCwwREFBMEQ7SUFDaEQsYUFBYSxDQUFDLFFBQXdEO1FBQzlFLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7WUFDdEIsT0FBTztnQkFDTCxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzFCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUFFO2dCQUN6QixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUk7YUFDbEMsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lB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QU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFZTSxJQUFJO1FBQ1QsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQVdNLFlBQVksQ0FDakIsU0FBMEQsRUFDMUQsTUFBZTtRQUVmLG9CQUFvQjtRQUNwQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTTtZQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWpFLHVCQUF1QjtRQUN2QixNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztRQUN2QyxNQUFNLFlBQVksR0FBRyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWhHLDRCQUE0QjtRQUM1QixNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQU8sSUFBSSxZQUFZLENBQUM7WUFDbkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUksR0FBRyxTQUFTLENBQUM7WUFDbkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUksR0FBRyxTQUFTLENBQUMsQ0FBQztRQUVqQyxJQUFJLENBQUMsR0FBRztZQUFFLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vblwiO1xuaW1wb3J0IHsgY29sbGVjdGlvbkdyb3VwLCBxdWVyeSB9IGZyb20gXCJmaXJlYmFzZS9maXJlc3RvcmVcIjtcbmltcG9ydCB0eXBlIHsgUXVlcnlEb2N1bWVudFNuYXBzaG90LCBEb2N1bWVudFNuYXBzaG90LCBRdWVyeSwgUXVlcnlDb25zdHJhaW50LCBEb2N1bWVudERhdGEgfSBmcm9tICdmaXJlYmFzZS9maXJlc3RvcmUnO1xuaW1wb3J0IHsga2VlcFVuc3RhYmxlVW50aWxGaXJzdCwgaXNJZExpc3QsIFBhcmFtcyB9IGZyb20gJ25nZmlyZS9jb3JlJztcbmltcG9ydCB7IEZpcmVDb2xsZWN0aW9uIH0gZnJvbSBcIi4vY29sbGVjdGlvblwiO1xuaW1wb3J0IHsgdG9EYXRlIH0gZnJvbSBcIi4vdXRpbHNcIjtcbmltcG9ydCB7IGZpcnN0VmFsdWVGcm9tLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEZpcmVTdWJDb2xsZWN0aW9uPEUgZXh0ZW5kcyBEb2N1bWVudERhdGE+IGV4dGVuZHMgRmlyZUNvbGxlY3Rpb248RT4ge1xuICBhYnN0cmFjdCBwYXRoOiBzdHJpbmc7XG4gIHByb3RlY3RlZCBwYXRoS2V5ID0gJ3BhdGgnO1xuICBcbiAgZ2V0IGdyb3VwSWQoKSB7XG4gICAgcmV0dXJuIHRoaXMucGF0aC5zcGxpdCgnLycpLnBvcCgpIGFzIHN0cmluZztcbiAgfVxuXG4gIC8qKiBGdW5jdGlvbiB0cmlnZ2VyZWQgd2hlbiBnZXR0aW5nIGRhdGEgZnJvbSBmaXJlc3RvcmUgKi9cbiAgcHJvdGVjdGVkIGZyb21GaXJlc3RvcmUoc25hcHNob3Q6IERvY3VtZW50U25hcHNob3Q8RT4gfCBRdWVyeURvY3VtZW50U25hcHNob3Q8RT4pOiBFIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc25hcHNob3QuZXhpc3RzKCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnRvRGF0ZShzbmFwc2hvdC5kYXRhKCkpLFxuICAgICAgICBbdGhpcy5pZEtleV06IHNuYXBzaG90LmlkLFxuICAgICAgICBbdGhpcy5wYXRoS2V5XTogc25hcHNob3QucmVmLnBhdGhcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldEdyb3VwUmVmPFQgZXh0ZW5kcyBFID0gRT4oY29uc3RyYWludHM/OiBRdWVyeUNvbnN0cmFpbnRbXSk6IFF1ZXJ5PFQ+IHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBncm91cCA9IGNvbGxlY3Rpb25Hcm91cCh0aGlzLmRiLCB0aGlzLmdyb3VwSWQpIGFzIFF1ZXJ5PFQ+O1xuICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGdyb3VwO1xuICAgIGlmICghY29uc3RyYWludHMpIHJldHVybjtcbiAgICByZXR1cm4gcXVlcnkoZ3JvdXAsIC4uLmNvbnN0cmFpbnRzKTtcbiAgfVxuXG4gIC8qKiBPYnNlcnZhYmxlIHRoZSBjb250ZW50IG9mIGdyb3VwIHJlZmVyZW5jZShzKSAgKi9cbiAgcHJvdGVjdGVkIGZyb21Hcm91cFJlZjxUIGV4dGVuZHMgRSA9IEU+KHJlZjogUXVlcnk8VD4pOiBPYnNlcnZhYmxlPFRbXT4ge1xuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gZnJvbSh0aGlzLmdldEZyb21SZWYocmVmKSkpLnBpcGUoXG4gICAgICAgIGtlZXBVbnN0YWJsZVVudGlsRmlyc3QodGhpcy56b25lKSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVzZUNhY2hlKHJlZik7XG4gIH1cblxuXG4gIC8qKiBSZXR1cm4gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIHBhdGggZnJvbSBGaXJlc3RvcmUgKi9cbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oaWRzPzogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4ocGFyYW1zOiBQYXJhbXMpOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5PzogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcgfCBudWxsLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+O1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihcbiAgICBpZE9yUXVlcnk/OiBudWxsIHwgc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcyxcbiAgICBwYXJhbXM/OiBQYXJhbXNcbiAgKTogUHJvbWlzZTxUIHwgVFtdIHwgdW5kZWZpbmVkPiB7XG4gICAgLy8gSWYgYXJyYXkgaXMgZW1wdHlcbiAgICBpZiAoQXJyYXkuaXNBcnJheShpZE9yUXVlcnkpICYmICFpZE9yUXVlcnkubGVuZ3RoKSByZXR1cm4gW107XG5cbiAgICAvLyBHcm91cCBxdWVyeVxuICAgIGNvbnN0IGlzRW1wdHkgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwO1xuICAgIGNvbnN0IGlzR3JvdXBRdWVyeSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShpZE9yUXVlcnkpICYmICFpc0lkTGlzdChpZE9yUXVlcnkpO1xuXG4gICAgLy8gQ29sbGVjdGlvbiBRdWVyeVxuICAgIGNvbnN0IHJlZiA9IChpc0VtcHR5IHx8IGlzR3JvdXBRdWVyeSlcbiAgICAgID8gdGhpcy5nZXRHcm91cFJlZjxUPiguLi5hcmd1bWVudHMpXG4gICAgICA6IHRoaXMuZ2V0UmVmPFQ+KC4uLmFyZ3VtZW50cyk7XG4gICAgaWYgKCFyZWYpIHJldHVybjtcbiAgICByZXR1cm4gdGhpcy5nZXRGcm9tUmVmKHJlZik7XG4gIH1cblxuICAvKiogQ2xlYXIgY2FjaGUgYW5kIGdldCB0aGUgbGF0ZXN0IHZhbHVlIGludG8gdGhlIGNhY2hlICovXG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihpZHM/OiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgYXN5bmMgcmVsb2FkPFQgZXh0ZW5kcyBFID0gRT4ocGFyYW1zOiBQYXJhbXMpOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihpZD86IHN0cmluZyB8IG51bGwsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD47XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihcbiAgICBpZE9yUXVlcnk/OiBudWxsIHwgc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcyxcbiAgICBwYXJhbXM/OiBQYXJhbXNcbiAgKTogUHJvbWlzZTxUIHwgVFtdIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgaXNFbXB0eSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDA7XG4gICAgY29uc3QgaXNHcm91cFF1ZXJ5ID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiBBcnJheS5pc0FycmF5KGlkT3JRdWVyeSkgJiYgIWlzSWRMaXN0KGlkT3JRdWVyeSk7XG4gICAgY29uc3QgcmVmID0gKGlzRW1wdHkgfHwgaXNHcm91cFF1ZXJ5KVxuICAgICAgPyB0aGlzLmdldEdyb3VwUmVmKC4uLmFyZ3VtZW50cylcbiAgICAgIDogdGhpcy5nZXRSZWYoLi4uYXJndW1lbnRzKTtcbiAgICBpZiAoIXJlZikgcmV0dXJuO1xuICAgIGlmICh0aGlzLm1lbW9yaXplKSB7XG4gICAgICBBcnJheS5pc0FycmF5KHJlZilcbiAgICAgICAgPyByZWYuZm9yRWFjaChyID0+IHRoaXMuY2xlYXJDYWNoZShyKSlcbiAgICAgICAgOiB0aGlzLmNsZWFyQ2FjaGUocmVmKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubG9hZCguLi5hcmd1bWVudHMpO1xuICB9XG4gIFxuXG4gIC8qKiBHZXQgdGhlIGxhc3QgY29udGVudCBmcm9tIHRoZSBhcHAgKGlmIHZhbHVlIGhhcyBiZWVuIGNhY2hlZCwgaXQgd29uJ3QgZG8gYSBzZXJ2ZXIgcmVxdWVzdCkgICovXG4gIHB1YmxpYyBsb2FkPFQgZXh0ZW5kcyBFID0gRT4oaWRzPzogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBsb2FkPFQgZXh0ZW5kcyBFID0gRT4oaWQ/OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD47XG4gIHB1YmxpYyBsb2FkPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgaWRPclF1ZXJ5Pzogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcyxcbiAgICBwYXJhbXM/OiBQYXJhbXNcbiAgKTogUHJvbWlzZTxUIHwgVFtdIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPigpOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gZmlyc3RWYWx1ZUZyb20odGhpcy52YWx1ZUNoYW5nZXMoLi4uYXJndW1lbnRzKSk7XG4gIH1cblxuICAvKiogUmV0dXJuIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBwYXRoIGZyb20gRmlyZXN0b3JlICovXG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihpZHM/OiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxUW10+O1xuICBwdWJsaWMgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4ocGFyYW1zOiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT47XG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT47XG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihpZD86IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsXG4gICAgcGFyYW1zPzogUGFyYW1zXG4gICk6IE9ic2VydmFibGU8VCB8IFRbXSB8IHVuZGVmaW5lZD47XG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihcbiAgICBpZE9yUXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLFxuICAgIHBhcmFtcz86IFBhcmFtc1xuICApOiBPYnNlcnZhYmxlPFQgfCBUW10gfCB1bmRlZmluZWQ+IHtcbiAgICAvLyBJZiBhcnJheSBpcyBlbXB0eVxuICAgIGlmIChBcnJheS5pc0FycmF5KGlkT3JRdWVyeSkgJiYgIWlkT3JRdWVyeS5sZW5ndGgpIHJldHVybiBvZihbXSk7XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgZ3JvdXAgcXVlcnlcbiAgICBjb25zdCBpc0VtcHR5ID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMDtcbiAgICBjb25zdCBpc0dyb3VwUXVlcnkgPSBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIEFycmF5LmlzQXJyYXkoaWRPclF1ZXJ5KSAmJiAhaXNJZExpc3QoaWRPclF1ZXJ5KTtcblxuICAgIC8vIEdyb3VwIG9yIENvbGxlY3Rpb24gUXVlcnlcbiAgICBjb25zdCByZWYgPSAoaXNFbXB0eSB8fCBpc0dyb3VwUXVlcnkpXG4gICAgICA/IHRoaXMuZ2V0R3JvdXBSZWY8VD4oLi4uYXJndW1lbnRzKVxuICAgICAgOiB0aGlzLmdldFJlZjxUPiguLi5hcmd1bWVudHMpO1xuXG4gICAgaWYgKCFyZWYpIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgIHJldHVybiB0aGlzLmZyb21SZWYocmVmKTtcbiAgfVxuXG59Il19
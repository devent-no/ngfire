import { inject, Injectable, InjectFlags, Injector, PLATFORM_ID } from "@angular/core";
import { makeStateKey, TransferState } from "@angular/platform-browser";
import { collection, doc, query, runTransaction, writeBatch } from 'firebase/firestore';
import { FIRESTORE } from "./tokens";
import { shareWithDelay, assertCollection, assertPath, isCollectionRef, isDocPath, isQuery } from "ngfire/core";
import { fromRef } from "./operators";
import { isPlatformBrowser, isPlatformServer } from "@angular/common";
import { stringifyQuery } from "./query";
import * as i0 from "@angular/core";
export class FirestoreService {
    constructor() {
        this.memoryRef = {};
        this.injector = inject(Injector);
        this.plateformId = inject(PLATFORM_ID);
        /** Transfer state between server and  */
        this.transferState = inject(TransferState, InjectFlags.Optional);
        /** Cache based state for document */
        this.state = new Map();
    }
    get db() {
        return this.injector.get(FIRESTORE);
    }
    /** @internal Should only be used by FireCollection services */
    setState(ref, snap) {
        if (isCollectionRef(ref)) {
            snap.forEach(doc => this.state.set(doc.ref.path, doc));
            this.state.set(ref.path, snap);
        }
        else if (isQuery(ref)) {
            snap.forEach(doc => this.state.set(doc.ref.path, doc));
            const key = stringifyQuery(ref);
            this.state.set(key, snap);
        }
        else {
            this.state.set(ref.path, snap);
        }
    }
    getState(ref) {
        if (isQuery(ref)) {
            const key = stringifyQuery(ref);
            return this.state.get(key);
        }
        else {
            return this.state.get(ref.path);
        }
    }
    fromMemory(ref, delay) {
        const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
        if (!this.memoryRef[key]) {
            this.memoryRef[key] = fromRef(ref).pipe(shareWithDelay(delay));
        }
        return this.memoryRef[key];
    }
    getTransfer(ref) {
        if (!this.transferState || !isPlatformBrowser(this.plateformId))
            return;
        const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
        const stateKey = makeStateKey(key);
        if (!this.transferState.hasKey(stateKey))
            return;
        const value = this.transferState.get(stateKey, undefined);
        this.transferState.remove(stateKey);
        return value;
    }
    setTransfer(ref, value) {
        if (!value)
            return;
        if (!this.transferState || !isPlatformServer(this.plateformId))
            return;
        if (Array.isArray(ref) && Array.isArray(value)) {
            ref.forEach((reference, i) => this.setTransfer(reference, value[i]));
        }
        else if (!Array.isArray(ref)) {
            const key = isQuery(ref) ? stringifyQuery(ref) : ref.path;
            this.transferState.set(makeStateKey(key), value);
        }
    }
    clearCache(paths) {
        if (!paths)
            return;
        if (Array.isArray(paths)) {
            for (const path of paths) {
                delete this.memoryRef[path];
                this.state.delete(path);
            }
        }
        else if (typeof paths === 'string') {
            delete this.memoryRef[paths];
            this.state.delete(paths);
        }
        else {
            const key = stringifyQuery(paths);
            delete this.memoryRef[key];
            this.state.delete(key);
        }
    }
    // overload used internally when looping over paths array
    getRef(paths, constraints) {
        if (!arguments.length || !paths)
            return undefined;
        // Array of docs
        if (Array.isArray(paths)) {
            return paths.map((path) => this.getRef(path));
        }
        const hasContraints = Array.isArray(constraints);
        if (hasContraints) {
            assertPath(paths);
            assertCollection(paths);
            const ref = collection(this.db, paths);
            return query(ref, ...constraints);
        }
        else {
            assertPath(paths);
            if (isDocPath(paths))
                return doc(this.db, paths);
            return collection(this.db, paths);
        }
    }
    batch() {
        return writeBatch(this.db);
    }
    runTransaction(cb) {
        return runTransaction(this.db, (tx) => cb(tx));
    }
    createId() {
        return doc(collection(this.db, '__')).id;
    }
}
FirestoreService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.10", ngImport: i0, type: FirestoreService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
FirestoreService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.10", ngImport: i0, type: FirestoreService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.10", ngImport: i0, type: FirestoreService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlyZXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ2ZpcmUvZmlyZXN0b3JlL3NyYy9maXJlc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkYsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBa0MsS0FBSyxFQUE2QixjQUFjLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFbkosT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoSCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXRFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxTQUFTLENBQUM7O0FBTXpDLE1BQU0sT0FBTyxnQkFBZ0I7SUFEN0I7UUFFVSxjQUFTLEdBQXlDLEVBQUUsQ0FBQztRQUNyRCxhQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVCLGdCQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzFDLHlDQUF5QztRQUNqQyxrQkFBYSxHQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BFLHFDQUFxQztRQUM3QixVQUFLLEdBQTJDLElBQUksR0FBRyxFQUFFLENBQUM7S0Fn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QUFFLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUF5QixDQUFDO1lBQ3pFLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUEyQixDQUFDO1NBQzdEO0lBQ0gsQ0FBQztJQUVELEtBQUs7UUFDSCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELGNBQWMsQ0FBSSxFQUE0QztRQUM1RCxPQUFPLGNBQWMsQ0FBSSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzNDLENBQUM7OzhHQXJKVSxnQkFBZ0I7a0hBQWhCLGdCQUFnQixjQURILE1BQU07NEZBQ25CLGdCQUFnQjtrQkFENUIsVUFBVTttQkFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QsIEluamVjdGFibGUsIEluamVjdEZsYWdzLCBJbmplY3RvciwgUExBVEZPUk1fSUQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgbWFrZVN0YXRlS2V5LCBUcmFuc2ZlclN0YXRlIH0gZnJvbSBcIkBhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXJcIjtcbmltcG9ydCB7IGNvbGxlY3Rpb24sIGRvYywgRG9jdW1lbnREYXRhLCBEb2N1bWVudFNuYXBzaG90LCBxdWVyeSwgcXVlcnlFcXVhbCwgUXVlcnlTbmFwc2hvdCwgcnVuVHJhbnNhY3Rpb24sIHdyaXRlQmF0Y2ggfSBmcm9tICdmaXJlYmFzZS9maXJlc3RvcmUnO1xuaW1wb3J0IHR5cGUgeyBUcmFuc2FjdGlvbiwgQ29sbGVjdGlvblJlZmVyZW5jZSwgRG9jdW1lbnRSZWZlcmVuY2UsIFF1ZXJ5LCBRdWVyeUNvbnN0cmFpbnQgfSBmcm9tICdmaXJlYmFzZS9maXJlc3RvcmUnO1xuaW1wb3J0IHsgRklSRVNUT1JFIH0gZnJvbSBcIi4vdG9rZW5zXCI7XG5pbXBvcnQgeyBzaGFyZVdpdGhEZWxheSwgYXNzZXJ0Q29sbGVjdGlvbiwgYXNzZXJ0UGF0aCwgaXNDb2xsZWN0aW9uUmVmLCBpc0RvY1BhdGgsIGlzUXVlcnkgfSBmcm9tIFwibmdmaXJlL2NvcmVcIjtcbmltcG9ydCB7IGZyb21SZWYgfSBmcm9tIFwiLi9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyLCBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vblwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBzdHJpbmdpZnlRdWVyeSB9IGZyb20gXCIuL3F1ZXJ5XCI7XG5cbnR5cGUgUmVmZXJlbmNlPEU+ID0gQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IERvY3VtZW50UmVmZXJlbmNlPEU+O1xudHlwZSBTbmFwc2hvdDxFID0gRG9jdW1lbnREYXRhPiA9IERvY3VtZW50U25hcHNob3Q8RT4gfCBRdWVyeVNuYXBzaG90PEU+O1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEZpcmVzdG9yZVNlcnZpY2Uge1xuICBwcml2YXRlIG1lbW9yeVJlZjogUmVjb3JkPHN0cmluZywgT2JzZXJ2YWJsZTxTbmFwc2hvdD4+ID0ge307XG4gIHByaXZhdGUgaW5qZWN0b3IgPSBpbmplY3QoSW5qZWN0b3IpO1xuICBwcml2YXRlIHBsYXRlZm9ybUlkID0gaW5qZWN0KFBMQVRGT1JNX0lEKTtcbiAgLyoqIFRyYW5zZmVyIHN0YXRlIGJldHdlZW4gc2VydmVyIGFuZCAgKi9cbiAgcHJpdmF0ZSB0cmFuc2ZlclN0YXRlID0gaW5qZWN0KFRyYW5zZmVyU3RhdGUsIEluamVjdEZsYWdzLk9wdGlvbmFsKTtcbiAgLyoqIENhY2hlIGJhc2VkIHN0YXRlIGZvciBkb2N1bWVudCAqL1xuICBwcml2YXRlIHN0YXRlOiBNYXA8c3RyaW5nIHwgUXVlcnksIFNuYXBzaG90PHVua25vd24+PiA9IG5ldyBNYXAoKTtcblxuICBnZXQgZGIoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0KEZJUkVTVE9SRSk7XG4gIH1cblxuICAvKiogQGludGVybmFsIFNob3VsZCBvbmx5IGJlIHVzZWQgYnkgRmlyZUNvbGxlY3Rpb24gc2VydmljZXMgKi9cbiAgc2V0U3RhdGU8RT4oXG4gICAgcmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPixcbiAgICBzbmFwOiBTbmFwc2hvdDxFPlxuICApIHtcbiAgICBpZiAoaXNDb2xsZWN0aW9uUmVmKHJlZikpIHtcbiAgICAgIChzbmFwIGFzIFF1ZXJ5U25hcHNob3Q8RT4pLmZvckVhY2goZG9jID0+IHRoaXMuc3RhdGUuc2V0KGRvYy5yZWYucGF0aCwgZG9jKSk7XG4gICAgICB0aGlzLnN0YXRlLnNldChyZWYucGF0aCwgc25hcCk7XG4gICAgfSBlbHNlIGlmIChpc1F1ZXJ5KHJlZikpIHtcbiAgICAgIChzbmFwIGFzIFF1ZXJ5U25hcHNob3Q8RT4pLmZvckVhY2goZG9jID0+IHRoaXMuc3RhdGUuc2V0KGRvYy5yZWYucGF0aCwgZG9jKSk7XG4gICAgICBjb25zdCBrZXkgPSBzdHJpbmdpZnlRdWVyeShyZWYgYXMgYW55KTtcbiAgICAgIHRoaXMuc3RhdGUuc2V0KGtleSwgc25hcCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RhdGUuc2V0KHJlZi5wYXRoLCBzbmFwKTtcbiAgICB9XG4gIH1cblxuICBnZXRTdGF0ZTxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+LCBkZWxheT86IG51bWJlcik6IERvY3VtZW50U25hcHNob3Q8RT5cbiAgZ2V0U3RhdGU8RT4ocmVmOiBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+LCBkZWxheT86IG51bWJlcik6IFF1ZXJ5U25hcHNob3Q8RT5cbiAgZ2V0U3RhdGU8RT4ocmVmOiBRdWVyeTxFPiwgZGVsYXk/OiBudW1iZXIpOiBRdWVyeVNuYXBzaG90PEU+XG4gIGdldFN0YXRlPEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4pOiBTbmFwc2hvdDxFPiB8IHVuZGVmaW5lZFxuICBnZXRTdGF0ZTxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+KTogU25hcHNob3Q8RT4gfCB1bmRlZmluZWQge1xuICAgIGlmIChpc1F1ZXJ5KHJlZikpIHtcbiAgICAgIGNvbnN0IGtleSA9IHN0cmluZ2lmeVF1ZXJ5KHJlZiBhcyBhbnkpO1xuICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0KGtleSkgYXMgU25hcHNob3Q8RT47XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnN0YXRlLmdldChyZWYucGF0aCkgYXMgU25hcHNob3Q8RT47XG4gICAgfVxuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCBTaG91bGQgb25seSBiZSB1c2VkIGJ5IEZpcmVDb2xsZWN0aW9uIHNlcnZpY2VzICovXG4gIGZyb21NZW1vcnk8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiwgZGVsYXk/OiBudW1iZXIpOiBPYnNlcnZhYmxlPERvY3VtZW50U25hcHNob3Q8RT4+XG4gIGZyb21NZW1vcnk8RT4ocmVmOiBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+LCBkZWxheT86IG51bWJlcik6IE9ic2VydmFibGU8UXVlcnlTbmFwc2hvdDxFPj5cbiAgZnJvbU1lbW9yeTxFPihyZWY6IFF1ZXJ5PEU+LCBkZWxheT86IG51bWJlcik6IE9ic2VydmFibGU8UXVlcnlTbmFwc2hvdDxFPj5cbiAgZnJvbU1lbW9yeTxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+LCBkZWxheT86IG51bWJlcik6IE9ic2VydmFibGU8U25hcHNob3Q8RT4+XG4gIGZyb21NZW1vcnk8RT4oXG4gICAgcmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPixcbiAgICBkZWxheT86IG51bWJlclxuICApOiBPYnNlcnZhYmxlPFNuYXBzaG90PEU+PiB7XG4gICAgY29uc3Qga2V5ID0gaXNRdWVyeShyZWYpID8gc3RyaW5naWZ5UXVlcnkocmVmIGFzIGFueSkgOiByZWYucGF0aDtcbiAgICBpZiAoIXRoaXMubWVtb3J5UmVmW2tleV0pIHtcbiAgICAgIHRoaXMubWVtb3J5UmVmW2tleV0gPSBmcm9tUmVmKHJlZiBhcyBhbnkpLnBpcGUoc2hhcmVXaXRoRGVsYXkoZGVsYXkpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubWVtb3J5UmVmW2tleV0gYXMgT2JzZXJ2YWJsZTxTbmFwc2hvdDxFPj47XG4gIH1cblxuICAvKipcbiAgICogQGludGVybmFsIFNob3VsZCBvbmx5IGJlIHVzZWQgYnkgRmlyZUNvbGxlY3Rpb24gc2VydmljZXNcbiAgICogR2V0IHRoZSB0cmFuc2ZlciBzdGF0ZSBmb3IgYSBzcGVjaWZpYyByZWYgYW5kIHB1dCBpdCBpbiB0aGUgbWVtb3J5IHN0YXRlXG4gICAqIFJlbW92ZSB0aGUgcmVmZXJlbmNlIHRvIHRyYW5zZmVyIHN0YXRlIGFmdGVyIGZpcnN0IGNhbGxcbiAgICovXG4gIGdldFRyYW5zZmVyPEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4pOiBFIHwgdW5kZWZpbmVkXG4gIGdldFRyYW5zZmVyPEU+KHJlZjogQ29sbGVjdGlvblJlZmVyZW5jZTxFPiB8IFF1ZXJ5PEU+KTogRVtdIHwgdW5kZWZpbmVkXG4gIGdldFRyYW5zZmVyPEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4pOiBFW10gfCBFIHwgdW5kZWZpbmVkXG4gIGdldFRyYW5zZmVyPEU+KHJlZjogRG9jdW1lbnRSZWZlcmVuY2U8RT4gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4pIHtcbiAgICBpZiAoIXRoaXMudHJhbnNmZXJTdGF0ZSB8fCAhaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0ZWZvcm1JZCkpIHJldHVybjtcbiAgICBjb25zdCBrZXkgPSBpc1F1ZXJ5KHJlZikgPyBzdHJpbmdpZnlRdWVyeShyZWYgYXMgYW55KSA6IHJlZi5wYXRoO1xuICAgIGNvbnN0IHN0YXRlS2V5ID0gbWFrZVN0YXRlS2V5PEU+KGtleSk7XG4gICAgaWYgKCF0aGlzLnRyYW5zZmVyU3RhdGUuaGFzS2V5KHN0YXRlS2V5KSkgcmV0dXJuO1xuICAgIGNvbnN0IHZhbHVlID0gdGhpcy50cmFuc2ZlclN0YXRlLmdldChzdGF0ZUtleSwgdW5kZWZpbmVkKTtcbiAgICB0aGlzLnRyYW5zZmVyU3RhdGUucmVtb3ZlKHN0YXRlS2V5KTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvKiogQGludGVybmFsIFNob3VsZCBvbmx5IGJlIHVzZWQgYnkgRmlyZUNvbGxlY3Rpb24gc2VydmljZXMgKi9cbiAgc2V0VHJhbnNmZXI8RT4ocmVmOiBEb2N1bWVudFJlZmVyZW5jZTxFPiwgdmFsdWU/OiBFKTogdm9pZFxuICBzZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+W10gfCBDb2xsZWN0aW9uUmVmZXJlbmNlPEU+IHwgUXVlcnk8RT4sIHZhbHVlPzogRVtdKTogdm9pZFxuICBzZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgRG9jdW1lbnRSZWZlcmVuY2U8RT5bXSB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPiwgdmFsdWU/OiBFIHwgRVtdKTogdm9pZFxuICBzZXRUcmFuc2ZlcjxFPihyZWY6IERvY3VtZW50UmVmZXJlbmNlPEU+IHwgRG9jdW1lbnRSZWZlcmVuY2U8RT5bXSB8IENvbGxlY3Rpb25SZWZlcmVuY2U8RT4gfCBRdWVyeTxFPiwgdmFsdWU/OiBFIHwgRVtdKSB7XG4gICAgaWYgKCF2YWx1ZSkgcmV0dXJuO1xuICAgIGlmICghdGhpcy50cmFuc2ZlclN0YXRlIHx8ICFpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGVmb3JtSWQpKSByZXR1cm47XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVmKSAmJiBBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmVmLmZvckVhY2goKHJlZmVyZW5jZSwgaSkgPT4gdGhpcy5zZXRUcmFuc2ZlcihyZWZlcmVuY2UsIHZhbHVlW2ldKSk7XG4gICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShyZWYpKSB7XG4gICAgICBjb25zdCBrZXkgPSBpc1F1ZXJ5KHJlZikgPyBzdHJpbmdpZnlRdWVyeShyZWYgYXMgYW55KSA6IHJlZi5wYXRoO1xuICAgICAgdGhpcy50cmFuc2ZlclN0YXRlLnNldChtYWtlU3RhdGVLZXk8YW55PihrZXkpLCB2YWx1ZSk7XG4gICAgfVxuICB9XG5cblxuICBjbGVhckNhY2hlKHBhdGhzOiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5KSB7XG4gICAgaWYgKCFwYXRocykgcmV0dXJuO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGhzKSkge1xuICAgICAgZm9yIChjb25zdCBwYXRoIG9mIHBhdGhzKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1lbW9yeVJlZltwYXRoXTtcbiAgICAgICAgdGhpcy5zdGF0ZS5kZWxldGUocGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcGF0aHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBkZWxldGUgdGhpcy5tZW1vcnlSZWZbcGF0aHNdO1xuICAgICAgdGhpcy5zdGF0ZS5kZWxldGUocGF0aHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBrZXkgPSBzdHJpbmdpZnlRdWVyeShwYXRocyk7XG4gICAgICBkZWxldGUgdGhpcy5tZW1vcnlSZWZba2V5XTtcbiAgICAgIHRoaXMuc3RhdGUuZGVsZXRlKGtleSk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEdldCB0aGUgcmVmZXJlbmNlIG9mIHRoZSBkb2N1bWVudCwgY29sbGVjdGlvbiBvciBxdWVyeSAqL1xuICBwdWJsaWMgZ2V0UmVmPEU+KHBhdGg6IHN0cmluZyk6IFJlZmVyZW5jZTxFPjtcbiAgcHVibGljIGdldFJlZjxFPihwYXRoczogc3RyaW5nW10pOiBEb2N1bWVudFJlZmVyZW5jZTxFPltdO1xuICBwdWJsaWMgZ2V0UmVmPEU+KHBhdGg6IHN0cmluZywgY29uc3RyYWludHM6IFF1ZXJ5Q29uc3RyYWludFtdKTogUXVlcnk8RT47XG4gIC8vIG92ZXJsb2FkIHVzZWQgaW50ZXJuYWxseSB3aGVuIGxvb3Bpbmcgb3ZlciBwYXRocyBhcnJheVxuICBwdWJsaWMgZ2V0UmVmPEU+KFxuICAgIHBhdGhzOiBzdHJpbmcgfCBzdHJpbmdbXSxcbiAgICBjb25zdHJhaW50cz86IFF1ZXJ5Q29uc3RyYWludFtdLFxuICApOiB1bmRlZmluZWQgfCBRdWVyeTxFPiB8IFF1ZXJ5PEU+W10gfCBSZWZlcmVuY2U8RT4gfCBEb2N1bWVudFJlZmVyZW5jZTxFPltdIHtcbiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGggfHwgIXBhdGhzKSByZXR1cm4gdW5kZWZpbmVkO1xuXG4gICAgLy8gQXJyYXkgb2YgZG9jc1xuICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGhzKSkge1xuICAgICAgcmV0dXJuIHBhdGhzLm1hcCgocGF0aCkgPT4gdGhpcy5nZXRSZWY8RT4ocGF0aCkgYXMgRG9jdW1lbnRSZWZlcmVuY2U8RT4pO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc0NvbnRyYWludHMgPSBBcnJheS5pc0FycmF5KGNvbnN0cmFpbnRzKTtcbiAgICBpZiAoaGFzQ29udHJhaW50cykge1xuICAgICAgYXNzZXJ0UGF0aChwYXRocyk7XG4gICAgICBhc3NlcnRDb2xsZWN0aW9uKHBhdGhzKTtcbiAgICAgIGNvbnN0IHJlZiA9IGNvbGxlY3Rpb24odGhpcy5kYiwgcGF0aHMpIGFzIENvbGxlY3Rpb25SZWZlcmVuY2U8RT47XG4gICAgICByZXR1cm4gcXVlcnkocmVmLCAuLi5jb25zdHJhaW50cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFzc2VydFBhdGgocGF0aHMpO1xuICAgICAgaWYgKGlzRG9jUGF0aChwYXRocykpIHJldHVybiBkb2ModGhpcy5kYiwgcGF0aHMpIGFzIERvY3VtZW50UmVmZXJlbmNlPEU+O1xuICAgICAgcmV0dXJuIGNvbGxlY3Rpb24odGhpcy5kYiwgcGF0aHMpIGFzIENvbGxlY3Rpb25SZWZlcmVuY2U8RT47XG4gICAgfVxuICB9XG5cbiAgYmF0Y2goKSB7XG4gICAgcmV0dXJuIHdyaXRlQmF0Y2godGhpcy5kYik7XG4gIH1cblxuICBydW5UcmFuc2FjdGlvbjxUPihjYjogKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbikgPT4gUHJvbWlzZTxUPikge1xuICAgIHJldHVybiBydW5UcmFuc2FjdGlvbjxUPih0aGlzLmRiLCAodHgpID0+IGNiKHR4KSk7XG4gIH1cblxuICBjcmVhdGVJZCgpIHtcbiAgICByZXR1cm4gZG9jKGNvbGxlY3Rpb24odGhpcy5kYiwgJ19fJykpLmlkO1xuICB9XG5cbn0iXX0=
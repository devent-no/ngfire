import { exist } from 'ngfire/core';
// Simplfied version of 
// https://github.com/firebase/firebase-js-sdk/blob/master/packages/firestore/src/core/query.ts#L442
export function stringifyQuery(query) {
    if ('_query' in query) {
        const target = query['_query'];
        return `${stringifyTarget(target)}|lt:${target.limitType})`;
    }
    return '';
}
function stringifyTarget(target) {
    if (!target.orderBy)
        target.orderBy = [];
    let str = target.path.canonicalString();
    if (target.collectionGroup !== null) {
        str += '|cg:' + target.collectionGroup;
    }
    if (target.filters.length > 0) {
        const fields = target.filters
            .map((f) => stringifyFilter(f))
            .join(', ');
        str += `|f:[${fields}]`;
    }
    if (exist(target.limit)) {
        str += '|l:' + target.limit;
    }
    if (target.orderBy.length > 0) {
        const order = target.orderBy
            .map((o) => stringifyOrderBy(o))
            .join(', ');
        str += `|ob:[${order}]`;
    }
    if (target.startAt) {
        str += '|lb:';
        str += target.startAt.inclusive ? 'b:' : 'a:';
        str += target.startAt.position.map((p) => canonifyValue(p)).join(',');
    }
    if (target.endAt) {
        str += '|ub:';
        str += target.endAt.inclusive ? 'a:' : 'b:';
        str += target.endAt.position.map((p) => canonifyValue(p)).join(',');
    }
    return str;
}
/** Returns a debug description for `filter`. */
export function stringifyFilter(filter) {
    return `${filter.field.canonicalString()} ${filter.op} ${canonifyValue(filter.value)}`;
}
export function stringifyOrderBy(orderBy) {
    return `${orderBy.field.canonicalString()} (${orderBy.dir})`;
}
/* eslint-disable */
function canonifyValue(value) {
    if ('nullValue' in value) {
        return 'null';
    }
    else if ('booleanValue' in value) {
        return '' + value.booleanValue;
    }
    else if ('integerValue' in value) {
        return '' + value.integerValue;
    }
    else if ('doubleValue' in value) {
        return '' + value.doubleValue;
    }
    else if ('timestampValue' in value) {
        return canonifyTimestamp(value.timestampValue);
    }
    else if ('stringValue' in value) {
        return value.stringValue;
    }
    else if ('bytesValue' in value) {
        return canonifyByteString(value.bytesValue);
    }
    else if ('referenceValue' in value) {
        return value.referenceValue;
    }
    else if ('geoPointValue' in value) {
        return canonifyGeoPoint(value.geoPointValue);
    }
    else if ('arrayValue' in value) {
        return canonifyArray(value.arrayValue);
    }
    else if ('mapValue' in value) {
        return canonifyMap(value.mapValue);
    }
    else {
        throw new Error('Invalid value type: ' + JSON.stringify(value));
    }
}
/* eslint-enable */
function canonifyByteString(byteString) {
    if (typeof byteString === 'string')
        return byteString;
    return byteString.toString();
}
function canonifyTimestamp(timestamp) {
    return `time(${timestamp.toString()})`;
}
function canonifyGeoPoint(geoPoint) {
    return `geo(${geoPoint.latitude},${geoPoint.longitude})`;
}
function canonifyMap(mapValue) {
    // Iteration order in JavaScript is not guaranteed. To ensure that we generate
    // matching canonical IDs for identical maps, we need to sort the keys.
    const sortedKeys = Object.keys(mapValue.fields || {}).sort();
    // eslint-disable-next-line
    const content = sortedKeys.map(key => `${key}:${canonifyValue(mapValue.fields[key])}`).join(',');
    return `{${content}}`;
}
function canonifyArray(arrayValue) {
    const values = arrayValue.values || [];
    return `[${values.map(canonifyValue).join(',')}]`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25nZmlyZS9maXJlc3RvcmUvc3JjL3F1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVVBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHcEMsd0JBQXdCO0FBQ3hCLG9HQUFvRztBQUNwRyxNQUFNLFVBQVUsY0FBYyxDQUFDLEtBQVk7SUFDekMsSUFBSSxRQUFRLElBQUksS0FBSyxFQUFFO1FBQ3JCLE1BQU0sTUFBTSxHQUFJLEtBQWEsQ0FBQyxRQUFRLENBQW1DLENBQUM7UUFDMUUsT0FBTyxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsT0FBTyxNQUFNLENBQUMsU0FBUyxHQUFHLENBQUM7S0FDN0Q7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxNQUFjO0lBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTztRQUFHLE1BQWMsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ2xELElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDeEMsSUFBSSxNQUFNLENBQUMsZUFBZSxLQUFLLElBQUksRUFBRTtRQUNuQyxHQUFHLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUM7S0FDeEM7SUFDRCxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUM3QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTzthQUM1QixHQUFHLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxDQUFnQixDQUFDLENBQUM7YUFDbEQsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ1osR0FBRyxJQUFJLE9BQU8sTUFBTSxHQUFHLENBQUM7S0FDekI7SUFDRCxJQUFJLEtBQUssQ0FBQyxNQUFN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R0FBRyxHQUFHLElBQUksYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xHLE9BQU8sSUFBSSxPQUFPLEdBQUcsQ0FBQztBQUN4QixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsVUFBc0I7SUFDM0MsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7SUFDdkMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7QUFDcEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIE5vdGU6IFRoZXNlIHR5cGVzIGFyZSBpbnRlcm5hbCB0byBGaXJlYmFzZSBhbmQgbWF5IGNoYW5nZS4gQ29uc2lkZXIgYWx0ZXJuYXRpdmUgYXBwcm9hY2hlcy5cbnR5cGUgVGFyZ2V0ID0gYW55O1xudHlwZSBPcmRlckJ5ID0gYW55O1xudHlwZSBGaWVsZEZpbHRlciA9IGFueTtcbnR5cGUgVmFsdWUgPSBhbnk7XG50eXBlIEFycmF5VmFsdWUgPSBhbnk7XG50eXBlIE1hcFZhbHVlID0gYW55O1xudHlwZSBUaW1lc3RhbXAgPSBhbnk7XG50eXBlIExhdExuZyA9IGFueTtcbmltcG9ydCB0eXBlIHsgUXVlcnkgfSBmcm9tICdmaXJlYmFzZS9maXJlc3RvcmUnO1xuaW1wb3J0IHsgZXhpc3QgfSBmcm9tICduZ2ZpcmUvY29yZSc7XG5cblxuLy8gU2ltcGxmaWVkIHZlcnNpb24gb2YgXG4vLyBodHRwczovL2dpdGh1Yi5jb20vZmlyZWJhc2UvZmlyZWJhc2UtanMtc2RrL2Jsb2IvbWFzdGVyL3BhY2thZ2VzL2ZpcmVzdG9yZS9zcmMvY29yZS9xdWVyeS50cyNMNDQyXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5UXVlcnkocXVlcnk6IFF1ZXJ5KSB7XG4gIGlmICgnX3F1ZXJ5JyBpbiBxdWVyeSkge1xuICAgIGNvbnN0IHRhcmdldCA9IChxdWVyeSBhcyBhbnkpWydfcXVlcnknXSBhcyBUYXJnZXQgJiB7IGxpbWl0VHlwZTogc3RyaW5nIH07XG4gICAgcmV0dXJuIGAke3N0cmluZ2lmeVRhcmdldCh0YXJnZXQpfXxsdDoke3RhcmdldC5saW1pdFR5cGV9KWA7XG4gIH1cbiAgcmV0dXJuICcnO1xufVxuXG5mdW5jdGlvbiBzdHJpbmdpZnlUYXJnZXQodGFyZ2V0OiBUYXJnZXQpOiBzdHJpbmcge1xuICBpZiAoIXRhcmdldC5vcmRlckJ5KSAodGFyZ2V0IGFzIGFueSkub3JkZXJCeSA9IFtdO1xuICBsZXQgc3RyID0gdGFyZ2V0LnBhdGguY2Fub25pY2FsU3RyaW5nKCk7XG4gIGlmICh0YXJnZXQuY29sbGVjdGlvbkdyb3VwICE9PSBudWxsKSB7XG4gICAgc3RyICs9ICd8Y2c6JyArIHRhcmdldC5jb2xsZWN0aW9uR3JvdXA7XG4gIH1cbiAgaWYgKHRhcmdldC5maWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBmaWVsZHMgPSB0YXJnZXQuZmlsdGVyc1xuICAgIC5tYXAoKGY6IGFueSkgPT4gc3RyaW5naWZ5RmlsdGVyKGYgYXMgRmllbGRGaWx0ZXIpKVxuICAgIC5qb2luKCcsICcpO1xuICAgIHN0ciArPSBgfGY6WyR7ZmllbGRzfV1gO1xuICB9XG4gIGlmIChleGlzdCh0YXJnZXQubGltaXQpKSB7XG4gICAgc3RyICs9ICd8bDonICsgdGFyZ2V0LmxpbWl0O1xuICB9XG4gIGlmICh0YXJnZXQub3JkZXJCeS5sZW5ndGggPiAwKSB7XG4gICAgY29uc3Qgb3JkZXIgPSB0YXJnZXQub3JkZXJCeVxuICAgIC5tYXAoKG86IGFueSkgPT4gc3RyaW5naWZ5T3JkZXJCeShvKSlcbiAgICAuam9pbignLCAnKTtcbiAgICBzdHIgKz0gYHxvYjpbJHtvcmRlcn1dYDtcbiAgfVxuICBpZiAodGFyZ2V0LnN0YXJ0QXQpIHtcbiAgICBzdHIgKz0gJ3xsYjonO1xuICAgIHN0ciArPSB0YXJnZXQuc3RhcnRBdC5pbmNsdXNpdmUgPyAnYjonIDogJ2E6JztcbiAgICBzdHIgKz0gdGFyZ2V0LnN0YXJ0QXQucG9zaXRpb24ubWFwKChwOiBhbnkpID0+IGNhbm9uaWZ5VmFsdWUocCkpLmpvaW4oJywnKTtcbiAgfVxuICBpZiAodGFyZ2V0LmVuZEF0KSB7XG4gICAgc3RyICs9ICd8dWI6JztcbiAgICBzdHIgKz0gdGFyZ2V0LmVuZEF0LmluY2x1c2l2ZSA/ICdhOicgOiAnYjonO1xuICAgIHN0ciArPSB0YXJnZXQuZW5kQXQucG9zaXRpb24ubWFwKChwOiBhbnkpID0+IGNhbm9uaWZ5VmFsdWUocCkpLmpvaW4oJywnKTtcbiAgfVxuICByZXR1cm4gc3RyO1xufVxuXG4vKiogUmV0dXJucyBhIGRlYnVnIGRlc2NyaXB0aW9uIGZvciBgZmlsdGVyYC4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnlGaWx0ZXIoZmlsdGVyOiBGaWVsZEZpbHRlcik6IHN0cmluZyB7XG4gIHJldHVybiBgJHtmaWx0ZXIuZmllbGQuY2Fub25pY2FsU3RyaW5nKCl9ICR7ZmlsdGVyLm9wfSAke2Nhbm9uaWZ5VmFsdWUoZmlsdGVyLnZhbHVlKX1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5T3JkZXJCeShvcmRlckJ5OiBPcmRlckJ5KTogc3RyaW5nIHtcbiAgcmV0dXJuIGAke29yZGVyQnkuZmllbGQuY2Fub25pY2FsU3RyaW5nKCl9ICgke29yZGVyQnkuZGlyfSlgO1xufVxuXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xuZnVuY3Rpb24gY2Fub25pZnlWYWx1ZSh2YWx1ZTogVmFsdWUpOiBzdHJpbmcge1xuICBpZiAoJ251bGxWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gJ251bGwnO1xuICB9IGVsc2UgaWYgKCdib29sZWFuVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuICcnICsgdmFsdWUuYm9vbGVhblZhbHVlO1xuICB9IGVsc2UgaWYgKCdpbnRlZ2VyVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuICcnICsgdmFsdWUuaW50ZWdlclZhbHVlO1xuICB9IGVsc2UgaWYgKCdkb3VibGVWYWx1ZScgaW4gdmFsdWUpIHtcbiAgICByZXR1cm4gJycgKyB2YWx1ZS5kb3VibGVWYWx1ZTtcbiAgfSBlbHNlIGlmICgndGltZXN0YW1wVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNhbm9uaWZ5VGltZXN0YW1wKHZhbHVlLnRpbWVzdGFtcFZhbHVlISk7XG4gIH0gZWxzZSBpZiAoJ3N0cmluZ1ZhbHVlJyBpbiB2YWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZS5zdHJpbmdWYWx1ZSE7XG4gIH0gZWxzZSBpZiAoJ2J5dGVzVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNhbm9uaWZ5Qnl0ZVN0cmluZyh2YWx1ZS5ieXRlc1ZhbHVlISk7XG4gIH0gZWxzZSBpZiAoJ3JlZmVyZW5jZVZhbHVlJyBpbiB2YWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZS5yZWZlcmVuY2VWYWx1ZSE7XG4gIH0gZWxzZSBpZiAoJ2dlb1BvaW50VmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNhbm9uaWZ5R2VvUG9pbnQodmFsdWUuZ2VvUG9pbnRWYWx1ZSEpO1xuICB9IGVsc2UgaWYgKCdhcnJheVZhbHVlJyBpbiB2YWx1ZSkge1xuICAgIHJldHVybiBjYW5vbmlmeUFycmF5KHZhbHVlLmFycmF5VmFsdWUhKTtcbiAgfSBlbHNlIGlmICgnbWFwVmFsdWUnIGluIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNhbm9uaWZ5TWFwKHZhbHVlLm1hcFZhbHVlISk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHZhbHVlIHR5cGU6ICcgKyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xuICB9XG59XG4vKiBlc2xpbnQtZW5hYmxlICovXG5cblxuZnVuY3Rpb24gY2Fub25pZnlCeXRlU3RyaW5nKGJ5dGVTdHJpbmc6IHN0cmluZyB8IFVpbnQ4QXJyYXkpOiBzdHJpbmcge1xuICBpZiAodHlwZW9mIGJ5dGVTdHJpbmcgPT09ICdzdHJpbmcnKSByZXR1cm4gYnl0ZVN0cmluZztcbiAgcmV0dXJuIGJ5dGVTdHJpbmcudG9TdHJpbmcoKTtcbn1cblxuXG5cbmZ1bmN0aW9uIGNhbm9uaWZ5VGltZXN0YW1wKHRpbWVzdGFtcDogVGltZXN0YW1wKTogc3RyaW5nIHtcbiAgcmV0dXJuIGB0aW1lKCR7dGltZXN0YW1wLnRvU3RyaW5nKCl9KWA7XG59XG5cbmZ1bmN0aW9uIGNhbm9uaWZ5R2VvUG9pbnQoZ2VvUG9pbnQ6IExhdExuZyk6IHN0cmluZyB7XG4gIHJldHVybiBgZ2VvKCR7Z2VvUG9pbnQubGF0aXR1ZGV9LCR7Z2VvUG9pbnQubG9uZ2l0dWRlfSlgO1xufVxuXG5mdW5jdGlvbiBjYW5vbmlmeU1hcChtYXBWYWx1ZTogTWFwVmFsdWUpOiBzdHJpbmcge1xuICAvLyBJdGVyYXRpb24gb3JkZXIgaW4gSmF2YVNjcmlwdCBpcyBub3QgZ3VhcmFudGVlZC4gVG8gZW5zdXJlIHRoYXQgd2UgZ2VuZXJhdGVcbiAgLy8gbWF0Y2hpbmcgY2Fub25pY2FsIElEcyBmb3IgaWRlbnRpY2FsIG1hcHMsIHdlIG5lZWQgdG8gc29ydCB0aGUga2V5cy5cbiAgY29uc3Qgc29ydGVkS2V5cyA9IE9iamVjdC5rZXlzKG1hcFZhbHVlLmZpZWxkcyB8fCB7fSkuc29ydCgpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbiAgY29uc3QgY29udGVudCA9IHNvcnRlZEtleXMubWFwKGtleSA9PiBgJHtrZXl9OiR7Y2Fub25pZnlWYWx1ZShtYXBWYWx1ZS5maWVsZHMhW2tleV0pfWApLmpvaW4oJywnKTtcbiAgcmV0dXJuIGB7JHtjb250ZW50fX1gO1xufVxuXG5mdW5jdGlvbiBjYW5vbmlmeUFycmF5KGFycmF5VmFsdWU6IEFycmF5VmFsdWUpOiBzdHJpbmcge1xuICBjb25zdCB2YWx1ZXMgPSBhcnJheVZhbHVlLnZhbHVlcyB8fCBbXTtcbiAgcmV0dXJuIGBbJHt2YWx1ZXMubWFwKGNhbm9uaWZ5VmFsdWUpLmpvaW4oJywnKX1dYDtcbn1cbiJdfQ==
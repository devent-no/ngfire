import { isPlatformServer } from "@angular/common";
import { collectionGroup, query } from "firebase/firestore";
import { keepUnstableUntilFirst, isIdList } from 'ngfire/core';
import { FireCollection } from "./collection";
import { toDate } from "./utils";
import { firstValueFrom, from, of } from "rxjs";
export class FireSubCollection extends FireCollection {
    constructor() {
        super(...arguments);
        this.pathKey = 'path';
    }
    get groupId() {
        return this.path.split('/').pop();
    }
    /** Function triggered when getting data from firestore */
    fromFirestore(snapshot) {
        if (snapshot.exists()) {
            return {
                ...toDate(snapshot.data()),
                [this.idKey]: snapshot.id,
                [this.pathKey]: snapshot.ref.path
            };
        }
        else {
            return undefined;
        }
    }
    getGroupRef(constraints) {
        const group = collectionGroup(this.db, this.groupId);
        if (!arguments.length)
            return group;
        if (!constraints)
            return;
        return query(group, ...constraints);
    }
    /** Observable the content of group reference(s)  */
    fromGroupRef(ref) {
        if (isPlatformServer(this.platformId)) {
            return this.zone.runOutsideAngular(() => from(this.getFromRef(ref))).pipe(keepUnstableUntilFirst(this.zone));
        }
        return this.useCache(ref);
    }
    async getValue(idOrQuery, params) {
        // If array is empty
        if (Array.isArray(idOrQuery) && !idOrQuery.length)
            return [];
        // Group query
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        // Collection Query
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return;
        return this.getFromRef(ref);
    }
    async reload(idOrQuery, params) {
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return;
        if (this.memorize) {
            Array.isArray(ref)
                ? ref.forEach(r => this.clearCache(r))
                : this.clearCache(ref);
        }
        return this.load(...arguments);
    }
    load() {
        return firstValueFrom(this.valueChanges(...arguments));
    }
    valueChanges(idOrQuery, params) {
        // If array is empty
        if (Array.isArray(idOrQuery) && !idOrQuery.length)
            return of([]);
        // Check if group query
        const isEmpty = arguments.length === 0;
        const isGroupQuery = arguments.length === 1 && Array.isArray(idOrQuery) && !isIdList(idOrQuery);
        // Group or Collection Query
        const ref = (isEmpty || isGroupQuery)
            ? this.getGroupRef(...arguments)
            : this.getRef(...arguments);
        if (!ref)
            return of(undefined);
        return this.fromRef(ref);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLWNvbGxlY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25nZmlyZS9maXJlc3RvcmUvc3JjL3N1Yi1jb2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFNUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFFBQVEsRUFBVSxNQUFNLGFBQWEsQ0FBQztBQUN2RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDakMsT0FBTyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzVELE1BQU0sT0FBZ0IsaUJBQTBDLFNBQVEsY0FBaUI7SUFBekY7O1FBRVksWUFBTyxHQUFHLE1BQU0sQ0FBQztJQStIN0IsQ0FBQztJQTdIQyxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBWSxDQUFDO0lBQzlDLENBQUM7SUFFRCwwREFBMEQ7SUFDaEQsYUFBYSxDQUFDLFFBQXdEO1FBQzlFLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ3JCLE9BQU87Z0JBQ0wsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUMxQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxRQUFRLENBQUMsRUFBRTtnQkFDekIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJO2FBQ2xDLENBQUM7U0FDSDthQUFNO1lBQ0wsT0FBTyxTQUFTLENB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QUM7SUFDakMsQ0FBQztJQVlNLElBQUk7UUFDVCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBV00sWUFBWSxDQUNqQixTQUEwRCxFQUMxRCxNQUFlO1FBRWYsb0JBQW9CO1FBQ3BCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNO1lBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFakUsdUJBQXVCO1FBQ3ZCLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sWUFBWSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFaEcsNEJBQTRCO1FBQzVCLE1BQU0sR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLFlBQVksQ0FBQztZQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBSSxHQUFHLFNBQVMsQ0FBQztZQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBSSxHQUFHLFNBQVMsQ0FBQyxDQUFDO1FBRWpDLElBQUksQ0FBQyxHQUFHO1lBQUUsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uXCI7XG5pbXBvcnQgeyBjb2xsZWN0aW9uR3JvdXAsIHF1ZXJ5IH0gZnJvbSBcImZpcmViYXNlL2ZpcmVzdG9yZVwiO1xuaW1wb3J0IHR5cGUgeyBRdWVyeURvY3VtZW50U25hcHNob3QsIERvY3VtZW50U25hcHNob3QsIFF1ZXJ5LCBRdWVyeUNvbnN0cmFpbnQsIERvY3VtZW50RGF0YSB9IGZyb20gJ2ZpcmViYXNlL2ZpcmVzdG9yZSc7XG5pbXBvcnQgeyBrZWVwVW5zdGFibGVVbnRpbEZpcnN0LCBpc0lkTGlzdCwgUGFyYW1zIH0gZnJvbSAnbmdmaXJlL2NvcmUnO1xuaW1wb3J0IHsgRmlyZUNvbGxlY3Rpb24gfSBmcm9tIFwiLi9jb2xsZWN0aW9uXCI7XG5pbXBvcnQgeyB0b0RhdGUgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgZmlyc3RWYWx1ZUZyb20sIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRmlyZVN1YkNvbGxlY3Rpb248RSBleHRlbmRzIERvY3VtZW50RGF0YT4gZXh0ZW5kcyBGaXJlQ29sbGVjdGlvbjxFPiB7XG4gIGFic3RyYWN0IHBhdGg6IHN0cmluZztcbiAgcHJvdGVjdGVkIHBhdGhLZXkgPSAncGF0aCc7XG4gIFxuICBnZXQgZ3JvdXBJZCgpIHtcbiAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCcvJykucG9wKCkgYXMgc3RyaW5nO1xuICB9XG5cbiAgLyoqIEZ1bmN0aW9uIHRyaWdnZXJlZCB3aGVuIGdldHRpbmcgZGF0YSBmcm9tIGZpcmVzdG9yZSAqL1xuICBwcm90ZWN0ZWQgZnJvbUZpcmVzdG9yZShzbmFwc2hvdDogRG9jdW1lbnRTbmFwc2hvdDxFPiB8IFF1ZXJ5RG9jdW1lbnRTbmFwc2hvdDxFPik6IEUgfCB1bmRlZmluZWQge1xuICAgIGlmIChzbmFwc2hvdC5leGlzdHMoKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udG9EYXRlKHNuYXBzaG90LmRhdGEoKSksXG4gICAgICAgIFt0aGlzLmlkS2V5XTogc25hcHNob3QuaWQsXG4gICAgICAgIFt0aGlzLnBhdGhLZXldOiBzbmFwc2hvdC5yZWYucGF0aFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0R3JvdXBSZWY8VCBleHRlbmRzIEUgPSBFPihjb25zdHJhaW50cz86IFF1ZXJ5Q29uc3RyYWludFtdKTogUXVlcnk8VD4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGdyb3VwID0gY29sbGVjdGlvbkdyb3VwKHRoaXMuZGIsIHRoaXMuZ3JvdXBJZCkgYXMgUXVlcnk8VD47XG4gICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZ3JvdXA7XG4gICAgaWYgKCFjb25zdHJhaW50cykgcmV0dXJuO1xuICAgIHJldHVybiBxdWVyeShncm91cCwgLi4uY29uc3RyYWludHMpO1xuICB9XG5cbiAgLyoqIE9ic2VydmFibGUgdGhlIGNvbnRlbnQgb2YgZ3JvdXAgcmVmZXJlbmNlKHMpICAqL1xuICBwcm90ZWN0ZWQgZnJvbUdyb3VwUmVmPFQgZXh0ZW5kcyBFID0gRT4ocmVmOiBRdWVyeTxUPik6IE9ic2VydmFibGU8VFtdPiB7XG4gICAgaWYgKGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgcmV0dXJuIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBmcm9tKHRoaXMuZ2V0RnJvbVJlZihyZWYpKSkucGlwZShcbiAgICAgICAga2VlcFVuc3RhYmxlVW50aWxGaXJzdCh0aGlzLnpvbmUpLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudXNlQ2FjaGUocmVmKTtcbiAgfVxuXG5cbiAgLyoqIFJldHVybiB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgcGF0aCBmcm9tIEZpcmVzdG9yZSAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihpZHM/OiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4ocXVlcnk/OiBRdWVyeUNvbnN0cmFpbnRbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWU8VCBleHRlbmRzIEUgPSBFPihpZD86IHN0cmluZyB8IG51bGwsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD47XG4gIHB1YmxpYyBhc3luYyBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IG51bGwgfCBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLFxuICAgIHBhcmFtcz86IFBhcmFtc1xuICApOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+IHtcbiAgICAvLyBJZiBhcnJheSBpcyBlbXB0eVxuICAgIGlmIChBcnJheS5pc0FycmF5KGlkT3JRdWVyeSkgJiYgIWlkT3JRdWVyeS5sZW5ndGgpIHJldHVybiBbXTtcblxuICAgIC8vIEdyb3VwIHF1ZXJ5XG4gICAgY29uc3QgaXNFbXB0eSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDA7XG4gICAgY29uc3QgaXNHcm91cFF1ZXJ5ID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiBBcnJheS5pc0FycmF5KGlkT3JRdWVyeSkgJiYgIWlzSWRMaXN0KGlkT3JRdWVyeSk7XG5cbiAgICAvLyBDb2xsZWN0aW9uIFF1ZXJ5XG4gICAgY29uc3QgcmVmID0gKGlzRW1wdHkgfHwgaXNHcm91cFF1ZXJ5KVxuICAgICAgPyB0aGlzLmdldEdyb3VwUmVmPFQ+KC4uLmFyZ3VtZW50cylcbiAgICAgIDogdGhpcy5nZXRSZWY8VD4oLi4uYXJndW1lbnRzKTtcbiAgICBpZiAoIXJlZikgcmV0dXJuO1xuICAgIHJldHVybiB0aGlzLmdldEZyb21SZWYocmVmKTtcbiAgfVxuXG4gIC8qKiBDbGVhciBjYWNoZSBhbmQgZ2V0IHRoZSBsYXRlc3QgdmFsdWUgaW50byB0aGUgY2FjaGUgKi9cbiAgcHVibGljIGFzeW5jIHJlbG9hZDxUIGV4dGVuZHMgRSA9IEU+KGlkcz86IHN0cmluZ1tdLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFRbXT47XG4gIHB1YmxpYyBhc3luYyByZWxvYWQ8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIHJlbG9hZDxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5PzogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGFzeW5jIHJlbG9hZDxUIGV4dGVuZHMgRSA9IEU+KGlkPzogc3RyaW5nIHwgbnVsbCwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGFzeW5jIHJlbG9hZDxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IG51bGwgfCBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLFxuICAgIHBhcmFtcz86IFBhcmFtc1xuICApOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBpc0VtcHR5ID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMDtcbiAgICBjb25zdCBpc0dyb3VwUXVlcnkgPSBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIEFycmF5LmlzQXJyYXkoaWRPclF1ZXJ5KSAmJiAhaXNJZExpc3QoaWRPclF1ZXJ5KTtcbiAgICBjb25zdCByZWYgPSAoaXNFbXB0eSB8fCBpc0dyb3VwUXVlcnkpXG4gICAgICA/IHRoaXMuZ2V0R3JvdXBSZWYoLi4uYXJndW1lbnRzKVxuICAgICAgOiB0aGlzLmdldFJlZiguLi5hcmd1bWVudHMpO1xuICAgIGlmICghcmVmKSByZXR1cm47XG4gICAgaWYgKHRoaXMubWVtb3JpemUpIHtcbiAgICAgIEFycmF5LmlzQXJyYXkocmVmKVxuICAgICAgICA/IHJlZi5mb3JFYWNoKHIgPT4gdGhpcy5jbGVhckNhY2hlKHIpKVxuICAgICAgICA6IHRoaXMuY2xlYXJDYWNoZShyZWYpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5sb2FkKC4uLmFyZ3VtZW50cyk7XG4gIH1cbiAgXG5cbiAgLyoqIEdldCB0aGUgbGFzdCBjb250ZW50IGZyb20gdGhlIGFwcCAoaWYgdmFsdWUgaGFzIGJlZW4gY2FjaGVkLCBpdCB3b24ndCBkbyBhIHNlcnZlciByZXF1ZXN0KSAgKi9cbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihpZHM/OiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgbG9hZDxUIGV4dGVuZHMgRSA9IEU+KHBhcmFtczogUGFyYW1zKTogUHJvbWlzZTxUW10+O1xuICBwdWJsaWMgbG9hZDxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5PzogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPjtcbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihpZD86IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIGxvYWQ8VCBleHRlbmRzIEUgPSBFPihcbiAgICBpZE9yUXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLFxuICAgIHBhcmFtcz86IFBhcmFtc1xuICApOiBQcm9taXNlPFQgfCBUW10gfCB1bmRlZmluZWQ+O1xuICBwdWJsaWMgbG9hZDxUIGV4dGVuZHMgRSA9IEU+KCk6IFByb21pc2U8VCB8IFRbXSB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiBmaXJzdFZhbHVlRnJvbSh0aGlzLnZhbHVlQ2hhbmdlcyguLi5hcmd1bWVudHMpKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm4gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIHBhdGggZnJvbSBGaXJlc3RvcmUgKi9cbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KGlkcz86IHN0cmluZ1tdLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFRbXT47XG4gIHB1YmxpYyB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IE9ic2VydmFibGU8VFtdPjtcbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KHF1ZXJ5PzogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8VFtdPjtcbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KGlkPzogc3RyaW5nLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPFQgfCB1bmRlZmluZWQ+O1xuICBwdWJsaWMgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oXG4gICAgaWRPclF1ZXJ5Pzogc3RyaW5nIHwgc3RyaW5nW10gfCBRdWVyeUNvbnN0cmFpbnRbXSB8IFBhcmFtcyxcbiAgICBwYXJhbXM/OiBQYXJhbXNcbiAgKTogT2JzZXJ2YWJsZTxUIHwgVFtdIHwgdW5kZWZpbmVkPjtcbiAgcHVibGljIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KFxuICAgIGlkT3JRdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsXG4gICAgcGFyYW1zPzogUGFyYW1zXG4gICk6IE9ic2VydmFibGU8VCB8IFRbXSB8IHVuZGVmaW5lZD4ge1xuICAgIC8vIElmIGFycmF5IGlzIGVtcHR5XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaWRPclF1ZXJ5KSAmJiAhaWRPclF1ZXJ5Lmxlbmd0aCkgcmV0dXJuIG9mKFtdKTtcbiAgICBcbiAgICAvLyBDaGVjayBpZiBncm91cCBxdWVyeVxuICAgIGNvbnN0IGlzRW1wdHkgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwO1xuICAgIGNvbnN0IGlzR3JvdXBRdWVyeSA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShpZE9yUXVlcnkpICYmICFpc0lkTGlzdChpZE9yUXVlcnkpO1xuXG4gICAgLy8gR3JvdXAgb3IgQ29sbGVjdGlvbiBRdWVyeVxuICAgIGNvbnN0IHJlZiA9IChpc0VtcHR5IHx8IGlzR3JvdXBRdWVyeSlcbiAgICAgID8gdGhpcy5nZXRHcm91cFJlZjxUPiguLi5hcmd1bWVudHMpXG4gICAgICA6IHRoaXMuZ2V0UmVmPFQ+KC4uLmFyZ3VtZW50cyk7XG5cbiAgICBpZiAoIXJlZikgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVJlZihyZWYpO1xuICB9XG5cbn0iXX0=
import { combineLatest, Observable, of, from, ReplaySubject, timer, } from 'rxjs';
import { debounceTime, map, startWith, switchMap, tap, share } from 'rxjs/operators';
export function shareWithDelay(delay = 100) {
    return share({
        connector: () => new ReplaySubject(1),
        resetOnRefCountZero: () => delay ? timer(delay) : of(true),
        resetOnError: true,
        resetOnComplete: false,
    });
}
/**
 * Operator that join the source with sub queries.
 * There are two stategies :
 * 1. `shouldAwait: true`: Await all subqueries to emit once before emitting a next value
 * 2. `shouldAwait: false`: Emit the source and hydrate it with the subqueries along the way
 * @example
 * ```typescript
 * of({ docUrl: '...' }).valueChanges().pipe(
 *   joinWith({
 *     doc: source => fetch(docUrl).then(res => res.json()),
 *   }, { shouldAwait: true })
 * ).subscribe(res => console.log(res.subQuery))
 * ```
 * @param queries A map of subqueries to apply. Each query can return a static value, Promise or Observable
 * @param options Strategy to apply on the joinWith
 */
export function joinWith(queries, options = {}) {
    const shouldAwait = options.shouldAwait ?? true;
    const debounce = options.debounceTime ?? 100;
    const runQuery = (entity) => {
        const obs = [];
        for (const key in queries) {
            // Transform return value into an observable
            let result = queries[key](entity);
            if (!(result instanceof Observable)) {
                if (result instanceof Promise) {
                    result = from(result);
                }
                else {
                    result = of(result);
                }
            }
            // Hydrate the entity with the data
            let observe;
            if (shouldAwait) {
                observe = result.pipe(tap(result => entity[key] = result));
            }
            else {
                observe = result.pipe(startWith(undefined), tap(result => entity[key] = result));
            }
            obs.push(observe);
        }
        if (!obs.length)
            return of(entity);
        return combineLatest(obs).pipe(map(() => {
            if (!entity)
                return entity;
            return JSON.parse(JSON.stringify(entity), jsonDateReviver);
        }));
    };
    return switchMap((data) => {
        if (Array.isArray(data)) {
            if (!data.length)
                return of([]);
            return combineLatest(data.map(runQuery)).pipe(debounceTime(debounce));
        }
        return runQuery(data);
    });
}
function jsonDateReviver(_, value) {
    if (!value)
        return value;
    const dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,}|)Z$/;
    if (typeof value === 'string' && dateFormat.test(value))
        return new Date(value);
    if (typeof value === 'object' &&
        Object.keys(value).length === 2 &&
        ['nanoseconds', 'seconds'].every((k) => k in value))
        return new Date(((value.nanoseconds * 1) ^ -6) + value.seconds * 1000);
    return value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BlcmF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ2ZpcmUvY29yZS9zcmMvb3BlcmF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxhQUFhLEVBQ2IsVUFBVSxFQUVWLEVBQUUsRUFDRixJQUFJLEVBQ0osYUFBYSxFQUNiLEtBQUssR0FDTixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JGLE1BQU0sVUFBVSxjQUFjLENBQUksUUFBZ0IsR0FBRztJQUNuRCxPQUFPLEtBQUssQ0FBSTtRQUNkLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDckMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFDMUQsWUFBWSxFQUFFLElBQUk7UUFDbEIsZUFBZSxFQUFFLEtBQUs7S0FDdkIsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQXFCRDs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFDSCxNQUFNLFVBQVUsUUFBUSxDQUErQixPQUFjLEVBQUUsVUFBMkIsRUFBRTtJQUNsRyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztJQUNoRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsWUFBWSxJQUFJLEdBQUcsQ0FBQztJQUM3QyxNQUFNLFFBQVEsR0FBRyxDQUFDLE1BQWlCLEVBQUUsRUFBRTtRQUNyQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixLQUFLLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRTtZQUN6Qiw0Q0FB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Q29udGVudCI6WyJpbXBvcnQge1xuICBjb21iaW5lTGF0ZXN0LFxuICBPYnNlcnZhYmxlLFxuICBPcGVyYXRvckZ1bmN0aW9uLFxuICBvZixcbiAgZnJvbSxcbiAgUmVwbGF5U3ViamVjdCxcbiAgdGltZXIsXG59IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBtYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YXAsIHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBzaGFyZVdpdGhEZWxheTxUPihkZWxheTogbnVtYmVyID0gMTAwKSB7XG4gIHJldHVybiBzaGFyZTxUPih7XG4gICAgY29ubmVjdG9yOiAoKSA9PiBuZXcgUmVwbGF5U3ViamVjdCgxKSxcbiAgICByZXNldE9uUmVmQ291bnRaZXJvOiAoKSA9PiBkZWxheSA/IHRpbWVyKGRlbGF5KSA6IG9mKHRydWUpLFxuICAgIHJlc2V0T25FcnJvcjogdHJ1ZSxcbiAgICByZXNldE9uQ29tcGxldGU6IGZhbHNlLFxuICB9KVxufVxuXG5cbnR5cGUgUXVlcnlNYXA8VD4gPSBSZWNvcmQ8c3RyaW5nLCAoZGF0YTogRW50aXR5PFQ+KSA9PiBhbnk+XG50eXBlIEVudGl0eTxUPiA9IFQgZXh0ZW5kcyBBcnJheTxpbmZlciBJPiA/IEkgOiBUO1xudHlwZSBHZXRTbmFwc2hvdDxGIGV4dGVuZHMgKC4uLmRhdGE6IGFueSkgPT4gYW55PiA9IFxuICBGIGV4dGVuZHMgKC4uLmRhdGE6IGFueSkgPT4gT2JzZXJ2YWJsZTxpbmZlciBJPiA/IElcbiAgOiBGIGV4dGVuZHMgKC4uLmRhdGE6IGFueSkgPT4gUHJvbWlzZTxpbmZlciBKPiA/IEpcbiAgOiBSZXR1cm5UeXBlPEY+O1xudHlwZSBKb2luPFQsIFF1ZXJ5IGV4dGVuZHMgUXVlcnlNYXA8VD4+ID0gVCAmIHsgW2tleSBpbiBrZXlvZiBRdWVyeV0/OiBHZXRTbmFwc2hvdDxRdWVyeVtrZXldPiB9O1xudHlwZSBKb2ludHVyZTxULCBRdWVyeSBleHRlbmRzIFF1ZXJ5TWFwPGFueT4+ID0gVCBleHRlbmRzIEFycmF5PGluZmVyIEk+XG4gID8gSm9pbjxJLCBRdWVyeT5bXVxuICA6IEpvaW48VCwgUXVlcnk+O1xuXG5pbnRlcmZhY2UgSm9pbldpdGhPcHRpb25zIHtcbiAgLyoqIElmIHNldCB0byBmYWxzZSwgdGhlIHN1YnF1ZXJpZXMgd2lsbCBiZSBmaWxsZWQgd2l0aCB1bmRlZmluZWQgYW5kIGh5ZHJhdGVkIGFzIHRoZXkgY29tZSB0aHJvdWdoICovXG4gIHNob3VsZEF3YWl0PzogYm9vbGVhbjtcbiAgLyoqIFVzZWQgdG8gbm90IHRyaWdnZXIgY2hhbmdlIGRldGVjdGlvbiB0b28gb2Z0ZW4gKi9cbiAgZGVib3VuY2VUaW1lPzogbnVtYmVyO1xufVxuXG4vKipcbiAqIE9wZXJhdG9yIHRoYXQgam9pbiB0aGUgc291cmNlIHdpdGggc3ViIHF1ZXJpZXMuXG4gKiBUaGVyZSBhcmUgdHdvIHN0YXRlZ2llcyA6IFxuICogMS4gYHNob3VsZEF3YWl0OiB0cnVlYDogQXdhaXQgYWxsIHN1YnF1ZXJpZXMgdG8gZW1pdCBvbmNlIGJlZm9yZSBlbWl0dGluZyBhIG5leHQgdmFsdWVcbiAqIDIuIGBzaG91bGRBd2FpdDogZmFsc2VgOiBFbWl0IHRoZSBzb3VyY2UgYW5kIGh5ZHJhdGUgaXQgd2l0aCB0aGUgc3VicXVlcmllcyBhbG9uZyB0aGUgd2F5XG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogb2YoeyBkb2NVcmw6ICcuLi4nIH0pLnZhbHVlQ2hhbmdlcygpLnBpcGUoXG4gKiAgIGpvaW5XaXRoKHtcbiAqICAgICBkb2M6IHNvdXJjZSA9PiBmZXRjaChkb2NVcmwpLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpLFxuICogICB9LCB7IHNob3VsZEF3YWl0OiB0cnVlIH0pXG4gKiApLnN1YnNjcmliZShyZXMgPT4gY29uc29sZS5sb2cocmVzLnN1YlF1ZXJ5KSlcbiAqIGBgYFxuICogQHBhcmFtIHF1ZXJpZXMgQSBtYXAgb2Ygc3VicXVlcmllcyB0byBhcHBseS4gRWFjaCBxdWVyeSBjYW4gcmV0dXJuIGEgc3RhdGljIHZhbHVlLCBQcm9taXNlIG9yIE9ic2VydmFibGVcbiAqIEBwYXJhbSBvcHRpb25zIFN0cmF0ZWd5IHRvIGFwcGx5IG9uIHRoZSBqb2luV2l0aFxuICovXG5leHBvcnQgZnVuY3Rpb24gam9pbldpdGg8VCwgUXVlcnkgZXh0ZW5kcyBRdWVyeU1hcDxUPj4ocXVlcmllczogUXVlcnksIG9wdGlvbnM6IEpvaW5XaXRoT3B0aW9ucyA9IHt9KTogT3BlcmF0b3JGdW5jdGlvbjxULCBKb2ludHVyZTxULCBRdWVyeT4+IHtcbiAgY29uc3Qgc2hvdWxkQXdhaXQgPSBvcHRpb25zLnNob3VsZEF3YWl0ID8/IHRydWU7XG4gIGNvbnN0IGRlYm91bmNlID0gb3B0aW9ucy5kZWJvdW5jZVRpbWUgPz8gMTAwO1xuICBjb25zdCBydW5RdWVyeSA9IChlbnRpdHk6IEVudGl0eTxUPikgPT4ge1xuICAgIGNvbnN0IG9icyA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IGluIHF1ZXJpZXMpIHtcbiAgICAgIC8vIFRyYW5zZm9ybSByZXR1cm4gdmFsdWUgaW50byBhbiBvYnNlcnZhYmxlXG4gICAgICBsZXQgcmVzdWx0OiBhbnkgPSBxdWVyaWVzW2tleV0oZW50aXR5KTtcbiAgICAgIGlmICghKHJlc3VsdCBpbnN0YW5jZW9mIE9ic2VydmFibGUpKSB7XG4gICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgcmVzdWx0ID0gZnJvbShyZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdCA9IG9mKHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIEh5ZHJhdGUgdGhlIGVudGl0eSB3aXRoIHRoZSBkYXRhXG4gICAgICBsZXQgb2JzZXJ2ZTogT2JzZXJ2YWJsZTxhbnk+O1xuICAgICAgaWYgKHNob3VsZEF3YWl0KSB7XG4gICAgICAgIG9ic2VydmUgPSByZXN1bHQucGlwZShcbiAgICAgICAgICB0YXAocmVzdWx0ID0+IChlbnRpdHkgYXMgYW55KVtrZXldID0gcmVzdWx0KSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9ic2VydmUgPSByZXN1bHQucGlwZShcbiAgICAgICAgICBzdGFydFdpdGgodW5kZWZpbmVkKSxcbiAgICAgICAgICB0YXAocmVzdWx0ID0+IChlbnRpdHkgYXMgYW55KVtrZXldID0gcmVzdWx0KSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIG9icy5wdXNoKG9ic2VydmUpO1xuICAgIH1cbiAgICBpZiAoIW9icy5sZW5ndGgpIHJldHVybiBvZihlbnRpdHkpO1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KG9icykucGlwZShcbiAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgIGlmICghZW50aXR5KSByZXR1cm4gZW50aXR5O1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlbnRpdHkpLCBqc29uRGF0ZVJldml2ZXIpIGFzIGFueTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICByZXR1cm4gc3dpdGNoTWFwKChkYXRhOiBUKSA9PiB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgIGlmICghZGF0YS5sZW5ndGgpIHJldHVybiBvZihbXSk7XG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChkYXRhLm1hcChydW5RdWVyeSkpLnBpcGUoZGVib3VuY2VUaW1lKGRlYm91bmNlKSk7XG4gICAgfVxuICAgIHJldHVybiBydW5RdWVyeShkYXRhIGFzIEVudGl0eTxUPik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBqc29uRGF0ZVJldml2ZXIoXzogdW5rbm93biwgdmFsdWU6IGFueSkge1xuICBpZiAoIXZhbHVlKSByZXR1cm4gdmFsdWU7XG5cbiAgY29uc3QgZGF0ZUZvcm1hdCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn1UXFxkezJ9OlxcZHsyfTpcXGR7Mn0oXFwuXFxkezEsfXwpWiQvO1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiBkYXRlRm9ybWF0LnRlc3QodmFsdWUpKSByZXR1cm4gbmV3IERhdGUodmFsdWUpO1xuICBpZiAoXG4gICAgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJlxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDIgJiZcbiAgICBbJ25hbm9zZWNvbmRzJywgJ3NlY29uZHMnXS5ldmVyeSgoaykgPT4gayBpbiB2YWx1ZSlcbiAgKVxuICAgIHJldHVybiBuZXcgRGF0ZSgoKHZhbHVlLm5hbm9zZWNvbmRzICogMSkgXiAtNikgKyB2YWx1ZS5zZWNvbmRzICogMTAwMCk7XG5cbiAgcmV0dXJuIHZhbHVlO1xufVxuIl19
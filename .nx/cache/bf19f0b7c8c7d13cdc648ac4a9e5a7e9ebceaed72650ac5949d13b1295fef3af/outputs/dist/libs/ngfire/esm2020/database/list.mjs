import { inject } from "@angular/core";
import { set } from "firebase/database";
import { push, get, remove, update } from "firebase/database";
import { combineLatest, of } from "rxjs";
import { map } from "rxjs/operators";
import { exist, isIdList, pathWithParams } from "ngfire/core";
import { FireDatabase } from "./database";
import { serverTimestamp } from 'firebase/database';
import { fromDate, toDate } from "./utils";
function isListQuery(query) {
    if (typeof query === 'string')
        return false;
    if (Array.isArray(query) && isIdList(query))
        return false;
    return true;
}
function toKey(value) {
    if (typeof value === 'string')
        return value;
    if (typeof value === 'number')
        return value.toString();
    throw new Error('Key of list should either be a string or a number');
}
export function addMeta(doc, actionType) {
    const _meta = doc['_meta'] ?? {};
    if (actionType === 'add')
        _meta.createdAt = serverTimestamp();
    if (actionType === 'update')
        _meta.modifiedAt = serverTimestamp();
    doc._meta = _meta;
}
export class FireList {
    constructor() {
        this.fireDB = inject(FireDatabase);
    }
    fromDatabase(snap) {
        if (!snap.exists())
            return null;
        const value = snap.val();
        const dateKeys = [...this.dateKeys, '_meta.createdAt', '_meta.modifiedAt'];
        if (!value || typeof value !== 'object')
            return toDate(value, dateKeys);
        if (this.idKey)
            value[this.idKey] = snap.key;
        if (this.pathKey)
            value[this.pathKey] = snap.ref.toString();
        return toDate(value, dateKeys);
    }
    toDatabase(doc, actionType) {
        return fromDate(doc);
    }
    toData(snaps, options) {
        if (!snaps)
            return null;
        if (Array.isArray(snaps))
            return snaps.map(snap => this.toData(snap, { isList: false })).filter(exist);
        if (!options.isList)
            return this.fromDatabase(snaps);
        const docs = [];
        // forEach cancels when return value is "true". So I return "false"
        snaps.forEach(snap => !docs.push(this.fromDatabase(snap)));
        return docs.filter(exist);
    }
    getPath(key, params) {
        if (typeof key === 'string')
            return pathWithParams(`${this.path}/${key}`, params);
        return pathWithParams(this.path, key);
    }
    getRef(query, params) {
        // String or Params (getPath return base path is query is Params)
        if (!Array.isArray(query))
            return this.fireDB.getRef(this.getPath(query), params);
        return isIdList(query)
            // key list
            ? this.fireDB.getRef(query.map(key => this.getPath(key)), params)
            // query constraints
            : this.fireDB.getRef(this.getPath(), query, params);
    }
    fromQuery(query, params) {
        const refs = this.getRef(query, params);
        if (!Array.isArray(refs))
            return this.fireDB.fromQuery(refs);
        const obs = refs.map(ref => this.fireDB.fromQuery(ref));
        return combineLatest(obs);
    }
    getQuery(query, params) {
        const refs = this.getRef(query, params);
        if (!Array.isArray(refs))
            return get(refs);
        const promises = refs.map(ref => get(ref));
        return Promise.all(promises);
    }
    valueChanges(query, params) {
        if (arguments.length && !query)
            return of(null);
        return this.fromQuery(query, params).pipe(map(snap => this.toData(snap, { isList: isListQuery(query) })));
    }
    async getValue(query, params) {
        if (arguments.length && !query)
            return Promise.resolve(null);
        const snap = await this.getQuery(query, params);
        return this.toData(snap, { isList: isListQuery(query) });
    }
    add(value, params) {
        const doc = this.toDatabase(value, 'add');
        if (this.idKey && doc[this.idKey]) {
            const key = toKey(doc[this.idKey]);
            const ref = this.getRef(key, params);
            return set(ref, doc);
        }
        const listRef = params ? this.getRef(params) : this.getRef();
        return push(listRef, doc);
    }
    update(key, value, params) {
        const doc = this.toDatabase(value, 'update');
        const path = this.getRef(key, params);
        return update(path, doc);
    }
    remove(key, params) {
        const ref = this.getRef(key, params);
        return remove(ref);
    }
    /** We use a separated method to avoid mistakes */
    removeAll(params) {
        const ref = params ? this.getRef(params) : this.getRef();
        return remove(ref);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmdmaXJlL2RhdGFiYXNlL3NyYy9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUEyRCxHQUFHLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRyxPQUFPLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUQsT0FBTyxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBMkIsS0FBSyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFNM0MsU0FBUyxXQUFXLENBQUMsS0FBc0Q7SUFDekUsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFDNUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUMxRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFHRCxTQUFTLEtBQUssQ0FBQyxLQUFjO0lBQzNCLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQzVDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sS0FBSyxDQUFD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QUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN6RCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRGF0YWJhc2VSZWZlcmVuY2UsIERhdGFTbmFwc2hvdCwgUXVlcnksIFF1ZXJ5Q29uc3RyYWludCwgc2V0IH0gZnJvbSBcImZpcmViYXNlL2RhdGFiYXNlXCI7XG5pbXBvcnQgeyBwdXNoLCBnZXQsIHJlbW92ZSwgdXBkYXRlIH0gZnJvbSBcImZpcmViYXNlL2RhdGFiYXNlXCI7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBtYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IEV4dHJhY3REZWVwS2V5cywgUGFyYW1zLCBleGlzdCwgaXNJZExpc3QsIHBhdGhXaXRoUGFyYW1zIH0gZnJvbSBcIm5nZmlyZS9jb3JlXCI7XG5pbXBvcnQgeyBGaXJlRGF0YWJhc2UgfSBmcm9tIFwiLi9kYXRhYmFzZVwiO1xuaW1wb3J0IHsgc2VydmVyVGltZXN0YW1wIH0gZnJvbSAnZmlyZWJhc2UvZGF0YWJhc2UnO1xuaW1wb3J0IHsgZnJvbURhdGUsIHRvRGF0ZSB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmludGVyZmFjZSBUb0RhdGFPcHRpb25zIHtcbiAgaXNMaXN0OiBib29sZWFuO1xufVxuXG5mdW5jdGlvbiBpc0xpc3RRdWVyeShxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMpIHtcbiAgaWYgKHR5cGVvZiBxdWVyeSA9PT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTtcbiAgaWYgKEFycmF5LmlzQXJyYXkocXVlcnkpICYmIGlzSWRMaXN0KHF1ZXJ5KSkgcmV0dXJuIGZhbHNlO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuXG5mdW5jdGlvbiB0b0tleSh2YWx1ZTogdW5rbm93bikge1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuIHZhbHVlO1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7XG4gIHRocm93IG5ldyBFcnJvcignS2V5IG9mIGxpc3Qgc2hvdWxkIGVpdGhlciBiZSBhIHN0cmluZyBvciBhIG51bWJlcicpOyBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZE1ldGEoZG9jOiBEb2N1bWVudE1ldGEsIGFjdGlvblR5cGU6ICdhZGQnIHwgJ3VwZGF0ZScpIHtcbiAgY29uc3QgX21ldGE6IERvY3VtZW50TWV0YVsnX21ldGEnXSA9IGRvY1snX21ldGEnXSA/PyB7fTtcbiAgaWYgKGFjdGlvblR5cGUgPT09ICdhZGQnKSBfbWV0YS5jcmVhdGVkQXQgPSBzZXJ2ZXJUaW1lc3RhbXAoKSBhcyBEYXRlO1xuICBpZiAoYWN0aW9uVHlwZSA9PT0gJ3VwZGF0ZScpIF9tZXRhLm1vZGlmaWVkQXQgPSBzZXJ2ZXJUaW1lc3RhbXAoKSBhcyBEYXRlO1xuICBkb2MuX21ldGEgPSBfbWV0YTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEb2N1bWVudE1ldGEge1xuICBfbWV0YToge1xuICAgIGNyZWF0ZWRBdD86IERhdGU7XG4gICAgbW9kaWZpZWRBdD86IERhdGU7XG4gIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEZpcmVMaXN0PEU+IHtcbiAgcHJvdGVjdGVkIGZpcmVEQiA9IGluamVjdChGaXJlRGF0YWJhc2UpO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcmVhZG9ubHkgcGF0aDogc3RyaW5nO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZGF0ZUtleXM6IEV4dHJhY3REZWVwS2V5czxFLCBEYXRlPltdO1xuICBwcm90ZWN0ZWQgaWRLZXk/OiBrZXlvZiBFO1xuICBwcm90ZWN0ZWQgcGF0aEtleT86IGtleW9mIEU7XG5cbiAgcHJvdGVjdGVkIGZyb21EYXRhYmFzZShzbmFwOiBEYXRhU25hcHNob3QpOiBFIHwgbnVsbCB7XG4gICAgaWYgKCFzbmFwLmV4aXN0cygpKSByZXR1cm4gbnVsbDtcbiAgICBjb25zdCB2YWx1ZSA9IHNuYXAudmFsKCk7XG4gICAgXG4gICAgY29uc3QgZGF0ZUtleXMgPSBbLi4udGhpcy5kYXRlS2V5cywgJ19tZXRhLmNyZWF0ZWRBdCcsICdfbWV0YS5tb2RpZmllZEF0J107XG4gICAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSByZXR1cm4gdG9EYXRlKHZhbHVlLCBkYXRlS2V5cyk7XG4gICAgaWYgKHRoaXMuaWRLZXkpIHZhbHVlW3RoaXMuaWRLZXldID0gc25hcC5rZXk7XG4gICAgaWYgKHRoaXMucGF0aEtleSkgdmFsdWVbdGhpcy5wYXRoS2V5XSA9IHNuYXAucmVmLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIHRvRGF0ZSh2YWx1ZSwgZGF0ZUtleXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHRvRGF0YWJhc2UoZG9jOiBQYXJ0aWFsPEU+LCBhY3Rpb25UeXBlOiAnYWRkJyB8ICd1cGRhdGUnKSB7XG4gICAgcmV0dXJuIGZyb21EYXRlKGRvYyk7IFxuICB9XG5cbiAgcHJpdmF0ZSB0b0RhdGE8VCBleHRlbmRzIEUgPSBFPihzbmFwczogRGF0YVNuYXBzaG90IHwgbnVsbCwgb3B0aW9uczogVG9EYXRhT3B0aW9ucyk6IFQgfCBudWxsXG4gIHByaXZhdGUgdG9EYXRhPFQgZXh0ZW5kcyBFID0gRT4oc25hcHM6IERhdGFTbmFwc2hvdFtdLCBvcHRpb25zOiBUb0RhdGFPcHRpb25zKTogVFtdXG4gIHByaXZhdGUgdG9EYXRhPFQgZXh0ZW5kcyBFID0gRT4oc25hcHM6IERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbCwgb3B0aW9uczogVG9EYXRhT3B0aW9ucyk6IFQgfCBUW10gfCBudWxsXG4gIHByaXZhdGUgdG9EYXRhPFQgZXh0ZW5kcyBFID0gRT4oc25hcHM6IERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbCwgb3B0aW9uczogVG9EYXRhT3B0aW9ucyk6IFQgfCBUW10gfCBudWxsIHtcbiAgICBpZiAoIXNuYXBzKSByZXR1cm4gbnVsbDtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShzbmFwcykpIHJldHVybiBzbmFwcy5tYXAoc25hcCA9PiB0aGlzLnRvRGF0YTxUPihzbmFwLCB7IGlzTGlzdDogZmFsc2UgfSkpLmZpbHRlcihleGlzdCk7XG4gICAgaWYgKCFvcHRpb25zLmlzTGlzdCkgcmV0dXJuIHRoaXMuZnJvbURhdGFiYXNlKHNuYXBzKSBhcyBhbnk7XG4gICAgY29uc3QgZG9jczogKFQgfCBudWxsKVtdID0gW107XG4gICAgLy8gZm9yRWFjaCBjYW5jZWxzIHdoZW4gcmV0dXJuIHZhbHVlIGlzIFwidHJ1ZVwiLiBTbyBJIHJldHVybiBcImZhbHNlXCJcbiAgICBzbmFwcy5mb3JFYWNoKHNuYXAgPT4gIWRvY3MucHVzaCh0aGlzLmZyb21EYXRhYmFzZShzbmFwKSBhcyBhbnkpKTtcbiAgICByZXR1cm4gZG9jcy5maWx0ZXIoZXhpc3QpO1xuICB9XG5cbiAgZ2V0UGF0aChrZXk/OiBzdHJpbmcgfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcykge1xuICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykgcmV0dXJuIHBhdGhXaXRoUGFyYW1zKGAke3RoaXMucGF0aH0vJHtrZXl9YCwgcGFyYW1zKTtcbiAgICByZXR1cm4gcGF0aFdpdGhQYXJhbXModGhpcy5wYXRoLCBrZXkpO1xuICB9XG5cbiAgZ2V0UmVmKCk6IERhdGFiYXNlUmVmZXJlbmNlXG4gIGdldFJlZihwYXJhbXM6IFBhcmFtcyk6IERhdGFiYXNlUmVmZXJlbmNlXG4gIGdldFJlZihrZXk6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogRGF0YWJhc2VSZWZlcmVuY2VcbiAgZ2V0UmVmKGtleXM6IHN0cmluZ1tdLCBwYXJhbXM/OiBQYXJhbXMpOiBEYXRhYmFzZVJlZmVyZW5jZVtdXG4gIGdldFJlZihjb25zdHJhaW50czogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFF1ZXJ5XG4gIC8vIFVzZSBpbnRlcm5hbGx5XG4gIGdldFJlZihxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcyk6IERhdGFiYXNlUmVmZXJlbmNlIHwgRGF0YWJhc2VSZWZlcmVuY2VbXSB8IFF1ZXJ5XG4gIGdldFJlZihxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcykge1xuICAgIC8vIFN0cmluZyBvciBQYXJhbXMgKGdldFBhdGggcmV0dXJuIGJhc2UgcGF0aCBpcyBxdWVyeSBpcyBQYXJhbXMpXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5KSkgcmV0dXJuIHRoaXMuZmlyZURCLmdldFJlZih0aGlzLmdldFBhdGgocXVlcnkpLCBwYXJhbXMpO1xuICAgIFxuICAgIHJldHVybiBpc0lkTGlzdChxdWVyeSlcbiAgICAgIC8vIGtleSBsaXN0XG4gICAgICA/IHRoaXMuZmlyZURCLmdldFJlZihxdWVyeS5tYXAoa2V5ID0+IHRoaXMuZ2V0UGF0aChrZXkpKSwgcGFyYW1zKVxuICAgICAgLy8gcXVlcnkgY29uc3RyYWludHNcbiAgICAgIDogdGhpcy5maXJlREIuZ2V0UmVmKHRoaXMuZ2V0UGF0aCgpLCBxdWVyeSwgcGFyYW1zKTtcbiAgfVxuXG4gIHByaXZhdGUgZnJvbVF1ZXJ5KCk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90PlxuICBwcml2YXRlIGZyb21RdWVyeShwYXJhbXM6IFBhcmFtcyk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90PlxuICBwcml2YXRlIGZyb21RdWVyeShrZXk6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxEYXRhU25hcHNob3Q+IHwgT2JzZXJ2YWJsZTxudWxsPlxuICBwcml2YXRlIGZyb21RdWVyeShrZXlzOiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxEYXRhU25hcHNob3RbXT5cbiAgcHJpdmF0ZSBmcm9tUXVlcnkoY29uc3RyYWludHM6IFF1ZXJ5Q29uc3RyYWludFtdLCBwYXJhbXM/OiBQYXJhbXMpOiBPYnNlcnZhYmxlPERhdGFTbmFwc2hvdFtdPlxuICAvLyBVc2UgaW50ZXJuYWxseVxuICBwcml2YXRlIGZyb21RdWVyeShxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90IHwgRGF0YVNuYXBzaG90W10gfCBudWxsPlxuICBwcml2YXRlIGZyb21RdWVyeShxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8RGF0YVNuYXBzaG90IHwgRGF0YVNuYXBzaG90W10gfCBudWxsPiB7XG4gICAgY29uc3QgcmVmcyA9IHRoaXMuZ2V0UmVmKHF1ZXJ5LCBwYXJhbXMpO1xuICAgIGlmICghQXJyYXkuaXNBcnJheShyZWZzKSkgcmV0dXJuIHRoaXMuZmlyZURCLmZyb21RdWVyeShyZWZzKTtcbiAgICBjb25zdCBvYnMgPSByZWZzLm1hcChyZWYgPT4gdGhpcy5maXJlREIuZnJvbVF1ZXJ5KHJlZikpO1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KG9icyk7XG4gIH1cblxuICBwcml2YXRlIGdldFF1ZXJ5KCk6IFByb21pc2U8RGF0YVNuYXBzaG90PlxuICBwcml2YXRlIGdldFF1ZXJ5KHBhcmFtczogUGFyYW1zKTogUHJvbWlzZTxEYXRhU25hcHNob3Q+XG4gIHByaXZhdGUgZ2V0UXVlcnkoa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8RGF0YVNuYXBzaG90PiB8IFByb21pc2U8bnVsbD5cbiAgcHJpdmF0ZSBnZXRRdWVyeShrZXlzOiBzdHJpbmdbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxEYXRhU25hcHNob3RbXT5cbiAgcHJpdmF0ZSBnZXRRdWVyeShjb25zdHJhaW50czogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8RGF0YVNuYXBzaG90W10+XG4gIC8vIFVzZSBpbnRlcm5hbGx5XG4gIHByaXZhdGUgZ2V0UXVlcnkocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPERhdGFTbmFwc2hvdCB8IERhdGFTbmFwc2hvdFtdIHwgbnVsbD5cbiAgcHJpdmF0ZSBnZXRRdWVyeShxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8RGF0YVNuYXBzaG90IHwgRGF0YVNuYXBzaG90W10gfCBudWxsPiB7XG4gICAgY29uc3QgcmVmcyA9IHRoaXMuZ2V0UmVmKHF1ZXJ5LCBwYXJhbXMpO1xuICAgIGlmICghQXJyYXkuaXNBcnJheShyZWZzKSkgcmV0dXJuIGdldChyZWZzKTtcbiAgICBjb25zdCBwcm9taXNlcyA9IHJlZnMubWFwKHJlZiA9PiBnZXQocmVmKSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxuXG4gIHZhbHVlQ2hhbmdlczxUIGV4dGVuZHMgRSA9IEU+KCk6IE9ic2VydmFibGU8VFtdPlxuICB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihwYXJhbXM6IFBhcmFtcyk6IE9ic2VydmFibGU8VFtdPlxuICB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihrZXk6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogT2JzZXJ2YWJsZTxUIHwgbnVsbD5cbiAgdmFsdWVDaGFuZ2VzPFQgZXh0ZW5kcyBFID0gRT4oa2V5czogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8VFtdPlxuICB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihjb25zdHJhaW50czogUXVlcnlDb25zdHJhaW50W10sIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8VFtdPlxuICB2YWx1ZUNoYW5nZXM8VCBleHRlbmRzIEUgPSBFPihxdWVyeT86IHN0cmluZyB8IHN0cmluZ1tdIHwgUXVlcnlDb25zdHJhaW50W10gfCBQYXJhbXMsIHBhcmFtcz86IFBhcmFtcyk6IE9ic2VydmFibGU8VCB8IFRbXSB8IG51bGw+IHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCAmJiAhcXVlcnkpIHJldHVybiBvZihudWxsKTtcbiAgICByZXR1cm4gdGhpcy5mcm9tUXVlcnkocXVlcnksIHBhcmFtcykucGlwZShcbiAgICAgIG1hcChzbmFwID0+IHRoaXMudG9EYXRhKHNuYXAsIHsgaXNMaXN0OiBpc0xpc3RRdWVyeShxdWVyeSkgfSkpLFxuICAgICk7XG4gIH1cblxuICBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KCk6IFByb21pc2U8VFtdPlxuICBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KHBhcmFtczogUGFyYW1zKTogUHJvbWlzZTxUW10+XG4gIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VCB8IG51bGw+XG4gIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4oa2V5czogc3RyaW5nW10sIHBhcmFtcz86IFBhcmFtcyk6IFByb21pc2U8VFtdPlxuICBnZXRWYWx1ZTxUIGV4dGVuZHMgRSA9IEU+KGNvbnN0cmFpbnRzOiBRdWVyeUNvbnN0cmFpbnRbXSwgcGFyYW1zPzogUGFyYW1zKTogUHJvbWlzZTxUW10+XG4gIGFzeW5jIGdldFZhbHVlPFQgZXh0ZW5kcyBFID0gRT4ocXVlcnk/OiBzdHJpbmcgfCBzdHJpbmdbXSB8IFF1ZXJ5Q29uc3RyYWludFtdIHwgUGFyYW1zLCBwYXJhbXM/OiBQYXJhbXMpOiBQcm9taXNlPFQgfCBUW10gfCBudWxsPiB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggJiYgIXF1ZXJ5KSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgIGNvbnN0IHNuYXAgPSBhd2FpdCB0aGlzLmdldFF1ZXJ5KHF1ZXJ5LCBwYXJhbXMpXG4gICAgcmV0dXJuIHRoaXMudG9EYXRhPFQ+KHNuYXAsIHsgaXNMaXN0OiBpc0xpc3RRdWVyeShxdWVyeSkgfSk7XG4gIH1cblxuICBhZGQ8VCBleHRlbmRzIEU+KHZhbHVlOiBQYXJ0aWFsPFQ+LCBwYXJhbXM/OiBQYXJhbXMpIHtcbiAgICBjb25zdCBkb2MgPSB0aGlzLnRvRGF0YWJhc2UodmFsdWUsICdhZGQnKTtcbiAgICBpZiAodGhpcy5pZEtleSAmJiBkb2NbdGhpcy5pZEtleV0pIHtcbiAgICAgIGNvbnN0IGtleSA9IHRvS2V5KGRvY1t0aGlzLmlkS2V5XSk7XG4gICAgICBjb25zdCByZWYgPSB0aGlzLmdldFJlZihrZXksIHBhcmFtcyk7XG4gICAgICByZXR1cm4gc2V0KHJlZiwgZG9jKTtcbiAgICB9XG4gICAgY29uc3QgbGlzdFJlZiA9IHBhcmFtcyA/IHRoaXMuZ2V0UmVmKHBhcmFtcykgOiB0aGlzLmdldFJlZigpO1xuICAgIHJldHVybiBwdXNoKGxpc3RSZWYsIGRvYyk7XG4gIH1cblxuICB1cGRhdGU8VCBleHRlbmRzIEU+KGtleTogc3RyaW5nLCB2YWx1ZTogUGFydGlhbDxUPiwgcGFyYW1zPzogUGFyYW1zKSB7XG4gICAgY29uc3QgZG9jID0gdGhpcy50b0RhdGFiYXNlKHZhbHVlLCAndXBkYXRlJyk7XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0UmVmKGtleSwgcGFyYW1zKTtcbiAgICByZXR1cm4gdXBkYXRlKHBhdGgsIGRvYyk7XG4gIH1cblxuICByZW1vdmUoa2V5OiBzdHJpbmcsIHBhcmFtcz86IFBhcmFtcykge1xuICAgIGNvbnN0IHJlZiA9IHRoaXMuZ2V0UmVmKGtleSwgcGFyYW1zKTtcbiAgICByZXR1cm4gcmVtb3ZlKHJlZik7XG4gIH1cblxuICAvKiogV2UgdXNlIGEgc2VwYXJhdGVkIG1ldGhvZCB0byBhdm9pZCBtaXN0YWtlcyAqL1xuICByZW1vdmVBbGwocGFyYW1zPzogUGFyYW1zKSB7XG4gICAgY29uc3QgcmVmID0gcGFyYW1zID8gdGhpcy5nZXRSZWYocGFyYW1zKSA6IHRoaXMuZ2V0UmVmKCk7XG4gICAgcmV0dXJuIHJlbW92ZShyZWYpO1xuICB9XG59Il19